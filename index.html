<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ìš°ë¦¬ë“¤ / ChÃºng ta</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#e8836d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <style>
    :root {
      --primary: #e8836d;
      --primary-light: #ffd4cc;
      --primary-dark: #c9624d;
      --secondary: #ffc857;
      --secondary-light: #fff3d4;
      --accent: #7bc67e;
      --accent-light: #d4f5d5;
      --bg: #fef9f4;
      --card: #ffffff;
      --text: #4a3728;
      --text-secondary: #8b7355;
      --border: #f0e6dc;
      --danger: #e85d5d;
      --danger-light: #fde0e0;
      --shadow: 0 2px 12px rgba(74,55,40,0.08);
      --radius: 14px;
      --nav-height: 64px;
      --header-height: 56px;
    }
    [data-theme="dark"] {
      --primary: #e8836d;
      --primary-light: #3d2822;
      --primary-dark: #f09d8a;
      --secondary: #ffc857;
      --secondary-light: #2d2815;
      --accent: #7bc67e;
      --accent-light: #1a2d1b;
      --bg: #121218;
      --card: #1e1e2a;
      --text: #e8e0d8;
      --text-secondary: #a09888;
      --border: #2e2e3e;
      --danger: #ef5350;
      --danger-light: #2d1515;
      --shadow: 0 2px 12px rgba(0,0,0,0.3);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg); color: var(--text);
      min-height: 100vh; -webkit-tap-highlight-color: transparent; overflow-x: hidden;
      transition: background 0.3s, color 0.3s;
    }
    #app-header {
      position: fixed; top: 0; left: 0; right: 0;
      height: var(--header-height); background: var(--primary); color: white;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; font-weight: 700; z-index: 100;
      box-shadow: 0 2px 8px rgba(232,131,109,0.3);
    }
    #app-header .header-sub { font-size: 11px; font-weight: 400; opacity: 0.85; margin-top: 1px; }
    #header-title { text-align: center; }
    #app-content {
      margin-top: var(--header-height); margin-bottom: var(--nav-height);
      padding: 12px 16px 20px;
      min-height: calc(100vh - var(--header-height) - var(--nav-height));
    }
    .tab-content { display: none; animation: fadeIn 0.25s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
    #bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: var(--nav-height); background: var(--card);
      display: flex; border-top: 1px solid var(--border); z-index: 100;
      padding-bottom: env(safe-area-inset-bottom, 0);
      transition: background 0.3s;
    }
    .nav-item {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      font-size: 10px; color: var(--text-secondary); cursor: pointer;
      transition: all 0.2s; border: none; background: none;
    }
    .nav-item .nav-icon { font-size: 22px; margin-bottom: 2px; }
    .nav-item.active { color: var(--primary); }
    .nav-item.active .nav-icon { transform: scale(1.15); }
    .nav-item .nav-label { font-weight: 600; }
    .card {
      background: var(--card); border-radius: var(--radius);
      padding: 16px; margin-bottom: 12px;
      box-shadow: var(--shadow); border: 1px solid var(--border);
      transition: transform 0.15s, background 0.3s;
    }
    .card:active { transform: scale(0.985); }
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 10px 20px; border-radius: 10px; border: none;
      font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:active { background: var(--primary-dark); }
    .btn-secondary { background: var(--secondary-light); color: var(--text); }
    .btn-danger { background: var(--danger-light); color: var(--danger); }
    .btn-accent { background: var(--accent); color: white; }
    .btn-full { width: 100%; }
    .btn-sm { padding: 6px 12px; font-size: 12px; border-radius: 8px; }
    .btn:disabled { opacity: 0.5; pointer-events: none; }
    .input-group { margin-bottom: 14px; }
    .input-group label {
      display: block; font-size: 13px; font-weight: 600;
      margin-bottom: 6px; color: var(--text-secondary);
    }
    .input-group input, .input-group select, .input-group textarea {
      width: 100%; padding: 10px 14px;
      border: 1.5px solid var(--border); border-radius: 10px;
      font-size: 15px; background: var(--bg); color: var(--text);
      outline: none; transition: border-color 0.2s, background 0.3s;
    }
    .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
      border-color: var(--primary);
    }
    .input-group textarea { resize: vertical; min-height: 50px; }
    .progress-bar { width: 100%; height: 10px; background: var(--border); border-radius: 5px; overflow: hidden; }
    .progress-fill {
      height: 100%; background: linear-gradient(90deg, var(--accent), #4caf50);
      border-radius: 5px; transition: width 0.5s ease;
    }
    .search-bar { display: flex; gap: 8px; margin-bottom: 14px; }
    .search-bar input {
      flex: 1; padding: 10px 14px; border: 1.5px solid var(--border);
      border-radius: 10px; font-size: 15px; background: var(--card);
      color: var(--text); outline: none; transition: background 0.3s;
    }
    .search-bar input:focus { border-color: var(--primary); }
    .fab {
      width: 44px; height: 44px; border-radius: 12px;
      background: var(--primary); color: white; border: none;
      font-size: 24px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; box-shadow: 0 3px 10px rgba(232,131,109,0.3);
    }
    .word-card { position: relative; }
    .word-card-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .word-viet { font-size: 20px; font-weight: 700; color: var(--primary-dark); display: flex; align-items: center; gap: 8px; }
    .word-korean { font-size: 17px; font-weight: 600; margin-top: 4px; }
    .word-pron { font-size: 13px; color: var(--text-secondary); margin-top: 3px; }
    .word-example {
      font-size: 13px; color: var(--text-secondary);
      margin-top: 8px; padding: 8px 10px;
      background: var(--secondary-light); border-radius: 8px; line-height: 1.5;
    }
    .word-actions { display: flex; gap: 6px; margin-top: 10px; justify-content: flex-end; }
    .icon-btn {
      width: 34px; height: 34px; border-radius: 8px; border: none;
      background: var(--bg); font-size: 16px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.15s;
    }
    .icon-btn:active { background: var(--border); }
    .speak-btn { background: none; border: none; font-size: 20px; cursor: pointer; }
    .speak-btn:active { transform: scale(1.2); }
    .learn-check {
      display: flex; align-items: center; gap: 6px;
      font-size: 13px; color: var(--text-secondary); cursor: pointer;
    }
    .learn-check input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--accent); }
    .badges { display: flex; gap: 8px; margin: 10px 0; flex-wrap: wrap; }
    .badge {
      padding: 4px 10px; border-radius: 20px;
      font-size: 12px; font-weight: 600;
      display: flex; align-items: center; gap: 4px;
    }
    .badge.earned { background: var(--secondary-light); color: #b8860b; }
    .badge.locked { background: var(--border); color: #bbb; }
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4); z-index: 200;
      justify-content: center; align-items: flex-end; animation: fadeIn 0.2s;
    }
    .modal-overlay.show { display: flex; }
    .modal-content {
      background: var(--card); border-radius: 20px 20px 0 0;
      padding: 24px 20px; width: 100%; max-height: 85vh;
      overflow-y: auto; animation: slideUp 0.3s ease;
      transition: background 0.3s;
    }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; }
    .modal-header h3 { font-size: 18px; }
    .modal-close {
      width: 32px; height: 32px; border-radius: 50%; border: none;
      background: var(--bg); font-size: 18px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: var(--text);
    }
    .quiz-status { text-align: center; padding: 30px 10px; }
    .quiz-status .emoji { font-size: 60px; display: block; margin-bottom: 16px; }
    .quiz-question-card { text-align: center; padding: 20px; }
    .quiz-progress { font-size: 13px; color: var(--text-secondary); margin-bottom: 16px; }
    .quiz-word { font-size: 28px; font-weight: 700; color: var(--primary-dark); margin: 20px 0; }
    .quiz-prompt { font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; }
    .quiz-options { display: flex; flex-direction: column; gap: 10px; }
    .quiz-option {
      padding: 14px 16px; border-radius: 12px;
      border: 2px solid var(--border); background: var(--card);
      font-size: 16px; cursor: pointer; text-align: left;
      transition: all 0.2s; color: var(--text);
    }
    .quiz-option:active { transform: scale(0.98); }
    .quiz-option.correct { border-color: var(--accent); background: var(--accent-light); }
    .quiz-option.wrong { border-color: var(--danger); background: var(--danger-light); }
    .quiz-option.disabled { pointer-events: none; }
    .quiz-result { text-align: center; padding: 20px; }
    .quiz-score { font-size: 48px; font-weight: 800; color: var(--primary); margin: 10px 0; }
    .sub-tabs {
      display: flex; gap: 4px; margin-bottom: 16px;
      background: var(--border); border-radius: 12px; padding: 3px;
    }
    .sub-tab {
      flex: 1; padding: 8px 4px; border-radius: 10px; border: none;
      background: none; font-size: 12px; font-weight: 600;
      color: var(--text-secondary); cursor: pointer; transition: all 0.2s;
    }
    .sub-tab.active {
      background: var(--card); color: var(--primary);
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    .sub-content { display: none; animation: fadeIn 0.2s; }
    .sub-content.active { display: block; }
    .radio-group { display: flex; gap: 10px; }
    .radio-label {
      flex: 1; padding: 10px; border: 2px solid var(--border);
      border-radius: 10px; text-align: center;
      font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;
    }
    .radio-label.selected { border-color: var(--primary); background: var(--primary-light); }
    .radio-label input { display: none; }
    .category-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .cat-btn {
      padding: 10px 6px; border: 2px solid var(--border);
      border-radius: 10px; background: var(--card); font-size: 12px;
      cursor: pointer; text-align: center; transition: all 0.2s;
      color: var(--text);
    }
    .cat-btn.selected { border-color: var(--primary); background: var(--primary-light); }
    .cat-btn .cat-icon { font-size: 22px; display: block; margin-bottom: 2px; }
    .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .calendar-nav h3 { font-size: 16px; }
    .cal-nav-btn {
      width: 36px; height: 36px; border-radius: 50%; border: none;
      background: var(--bg); font-size: 18px; cursor: pointer; color: var(--text);
    }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
    .cal-header { text-align: center; font-size: 11px; font-weight: 700; color: var(--text-secondary); padding: 6px 0; }
    .cal-day {
      aspect-ratio: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      font-size: 13px; border-radius: 10px; cursor: pointer;
      transition: background 0.15s; padding: 2px;
    }
    .cal-day:active { background: var(--primary-light); }
    .cal-day.today { background: var(--primary-light); font-weight: 700; }
    .cal-day.other-month { opacity: 0.3; }
    .cal-day .cal-amount { font-size: 8px; color: var(--primary); font-weight: 600; margin-top: 1px; overflow: hidden; text-overflow: ellipsis; width: 100%; text-align: center; }
    .stat-card {
      display: flex; justify-content: space-between; align-items: center;
      padding: 14px 16px; background: var(--card); border-radius: 12px;
      margin-bottom: 8px; border: 1px solid var(--border); transition: background 0.3s;
    }
    .stat-label { font-size: 13px; color: var(--text-secondary); }
    .stat-value { font-size: 18px; font-weight: 700; }
    .stat-sub { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
    .stat-section-title { font-size: 14px; font-weight: 700; margin: 18px 0 8px; color: var(--text-secondary); }
    .stat-bar-group { margin-bottom: 8px; }
    .stat-bar-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 3px; }
    .stat-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
    .stat-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
    .compare-box { background: var(--secondary-light); border-radius: 12px; padding: 14px; margin-top: 12px; }
    .compare-row { display: flex; justify-content: space-between; font-size: 14px; padding: 4px 0; }
    .compare-diff { font-weight: 700; }
    .expense-date-group { margin-bottom: 16px; }
    .expense-date-label { font-size: 13px; font-weight: 700; color: var(--text-secondary); margin-bottom: 6px; padding-left: 4px; }
    .expense-item {
      display: flex; align-items: center; padding: 12px 14px;
      background: var(--card); border-radius: 12px; margin-bottom: 6px;
      border: 1px solid var(--border); transition: background 0.3s;
    }
    .expense-item-icon { font-size: 24px; margin-right: 12px; }
    .expense-item-info { flex: 1; }
    .expense-item-cat { font-size: 13px; font-weight: 600; }
    .expense-item-memo { font-size: 11px; color: var(--text-secondary); }
    .expense-item-amount { font-size: 16px; font-weight: 700; text-align: right; }
    .expense-item-sub { font-size: 10px; color: var(--text-secondary); text-align: right; }
    .expense-item-actions { display: flex; flex-direction: column; gap: 4px; margin-left: 8px; }
    .expense-item-actions .icon-btn { width: 28px; height: 28px; font-size: 13px; }
    .toast {
      position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
      padding: 10px 20px; border-radius: 10px; font-size: 14px;
      z-index: 300; color: white; white-space: nowrap;
      animation: toastIn 0.3s ease, toastOut 0.3s ease 1.7s forwards;
    }
    .toast-info { background: var(--text); }
    .toast-success { background: var(--accent); }
    .toast-error { background: var(--danger); }
    @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } }
    @keyframes toastOut { to { opacity: 0; transform: translateX(-50%) translateY(-10px); } }
    .empty-state { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
    .empty-state .emoji { font-size: 48px; display: block; margin-bottom: 12px; }
    .empty-state p { font-size: 14px; line-height: 1.6; }
    .skeleton {
      background: linear-gradient(90deg, var(--border) 25%, var(--bg) 50%, var(--border) 75%);
      background-size: 200% 100%; animation: skPulse 1.5s infinite;
      border-radius: 8px; min-height: 20px;
    }
    @keyframes skPulse { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .skeleton-card { padding: 16px; margin-bottom: 12px; border-radius: var(--radius); }
    .skeleton-line { height: 14px; margin-bottom: 10px; border-radius: 4px; }
    .skeleton-line.w60 { width: 60%; }
    .skeleton-line.w80 { width: 80%; }
    .skeleton-line.w40 { width: 40%; }
    .search-result-card { position: relative; }
    .search-result-card .add-btn {
      position: absolute; top: 12px; right: 12px;
      background: var(--secondary-light); border: none;
      width: 36px; height: 36px; border-radius: 50%;
      font-size: 20px; cursor: pointer; transition: transform 0.2s;
    }
    .search-result-card .add-btn:active { transform: scale(1.2); }
    .search-result-card .add-btn.added { background: var(--accent-light); }
    .diff-badge {
      display: inline-block; padding: 2px 8px; border-radius: 10px;
      font-size: 11px; font-weight: 600;
    }
    .diff-easy { background: #d4f5d5; color: #2e7d32; }
    .diff-normal { background: #fff3d4; color: #f57f17; }
    .diff-hard { background: #fde0e0; color: #c62828; }
    [data-theme="dark"] .diff-easy { background: #1a2d1b; color: #66bb6a; }
    [data-theme="dark"] .diff-normal { background: #2d2815; color: #ffa726; }
    [data-theme="dark"] .diff-hard { background: #2d1515; color: #ef5350; }
    .word-cat-filter {
      display: flex; gap: 6px; margin-bottom: 14px;
      overflow-x: auto; padding-bottom: 4px;
      -webkit-overflow-scrolling: touch;
    }
    .word-cat-filter::-webkit-scrollbar { display: none; }
    .filter-chip {
      padding: 6px 12px; border-radius: 20px;
      border: 1.5px solid var(--border); background: var(--card);
      font-size: 12px; font-weight: 600; cursor: pointer;
      white-space: nowrap; transition: all 0.2s; color: var(--text);
    }
    .filter-chip.active { border-color: var(--primary); background: var(--primary-light); color: var(--primary-dark); }
    .setting-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 14px 0; border-bottom: 1px solid var(--border);
    }
    .setting-item:last-child { border-bottom: none; }
    .setting-label { font-size: 14px; font-weight: 600; }
    .setting-desc { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
    .toggle-switch {
      width: 50px; height: 28px; border-radius: 14px;
      background: var(--border); border: none; cursor: pointer;
      position: relative; transition: background 0.3s;
    }
    .toggle-switch.on { background: var(--accent); }
    .toggle-switch::after {
      content: ''; position: absolute; top: 3px; left: 3px;
      width: 22px; height: 22px; border-radius: 50%;
      background: white; transition: transform 0.3s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .toggle-switch.on::after { transform: translateX(22px); }
    .budget-bar {
      height: 12px; background: var(--border); border-radius: 6px;
      overflow: hidden; margin: 8px 0;
    }
    .budget-fill {
      height: 100%; border-radius: 6px; transition: width 0.5s;
      background: linear-gradient(90deg, var(--accent), #4caf50);
    }
    .budget-fill.over { background: linear-gradient(90deg, var(--danger), #ff7043); }
    .budget-alert {
      background: var(--danger-light); color: var(--danger);
      padding: 8px 12px; border-radius: 8px;
      font-size: 13px; font-weight: 600; margin-bottom: 12px;
    }
    .currency-display {
      font-size: 12px; color: var(--text-secondary); margin-top: 2px;
    }
    .offline-banner {
      position: fixed; top: var(--header-height); left: 0; right: 0;
      background: var(--danger); color: white; text-align: center;
      padding: 6px; font-size: 12px; font-weight: 600; z-index: 99;
      display: none;
    }
    .offline-banner.show { display: block; }
    @media (min-width: 480px) {
      #app-content { max-width: 480px; margin-left: auto; margin-right: auto; }
      #bottom-nav { max-width: 480px; left: 50%; transform: translateX(-50%); }
      .modal-content { max-width: 480px; }
    }
  </style>
</head>
<body>

<header id="app-header">
  <div id="header-title">
    <div>ìš°ë¦¬ë“¤ / Chung ta</div>
    <div class="header-sub" id="header-sub">ë‹¨ì–´ì¥ / Tu vung</div>
  </div>
</header>

<div class="offline-banner" id="offline-banner">ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤ / Ngoai tuyen</div>

<main id="app-content">

  <!-- ====== ë‹¨ì–´ì¥ TAB ====== -->
  <section id="tab-dictionary" class="tab-content active">
    <div class="sub-tabs">
      <button class="sub-tab active" data-sub="dict-search" onclick="switchDictSub(this)">ğŸ” ê²€ìƒ‰</button>
      <button class="sub-tab" data-sub="dict-mywords" onclick="switchDictSub(this)">ğŸ“– ë‚´ ë‹¨ì–´ì¥</button>
    </div>

    <!-- Search Sub -->
    <div class="sub-content active" id="dict-search">
      <div class="search-bar">
        <input type="text" id="trans-search-input" placeholder="í•œêµ­ì–´ ë˜ëŠ” ë² íŠ¸ë‚¨ì–´ ì…ë ¥..." oninput="onTransSearch(this.value)">
      </div>
      <div id="trans-loading" style="display:none;">
        <div class="card skeleton-card"><div class="skeleton skeleton-line w80"></div><div class="skeleton skeleton-line w60"></div><div class="skeleton skeleton-line w40"></div></div>
        <div class="card skeleton-card"><div class="skeleton skeleton-line w60"></div><div class="skeleton skeleton-line w80"></div></div>
      </div>
      <div id="trans-results"></div>
      <div id="trans-empty" class="empty-state">
        <span class="emoji">ğŸ”</span>
        <p>í•œêµ­ì–´ ë˜ëŠ” ë² íŠ¸ë‚¨ì–´ë¥¼ ì…ë ¥í•˜ë©´<br>ìë™ìœ¼ë¡œ ë²ˆì—­ë©ë‹ˆë‹¤!<br><br>Nhap tieng Han hoac tieng Viet<br>de tu dong dich!</p>
      </div>
    </div>

    <!-- My Words Sub -->
    <div class="sub-content" id="dict-mywords">
      <div class="card" id="progress-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <span style="font-size:14px;font-weight:700;">ğŸ“Š í•™ìŠµ ì§„ë„ / Tien do</span>
          <span id="progress-text" style="font-size:13px;color:var(--accent);font-weight:700;">0%</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
        <div id="progress-detail" style="font-size:12px;color:var(--text-secondary);margin-top:6px;"></div>
        <div class="badges" id="badges-container"></div>
      </div>
      <div class="word-cat-filter" id="word-cat-filter"></div>
      <div class="search-bar">
        <input type="text" id="word-search-input" placeholder="ğŸ” ë‚´ ë‹¨ì–´ ê²€ìƒ‰..." oninput="renderMyWords()">
        <button class="fab" onclick="openWordModal()">+</button>
      </div>
      <div id="word-list"></div>
    </div>
  </section>

  <!-- ====== í€´ì¦ˆ TAB ====== -->
  <section id="tab-quiz" class="tab-content">
    <div class="sub-tabs">
      <button class="sub-tab active" data-sub="quiz-daily" onclick="switchQuizSub(this)">ğŸ¯ ì˜¤ëŠ˜ í€´ì¦ˆ</button>
      <button class="sub-tab" data-sub="quiz-practice" onclick="switchQuizSub(this)">ğŸ“ ë” ì—°ìŠµ</button>
      <button class="sub-tab" data-sub="quiz-stats" onclick="switchQuizSub(this)">ğŸ“Š í†µê³„</button>
    </div>
    <div class="sub-content active" id="quiz-daily"><div id="quiz-container"></div></div>
    <div class="sub-content" id="quiz-practice"><div id="practice-container"></div></div>
    <div class="sub-content" id="quiz-stats"><div id="quiz-stats-container"></div></div>
  </section>

  <!-- ====== ìƒí™œë¹„ TAB ====== -->
  <section id="tab-expenses" class="tab-content">
    <div class="sub-tabs">
      <button class="sub-tab active" data-sub="exp-input" onclick="switchExpSub(this)">âœï¸ ì…ë ¥</button>
      <button class="sub-tab" data-sub="exp-calendar" onclick="switchExpSub(this)">ğŸ“… ë‹¬ë ¥</button>
      <button class="sub-tab" data-sub="exp-stats" onclick="switchExpSub(this)">ğŸ“Š í†µê³„</button>
      <button class="sub-tab" data-sub="exp-list" onclick="switchExpSub(this)">ğŸ“‹ ëª©ë¡</button>
    </div>

    <div id="budget-alert-container"></div>

    <div class="sub-content active" id="exp-input">
      <div class="card">
        <div class="input-group">
          <label>ğŸ’° ê¸ˆì•¡ (ì›) / So tien (KRW)</label>
          <input type="number" id="exp-amount" placeholder="ê¸ˆì•¡ ì…ë ¥ (ì›)" inputmode="numeric" oninput="showVndPreview()">
          <div class="currency-display" id="vnd-preview"></div>
        </div>
        <div class="input-group">
          <label>ğŸ’³ ê²°ì œ ìˆ˜ë‹¨ / Phuong thuc thanh toan</label>
          <div class="radio-group">
            <label class="radio-label selected" id="pay-cash" onclick="selectPayment('cash')">
              <input type="radio" name="payment" value="cash" checked>
              ğŸ’µ í˜„ê¸ˆ / Tien mat
            </label>
            <label class="radio-label" id="pay-card" onclick="selectPayment('card')">
              <input type="radio" name="payment" value="card">
              ğŸ’³ ì¹´ë“œ / The
            </label>
          </div>
        </div>
        <div class="input-group">
          <label>ğŸ“‚ ì¹´í…Œê³ ë¦¬ / Danh muc</label>
          <div class="category-grid" id="exp-cat-grid"></div>
        </div>
        <div class="input-group">
          <label>ğŸ“ ë©”ëª¨ / Ghi chu</label>
          <input type="text" id="exp-memo" placeholder="ë©”ëª¨ ì…ë ¥...">
        </div>
        <div class="input-group">
          <label>ğŸ“… ë‚ ì§œ / Ngay</label>
          <input type="date" id="exp-date">
        </div>
        <button class="btn btn-primary btn-full" onclick="addExpense()" style="margin-top:6px;">ì €ì¥ / Luu âœ…</button>
      </div>
    </div>

    <div class="sub-content" id="exp-calendar">
      <div class="card">
        <div class="calendar-nav">
          <button class="cal-nav-btn" onclick="changeMonth(-1)">â—€</button>
          <h3 id="cal-month-label"></h3>
          <button class="cal-nav-btn" onclick="changeMonth(1)">â–¶</button>
        </div>
        <div class="calendar-grid" id="calendar-grid"></div>
      </div>
    </div>

    <div class="sub-content" id="exp-stats"><div id="stats-container"></div></div>
    <div class="sub-content" id="exp-list"><div id="expense-list-container"></div></div>
  </section>

  <!-- ====== ì„¤ì • TAB ====== -->
  <section id="tab-settings" class="tab-content">
    <div class="card">
      <h3 style="margin-bottom:14px;">âš™ï¸ ì„¤ì • / Cai dat</h3>
      <div class="setting-item">
        <div>
          <div class="setting-label">ğŸŒ™ ë‹¤í¬ëª¨ë“œ / Che do toi</div>
          <div class="setting-desc">ì‹œìŠ¤í…œ ì„¤ì • ìë™ ê°ì§€</div>
        </div>
        <button class="toggle-switch" id="theme-toggle" onclick="toggleTheme()"></button>
      </div>
      <div class="setting-item">
        <div>
          <div class="setting-label">ğŸ’± í™˜ìœ¨ / Ty gia</div>
          <div class="setting-desc" id="rate-info">1â‚© = --â‚«</div>
        </div>
        <button class="btn btn-sm btn-secondary" onclick="openRateModal()">ì„¤ì •</button>
      </div>
      <div class="setting-item">
        <div>
          <div class="setting-label">ğŸ’° ì›” ì˜ˆì‚° / Ngan sach</div>
          <div class="setting-desc" id="budget-info">ì„¤ì • ì•ˆë¨</div>
        </div>
        <button class="btn btn-sm btn-secondary" onclick="openBudgetModal()">ì„¤ì •</button>
      </div>
    </div>
    <div class="card">
      <h3 style="margin-bottom:14px;">ğŸ’¾ ë°ì´í„° ê´€ë¦¬ / Quan ly du lieu</h3>
      <div class="setting-item">
        <div>
          <div class="setting-label">ğŸ“¥ ë°±ì—… / Sao luu</div>
          <div class="setting-desc">JSON íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ</div>
        </div>
        <button class="btn btn-sm btn-accent" onclick="backupData()">ë°±ì—…</button>
      </div>
      <div class="setting-item">
        <div>
          <div class="setting-label">ğŸ“¤ ë³µì› / Khoi phuc</div>
          <div class="setting-desc">JSON íŒŒì¼ ì—…ë¡œë“œ</div>
        </div>
        <button class="btn btn-sm btn-secondary" onclick="document.getElementById('restore-file').click()">ë³µì›</button>
        <input type="file" id="restore-file" accept=".json" style="display:none" onchange="restoreData(event)">
      </div>
      <div class="setting-item">
        <div>
          <div class="setting-label">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ / Xoa tat ca</div>
          <div class="setting-desc">ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤</div>
        </div>
        <button class="btn btn-sm btn-danger" onclick="deleteAllData()">ì‚­ì œ</button>
      </div>
    </div>
  </section>

</main>

<nav id="bottom-nav">
  <button class="nav-item active" data-tab="tab-dictionary" onclick="switchTab(this)">
    <span class="nav-icon">ğŸ“š</span><span class="nav-label">ë‹¨ì–´ì¥</span>
  </button>
  <button class="nav-item" data-tab="tab-quiz" onclick="switchTab(this)">
    <span class="nav-icon">ğŸ¯</span><span class="nav-label">í€´ì¦ˆ</span>
  </button>
  <button class="nav-item" data-tab="tab-expenses" onclick="switchTab(this)">
    <span class="nav-icon">ğŸ’°</span><span class="nav-label">ìƒí™œë¹„</span>
  </button>
  <button class="nav-item" data-tab="tab-settings" onclick="switchTab(this)">
    <span class="nav-icon">âš™ï¸</span><span class="nav-label">ì„¤ì •</span>
  </button>
</nav>

<!-- Word Modal -->
<div class="modal-overlay" id="word-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="word-modal-title">ğŸ“ ë‹¨ì–´ ì¶”ê°€ / Them tu</h3>
      <button class="modal-close" onclick="closeWordModal()">âœ•</button>
    </div>
    <div class="input-group">
      <label>ğŸ‡»ğŸ‡³ ë² íŠ¸ë‚¨ì–´ / Tieng Viet</label>
      <input type="text" id="word-viet" placeholder="ì˜ˆ: Xin chao">
    </div>
    <div class="input-group">
      <label>ğŸ‡°ğŸ‡· í•œêµ­ì–´ / Tieng Han</label>
      <input type="text" id="word-korean" placeholder="ì˜ˆ: ì•ˆë…•í•˜ì„¸ìš”">
    </div>
    <div class="input-group">
      <label>ğŸ—£ï¸ ë°œìŒ / Phat am</label>
      <input type="text" id="word-pron" placeholder="ì˜ˆ: ì‹  ì§œì˜¤">
    </div>
    <div class="input-group">
      <label>ğŸ’¬ ì˜ˆë¬¸ / Vi du</label>
      <textarea id="word-example" placeholder="ì˜ˆ: Xin chao ban!"></textarea>
    </div>
    <div class="input-group">
      <label>ğŸ“‚ ì¹´í…Œê³ ë¦¬ / Danh muc</label>
      <div class="category-grid" id="word-cat-grid"></div>
    </div>
    <div class="input-group">
      <label>ğŸ“Š ë‚œì´ë„ / Do kho</label>
      <div class="radio-group" id="word-diff-group">
        <label class="radio-label selected" onclick="selectWordDiff('easy')"><input type="radio" name="word-diff" value="easy" checked>ì‰¬ì›€</label>
        <label class="radio-label" onclick="selectWordDiff('normal')"><input type="radio" name="word-diff" value="normal">ë³´í†µ</label>
        <label class="radio-label" onclick="selectWordDiff('hard')"><input type="radio" name="word-diff" value="hard">ì–´ë ¤ì›€</label>
      </div>
    </div>
    <input type="hidden" id="word-edit-id">
    <button class="btn btn-primary btn-full" onclick="saveWord()" style="margin-top:4px;">ì €ì¥ / Luu âœ…</button>
  </div>
</div>

<!-- Day Detail Modal -->
<div class="modal-overlay" id="day-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="day-modal-title">ğŸ“… ì§€ì¶œ ìƒì„¸</h3>
      <button class="modal-close" onclick="closeDayModal()">âœ•</button>
    </div>
    <div id="day-modal-content"></div>
  </div>
</div>

<!-- Expense Edit Modal -->
<div class="modal-overlay" id="expense-edit-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>âœï¸ ì§€ì¶œ ìˆ˜ì • / Sua chi tieu</h3>
      <button class="modal-close" onclick="closeExpenseEditModal()">âœ•</button>
    </div>
    <div class="input-group">
      <label>ğŸ’° ê¸ˆì•¡ (ì›) / So tien</label>
      <input type="number" id="edit-exp-amount" inputmode="numeric">
    </div>
    <div class="input-group">
      <label>ğŸ’³ ê²°ì œ ìˆ˜ë‹¨ / Phuong thuc</label>
      <div class="radio-group">
        <label class="radio-label" id="edit-pay-cash" onclick="selectEditPayment('cash')"><input type="radio" name="edit-payment" value="cash">ğŸ’µ í˜„ê¸ˆ</label>
        <label class="radio-label" id="edit-pay-card" onclick="selectEditPayment('card')"><input type="radio" name="edit-payment" value="card">ğŸ’³ ì¹´ë“œ</label>
      </div>
    </div>
    <div class="input-group">
      <label>ğŸ“‚ ì¹´í…Œê³ ë¦¬ / Danh muc</label>
      <select id="edit-exp-cat"></select>
    </div>
    <div class="input-group">
      <label>ğŸ“ ë©”ëª¨ / Ghi chu</label>
      <input type="text" id="edit-exp-memo">
    </div>
    <div class="input-group">
      <label>ğŸ“… ë‚ ì§œ / Ngay</label>
      <input type="date" id="edit-exp-date">
    </div>
    <input type="hidden" id="edit-exp-id">
    <button class="btn btn-primary btn-full" onclick="saveEditExpense()">ìˆ˜ì • ì™„ë£Œ / Hoan thanh âœ…</button>
  </div>
</div>

<!-- Rate Modal -->
<div class="modal-overlay" id="rate-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ’± í™˜ìœ¨ ì„¤ì • / Ty gia</h3>
      <button class="modal-close" onclick="closeModal('rate-modal')">âœ•</button>
    </div>
    <div class="input-group">
      <label>1 KRW (â‚©) = ? VND (â‚«)</label>
      <input type="number" id="rate-input" step="0.01" inputmode="decimal">
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-secondary btn-full" onclick="fetchExchangeRate()">ğŸ”„ ìë™ ì—…ë°ì´íŠ¸</button>
      <button class="btn btn-primary btn-full" onclick="saveManualRate()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Budget Modal -->
<div class="modal-overlay" id="budget-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ’° ì›” ì˜ˆì‚° ì„¤ì • / Ngan sach</h3>
      <button class="modal-close" onclick="closeModal('budget-modal')">âœ•</button>
    </div>
    <div class="input-group">
      <label>ì›” ì˜ˆì‚° (ì›) / Ngan sach hang thang (KRW)</label>
      <input type="number" id="budget-input" inputmode="numeric" placeholder="ì˜ˆ: 500000">
    </div>
    <button class="btn btn-primary btn-full" onclick="saveBudget()">ì €ì¥ / Luu âœ…</button>
  </div>
</div>

<script>
// ==================== CONSTANTS ====================
const SK = {
  words: 'uridul_words', expenses: 'uridul_expenses',
  quiz: 'uridul_quiz', quizStats: 'uridul_quiz_stats',
  cardBill: 'uridul_card_bill', theme: 'uridul_theme',
  rate: 'uridul_rate', budget: 'uridul_budget',
  version: 'uridul_version'
};
const DEFAULT_RATE = 19.5;
const WORD_CATS = {
  greeting: { icon: 'ğŸ‘‹', ko: 'ì¸ì‚¬', vi: 'Chao hoi' },
  family: { icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§', ko: 'ê°€ì¡±', vi: 'Gia dinh' },
  food: { icon: 'ğŸœ', ko: 'ìŒì‹', vi: 'Thuc an' },
  emotion: { icon: 'ğŸ˜Š', ko: 'ê°ì •', vi: 'Cam xuc' },
  daily: { icon: 'ğŸ“…', ko: 'ì¼ìƒ', vi: 'Hang ngay' },
  number: { icon: 'ğŸ”¢', ko: 'ìˆ«ì', vi: 'So' },
  other: { icon: 'ğŸ“Œ', ko: 'ê¸°íƒ€', vi: 'Khac' }
};
const EXP_CATS = {
  food: { icon: 'ğŸœ', ko: 'ì‹ë¹„', vi: 'An uong' },
  transport: { icon: 'ğŸš•', ko: 'êµí†µë¹„', vi: 'Di lai' },
  shopping: { icon: 'ğŸ›ï¸', ko: 'ì‡¼í•‘', vi: 'Mua sam' },
  living: { icon: 'ğŸ ', ko: 'ìƒí™œìš©í’ˆ', vi: 'Do gia dung' },
  cafe: { icon: 'â˜•', ko: 'ì¹´í˜', vi: 'Ca phe' },
  health: { icon: 'ğŸ’Š', ko: 'ì˜ë£Œ', vi: 'Y te' },
  other: { icon: 'ğŸ“¦', ko: 'ê¸°íƒ€', vi: 'Khac' }
};
const DIFFICULTIES = {
  easy: { ko: 'ì‰¬ì›€', vi: 'De', color: '#66bb6a', count: 5 },
  normal: { ko: 'ë³´í†µ', vi: 'Trung binh', color: '#ffa726', count: 3 },
  hard: { ko: 'ì–´ë ¤ì›€', vi: 'Kho', color: '#e85d5d', count: 2 }
};
const BADGES = [
  { count: 10, icon: 'ğŸŒ±', ko: 'ì²« ê±¸ìŒ', vi: 'Buoc dau' },
  { count: 50, icon: 'ğŸŒ¿', ko: 'ì„±ì¥ ì¤‘', vi: 'Dang lon' },
  { count: 100, icon: 'ğŸŒ³', ko: 'ë§ˆìŠ¤í„°', vi: 'Bac thay' }
];

// ==================== DATA ====================
function load(key) { try { return JSON.parse(localStorage.getItem(key)); } catch { return null; } }
function save(key, data) { localStorage.setItem(key, JSON.stringify(data)); }

let words = load(SK.words) || [];
let expenses = load(SK.expenses) || [];
let quizStats = load(SK.quizStats) || { total: 0, correct: 0, streak: 0, best: 0, weekly: {}, monthly: {} };
let exchangeRate = DEFAULT_RATE;
let calYear, calMonth;
let selectedPayment = 'cash';
let selectedExpCat = 'food';
let selectedWordCat = 'other';
let selectedWordDiff = 'easy';
let editPayment = 'cash';
let currentWordCatFilter = 'all';
let searchTimer = null;

// ==================== UTILS ====================
function toDateStr(d) { return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); }
function todayStr() { return toDateStr(new Date()); }
function fmt(n) { return Number(n).toLocaleString('ko-KR'); }
function toVnd(krw) { return Math.round(krw * exchangeRate); }
function dualCurrency(krw) { return `${fmt(krw)}â‚© (${fmt(toVnd(krw))}â‚«)`; }
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/'/g,'&#39;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function getWeekKey(d) { const dt=new Date(d); const jan1=new Date(dt.getFullYear(),0,1); const wk=Math.ceil(((dt-jan1)/86400000+jan1.getDay()+1)/7); return dt.getFullYear()+'-W'+String(wk).padStart(2,'0'); }
function getMonthKey(d) { const dt=new Date(d); return dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0'); }
function showToast(msg, type='info') {
  const t=document.createElement('div');
  t.className='toast toast-'+type; t.textContent=msg;
  document.body.appendChild(t); setTimeout(()=>t.remove(),2200);
}

// ==================== THEME ====================
function initTheme() {
  const saved = localStorage.getItem(SK.theme);
  if (saved) { document.documentElement.setAttribute('data-theme', saved); }
  else if (window.matchMedia('(prefers-color-scheme:dark)').matches) { document.documentElement.setAttribute('data-theme','dark'); }
  updateThemeToggle();
}
function toggleTheme() {
  const cur = document.documentElement.getAttribute('data-theme');
  const nxt = cur === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', nxt);
  localStorage.setItem(SK.theme, nxt);
  updateThemeToggle();
}
function updateThemeToggle() {
  const btn = document.getElementById('theme-toggle');
  if (btn) btn.classList.toggle('on', document.documentElement.getAttribute('data-theme')==='dark');
}

// ==================== EXCHANGE RATE ====================
function loadRate() {
  const saved = load(SK.rate);
  if (saved && saved.rate) {
    exchangeRate = saved.rate;
    if (saved.lastFetch && Date.now()-saved.lastFetch < 86400000) return;
  }
  fetchExchangeRate();
}
async function fetchExchangeRate() {
  try {
    const res = await fetch('https://api.exchangerate-api.com/v4/latest/KRW');
    const data = await res.json();
    if (data.rates && data.rates.VND) {
      exchangeRate = data.rates.VND;
      save(SK.rate, { rate: exchangeRate, lastFetch: Date.now(), manual: false });
      showToast('í™˜ìœ¨ ì—…ë°ì´íŠ¸ ì™„ë£Œ!','success');
      updateRateDisplay();
    }
  } catch { showToast('í™˜ìœ¨ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨. ê¸°ë³¸ê°’ ì‚¬ìš©.','error'); }
}
function saveManualRate() {
  const v = parseFloat(document.getElementById('rate-input').value);
  if (!v || v<=0) { showToast('ì˜¬ë°”ë¥¸ í™˜ìœ¨ì„ ì…ë ¥í•˜ì„¸ìš”','error'); return; }
  exchangeRate = v;
  save(SK.rate, { rate: v, lastFetch: Date.now(), manual: true });
  showToast('í™˜ìœ¨ ì €ì¥ ì™„ë£Œ!','success');
  updateRateDisplay(); closeModal('rate-modal');
}
function updateRateDisplay() {
  const el = document.getElementById('rate-info');
  if (el) el.textContent = `1â‚© = ${exchangeRate.toFixed(2)}â‚«`;
}
function openRateModal() {
  document.getElementById('rate-input').value = exchangeRate;
  document.getElementById('rate-modal').classList.add('show');
}

// ==================== BUDGET ====================
function loadBudget() {
  const b = load(SK.budget);
  const el = document.getElementById('budget-info');
  if (b && b.amount) {
    el.textContent = `${fmt(b.amount)}â‚© / ì›”`;
  } else {
    el.textContent = 'ì„¤ì • ì•ˆë¨';
  }
}
function openBudgetModal() {
  const b = load(SK.budget);
  document.getElementById('budget-input').value = b ? b.amount : '';
  document.getElementById('budget-modal').classList.add('show');
}
function saveBudget() {
  const v = parseInt(document.getElementById('budget-input').value);
  if (!v || v<=0) { showToast('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”','error'); return; }
  save(SK.budget, { amount: v });
  showToast('ì˜ˆì‚° ì €ì¥ ì™„ë£Œ!','success');
  loadBudget(); closeModal('budget-modal'); renderBudgetAlert(); renderStats();
}
function renderBudgetAlert() {
  const container = document.getElementById('budget-alert-container');
  const b = load(SK.budget);
  if (!b || !b.amount) { container.innerHTML=''; return; }
  const now = new Date();
  const mk = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0');
  const monthTotal = expenses.filter(e => e.date.startsWith(mk)).reduce((s,e)=>s+e.amount,0);
  const pct = Math.round((monthTotal/b.amount)*100);
  if (pct >= 90) {
    container.innerHTML = `<div class="budget-alert">âš ï¸ ì˜ˆì‚°ì˜ ${pct}%ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤! (${fmt(monthTotal)}â‚© / ${fmt(b.amount)}â‚©)</div>`;
  } else { container.innerHTML=''; }
}

// ==================== TAB NAVIGATION ====================
const headerSubs = {
  'tab-dictionary': 'ë‹¨ì–´ì¥ / Tu vung', 'tab-quiz': 'í€´ì¦ˆ / Cau do',
  'tab-expenses': 'ìƒí™œë¹„ / Chi phi', 'tab-settings': 'ì„¤ì • / Cai dat'
};
function switchTab(el) {
  const id = el.dataset.tab;
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('header-sub').textContent = headerSubs[id];
  if (id==='tab-quiz') { renderQuiz(); renderPractice(); renderQuizStats(); }
  if (id==='tab-expenses') { renderCalendar(); renderStats(); renderExpenseList(); renderBudgetAlert(); }
  if (id==='tab-settings') { updateRateDisplay(); loadBudget(); }
}
function switchDictSub(el) {
  document.querySelectorAll('#tab-dictionary .sub-tab').forEach(s=>s.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('#tab-dictionary .sub-content').forEach(s=>s.classList.remove('active'));
  document.getElementById(el.dataset.sub).classList.add('active');
  if (el.dataset.sub==='dict-mywords') renderMyWords();
}
function switchQuizSub(el) {
  document.querySelectorAll('#tab-quiz .sub-tab').forEach(s=>s.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('#tab-quiz .sub-content').forEach(s=>s.classList.remove('active'));
  document.getElementById(el.dataset.sub).classList.add('active');
  if (el.dataset.sub==='quiz-daily') renderQuiz();
  if (el.dataset.sub==='quiz-practice') renderPractice();
  if (el.dataset.sub==='quiz-stats') renderQuizStats();
}
function switchExpSub(el) {
  document.querySelectorAll('#tab-expenses .sub-tab').forEach(s=>s.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('#tab-expenses .sub-content').forEach(s=>s.classList.remove('active'));
  document.getElementById(el.dataset.sub).classList.add('active');
  if (el.dataset.sub==='exp-calendar') renderCalendar();
  if (el.dataset.sub==='exp-stats') renderStats();
  if (el.dataset.sub==='exp-list') renderExpenseList();
}

// ==================== SPEECH ====================
function speak(text, lang) {
  if (!('speechSynthesis' in window)) { showToast('ìŒì„± ì§€ì› ë¶ˆê°€','error'); return; }
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text); u.lang=lang; u.rate=0.85;
  window.speechSynthesis.speak(u);
}

// ==================== TRANSLATION SEARCH ====================
function detectLang(text) { return /[ê°€-í£]/.test(text) ? 'ko' : 'vi'; }
function onTransSearch(val) {
  clearTimeout(searchTimer);
  const q = val.trim();
  if (q.length < 1) {
    document.getElementById('trans-results').innerHTML='';
    document.getElementById('trans-loading').style.display='none';
    document.getElementById('trans-empty').style.display='block';
    return;
  }
  document.getElementById('trans-empty').style.display='none';
  document.getElementById('trans-loading').style.display='block';
  searchTimer = setTimeout(()=>searchTranslation(q), 600);
}
async function searchTranslation(query) {
  const lang = detectLang(query);
  const pair = lang==='ko' ? 'ko|vi' : 'vi|ko';
  try {
    const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(query)}&langpair=${pair}`);
    const data = await res.json();
    document.getElementById('trans-loading').style.display='none';
    const results = [];
    if (data.responseData && data.responseData.translatedText) {
      results.push({
        source: query,
        translated: data.responseData.translatedText,
        quality: data.responseData.match || 0,
        sourceLang: lang
      });
    }
    if (data.matches) {
      data.matches.slice(0, 5).forEach(m => {
        if (m.translation && m.translation !== results[0]?.translated) {
          results.push({ source: m.segment, translated: m.translation, quality: parseFloat(m.quality)||0, sourceLang: lang });
        }
      });
    }
    renderSearchResults(results);
  } catch {
    document.getElementById('trans-loading').style.display='none';
    document.getElementById('trans-results').innerHTML = '<div class="empty-state"><span class="emoji">âŒ</span><p>ë²ˆì—­ ì‹¤íŒ¨. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.<br>Khong the dich. Kiem tra ket noi.</p></div>';
  }
}
function renderSearchResults(results) {
  const container = document.getElementById('trans-results');
  if (results.length===0) {
    container.innerHTML = '<div class="empty-state"><span class="emoji">ğŸ¤·</span><p>ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤ / Khong co ket qua</p></div>';
    return;
  }
  container.innerHTML = results.map((r, i) => {
    const viet = r.sourceLang==='ko' ? r.translated : r.source;
    const kor = r.sourceLang==='ko' ? r.source : r.translated;
    const exists = words.some(w=>w.vietnamese.toLowerCase()===viet.toLowerCase() && w.korean===kor);
    return `
      <div class="card search-result-card">
        <button class="add-btn ${exists?'added':''}" onclick="addFromSearch(${i})" title="${exists?'ì¶”ê°€ë¨':'ë‹¨ì–´ì¥ì— ì¶”ê°€'}">${exists?'âœ…':'â­'}</button>
        <div class="word-viet">
          <button class="speak-btn" onclick="speak('${esc(viet)}','vi-VN')">ğŸ”Š</button>
          ${esc(viet)}
        </div>
        <div class="word-korean" style="margin-top:6px;">
          <button class="speak-btn" onclick="speak('${esc(kor)}','ko-KR')" style="font-size:16px;">ğŸ”ˆ</button>
          ${esc(kor)}
        </div>
      </div>`;
  }).join('');
  window._searchResults = results;
}
function addFromSearch(idx) {
  const r = window._searchResults[idx];
  if (!r) return;
  const viet = r.sourceLang==='ko' ? r.translated : r.source;
  const kor = r.sourceLang==='ko' ? r.source : r.translated;
  if (words.some(w=>w.vietnamese.toLowerCase()===viet.toLowerCase()&&w.korean===kor)) {
    showToast('ì´ë¯¸ ì¶”ê°€ëœ ë‹¨ì–´ì…ë‹ˆë‹¤!','info'); return;
  }
  openWordModal(null, viet, kor);
}

// ==================== WORD CATEGORY GRID ====================
function renderWordCatGrid(containerId, selected) {
  const el = document.getElementById(containerId);
  el.innerHTML = Object.entries(WORD_CATS).map(([k,v])=>
    `<button class="cat-btn ${k===selected?'selected':''}" data-cat="${k}" onclick="selectWordCatBtn(this,'${containerId}')"><span class="cat-icon">${v.icon}</span>${v.ko}</button>`
  ).join('');
}
function selectWordCatBtn(btn, containerId) {
  document.querySelectorAll('#'+containerId+' .cat-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedWordCat = btn.dataset.cat;
}
function selectWordDiff(d) {
  selectedWordDiff = d;
  document.querySelectorAll('#word-diff-group .radio-label').forEach(l=>l.classList.remove('selected'));
  document.querySelector(`#word-diff-group .radio-label:has(input[value="${d}"])`)?.classList.add('selected')
    || document.querySelectorAll('#word-diff-group .radio-label').forEach(l=>{if(l.querySelector('input').value===d)l.classList.add('selected');});
}

// ==================== EXPENSE CAT GRID ====================
function renderExpCatGrid() {
  const el = document.getElementById('exp-cat-grid');
  el.innerHTML = Object.entries(EXP_CATS).map(([k,v])=>
    `<button class="cat-btn ${k===selectedExpCat?'selected':''}" data-cat="${k}" onclick="selectExpCatBtn(this)"><span class="cat-icon">${v.icon}</span>${v.ko}</button>`
  ).join('');
  // Also populate edit select
  const sel = document.getElementById('edit-exp-cat');
  sel.innerHTML = Object.entries(EXP_CATS).map(([k,v])=>
    `<option value="${k}">${v.icon} ${v.ko}</option>`
  ).join('');
}
function selectExpCatBtn(btn) {
  document.querySelectorAll('#exp-cat-grid .cat-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedExpCat = btn.dataset.cat;
}

// ==================== WORD CATEGORY FILTER ====================
function renderWordCatFilter() {
  const el = document.getElementById('word-cat-filter');
  let html = `<button class="filter-chip ${currentWordCatFilter==='all'?'active':''}" onclick="filterWordCat('all')">ì „ì²´</button>`;
  Object.entries(WORD_CATS).forEach(([k,v])=>{
    const count = words.filter(w=>(w.category||'other')===k).length;
    if (count>0) html+=`<button class="filter-chip ${currentWordCatFilter===k?'active':''}" onclick="filterWordCat('${k}')">${v.icon} ${v.ko} (${count})</button>`;
  });
  el.innerHTML = html;
}
function filterWordCat(cat) { currentWordCatFilter=cat; renderWordCatFilter(); renderMyWords(); }

// ==================== MY WORDS ====================
function renderMyWords() {
  const list = document.getElementById('word-list');
  const query = (document.getElementById('word-search-input')?.value||'').trim().toLowerCase();
  let filtered = words;
  if (currentWordCatFilter!=='all') filtered = filtered.filter(w=>(w.category||'other')===currentWordCatFilter);
  if (query) filtered = filtered.filter(w=>w.vietnamese.toLowerCase().includes(query)||w.korean.includes(query)||(w.pronunciation||'').includes(query));

  if (filtered.length===0) {
    list.innerHTML = `<div class="empty-state"><span class="emoji">ğŸ“–</span><p>${query||currentWordCatFilter!=='all'?'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤':'ë‹¨ì–´ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!'}</p></div>`;
  } else {
    list.innerHTML = filtered.map(w=>{
      const cat = WORD_CATS[w.category||'other']||WORD_CATS.other;
      const diff = DIFFICULTIES[w.difficulty||'easy']||DIFFICULTIES.easy;
      return `
      <div class="card word-card">
        <div class="word-card-header">
          <div>
            <div class="word-viet">
              <button class="speak-btn" onclick="speak('${esc(w.vietnamese)}','vi-VN')">ğŸ”Š</button>
              ${esc(w.vietnamese)}
            </div>
            <div class="word-korean">
              <button class="speak-btn" onclick="speak('${esc(w.korean)}','ko-KR')" style="font-size:16px;">ğŸ”ˆ</button>
              ${esc(w.korean)}
            </div>
            ${w.pronunciation?`<div class="word-pron">ğŸ—£ï¸ ${esc(w.pronunciation)}</div>`:''}
          </div>
          <label class="learn-check">
            <input type="checkbox" ${w.learned?'checked':''} onchange="toggleLearned(${w.id})">
            <span>${w.learned?'âœ…':'â¬œ'}</span>
          </label>
        </div>
        ${w.example?`<div class="word-example">ğŸ’¬ ${esc(w.example)}</div>`:''}
        <div style="display:flex;gap:6px;align-items:center;margin-top:8px;">
          <span style="font-size:12px;">${cat.icon} ${cat.ko}</span>
          <span class="diff-badge diff-${w.difficulty||'easy'}">${diff.ko}</span>
          ${w.learnedDate?`<span style="font-size:11px;color:var(--accent);">ğŸ“… ${w.learnedDate}</span>`:''}
        </div>
        <div class="word-actions">
          <button class="icon-btn" onclick="editWord(${w.id})">âœï¸</button>
          <button class="icon-btn" onclick="deleteWord(${w.id})">ğŸ—‘ï¸</button>
        </div>
      </div>`;
    }).join('');
  }
  updateProgress();
  renderWordCatFilter();
}

function openWordModal(editId, preViet, preKor) {
  const modal = document.getElementById('word-modal');
  modal.classList.add('show');
  renderWordCatGrid('word-cat-grid', selectedWordCat);
  if (editId) {
    const w = words.find(x=>x.id===editId);
    if (!w) return;
    document.getElementById('word-modal-title').textContent = 'âœï¸ ë‹¨ì–´ ìˆ˜ì • / Sua tu';
    document.getElementById('word-viet').value = w.vietnamese;
    document.getElementById('word-korean').value = w.korean;
    document.getElementById('word-pron').value = w.pronunciation||'';
    document.getElementById('word-example').value = w.example||'';
    document.getElementById('word-edit-id').value = w.id;
    selectedWordCat = w.category||'other';
    selectedWordDiff = w.difficulty||'easy';
    renderWordCatGrid('word-cat-grid', selectedWordCat);
    selectWordDiff(selectedWordDiff);
  } else {
    document.getElementById('word-modal-title').textContent = 'ğŸ“ ë‹¨ì–´ ì¶”ê°€ / Them tu';
    document.getElementById('word-viet').value = preViet||'';
    document.getElementById('word-korean').value = preKor||'';
    document.getElementById('word-pron').value = '';
    document.getElementById('word-example').value = '';
    document.getElementById('word-edit-id').value = '';
    selectedWordCat = 'other';
    selectedWordDiff = 'easy';
    renderWordCatGrid('word-cat-grid', 'other');
    selectWordDiff('easy');
  }
}
function closeWordModal() { document.getElementById('word-modal').classList.remove('show'); }

function saveWord() {
  const v=document.getElementById('word-viet').value.trim();
  const k=document.getElementById('word-korean').value.trim();
  const p=document.getElementById('word-pron').value.trim();
  const e=document.getElementById('word-example').value.trim();
  const editId=document.getElementById('word-edit-id').value;
  if (!v||!k) { showToast('ë² íŠ¸ë‚¨ì–´ì™€ í•œêµ­ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”!','error'); return; }
  if (editId) {
    const idx=words.findIndex(x=>x.id===Number(editId));
    if (idx>-1) { Object.assign(words[idx],{vietnamese:v,korean:k,pronunciation:p,example:e,category:selectedWordCat,difficulty:selectedWordDiff}); }
    showToast('ìˆ˜ì • ì™„ë£Œ!','success');
  } else {
    words.unshift({id:Date.now(),vietnamese:v,korean:k,pronunciation:p,example:e,category:selectedWordCat,difficulty:selectedWordDiff,learned:false,learnedDate:null,addedDate:todayStr()});
    showToast('ì¶”ê°€ ì™„ë£Œ!','success');
  }
  save(SK.words, words); closeWordModal(); renderMyWords();
  // refresh search results if on search tab
  const q = document.getElementById('trans-search-input')?.value;
  if (q) onTransSearch(q);
}
function editWord(id) { openWordModal(id); }
function deleteWord(id) {
  if (!confirm('ì´ ë‹¨ì–´ë¥¼ ì‚­ì œí• ê¹Œìš”?\nXoa tu nay?')) return;
  words=words.filter(w=>w.id!==id); save(SK.words,words); renderMyWords(); showToast('ì‚­ì œ ì™„ë£Œ!','success');
}
function toggleLearned(id) {
  const w=words.find(x=>x.id===id);
  if (w) { w.learned=!w.learned; w.learnedDate=w.learned?todayStr():null; save(SK.words,words); renderMyWords(); }
}
function updateProgress() {
  const total=words.length, learned=words.filter(w=>w.learned).length;
  const pct=total>0?Math.round((learned/total)*100):0;
  document.getElementById('progress-fill').style.width=pct+'%';
  document.getElementById('progress-text').textContent=pct+'%';
  document.getElementById('progress-detail').textContent=`${total}ê°œ ì¤‘ ${learned}ê°œ í•™ìŠµ ì™„ë£Œ / ${learned}/${total} tu da hoc`;
  document.getElementById('badges-container').innerHTML=BADGES.map(b=>{
    const e=learned>=b.count;
    return `<span class="badge ${e?'earned':'locked'}">${b.icon} ${b.ko} (${b.count})${e?' âœ…':''}</span>`;
  }).join('');
}

// ==================== QUIZ (DAILY) ====================
function renderQuiz() {
  const container=document.getElementById('quiz-container');
  const qd=load(SK.quiz); const today=todayStr();
  if (words.length<4) {
    container.innerHTML=`<div class="quiz-status card"><span class="emoji">ğŸ“</span><h3>ë‹¨ì–´ê°€ ë¶€ì¡±í•´ìš”!</h3><p style="color:var(--text-secondary);margin-top:8px;">ìµœì†Œ 4ê°œ ë‹¨ì–´ê°€ í•„ìš”í•©ë‹ˆë‹¤. ë‹¨ì–´ì¥ì—ì„œ ì¶”ê°€í•´ì£¼ì„¸ìš”!</p></div>`;
    return;
  }
  if (qd&&qd.date===today&&qd.completed) {
    container.innerHTML=`<div class="quiz-status card"><span class="emoji">ğŸ‰</span><h3>ì˜¤ëŠ˜ í€´ì¦ˆ ì™„ë£Œ!</h3><div class="quiz-score">${qd.score} / ${qd.total}</div><p style="color:var(--text-secondary);">ë‚´ì¼ ë‹¤ì‹œ ë„ì „í•˜ì„¸ìš”!<br><span style="font-size:12px;">ğŸ•› ìì •ì— ìƒˆ í€´ì¦ˆ ìƒì„±</span></p></div>`;
    return;
  }
  if (qd&&qd.date===today&&!qd.completed) { renderQuizQ(qd); return; }
  container.innerHTML=`<div class="quiz-status card"><span class="emoji">ğŸ¯</span><h3>í•˜ë£¨ í€´ì¦ˆ / Cau do hang ngay</h3><p style="color:var(--text-secondary);margin:12px 0;">ë§¤ì¼ 10ë¬¸ì œë¡œ ì‹¤ë ¥ í™•ì¸!<br>10 cau hoi moi ngay!</p><button class="btn btn-primary btn-full" onclick="startQuiz()">ì‹œì‘í•˜ê¸° / Bat dau ğŸš€</button></div>`;
}

function startQuiz() {
  const totalQ = Math.min(10, words.length);
  const easyW=words.filter(w=>(w.difficulty||'easy')==='easy');
  const normW=words.filter(w=>(w.difficulty||'easy')==='normal');
  const hardW=words.filter(w=>(w.difficulty||'easy')==='hard');
  let selected=[];
  function pick(arr, n) { return [...arr].sort(()=>Math.random()-0.5).slice(0,n); }
  selected.push(...pick(easyW, Math.min(DIFFICULTIES.easy.count, easyW.length)));
  selected.push(...pick(normW, Math.min(DIFFICULTIES.normal.count, normW.length)));
  selected.push(...pick(hardW, Math.min(DIFFICULTIES.hard.count, hardW.length)));
  // Fill remaining
  while(selected.length<totalQ) {
    const remaining=words.filter(w=>!selected.find(s=>s.id===w.id));
    if(remaining.length===0)break;
    selected.push(remaining[Math.floor(Math.random()*remaining.length)]);
  }
  selected=selected.slice(0,totalQ).sort(()=>Math.random()-0.5);
  const questions=makeQuestions(selected);
  const qd={date:todayStr(),questions,current:0,score:0,total:questions.length,completed:false};
  save(SK.quiz, qd); renderQuizQ(qd);
}

function makeQuestions(selected) {
  return selected.map(w=>{
    const isVK=Math.random()>0.5;
    const correct=isVK?w.korean:w.vietnamese;
    const prompt=isVK?w.vietnamese:w.korean;
    const lang=isVK?'viâ†’ko':'koâ†’vi';
    const pool=words.filter(x=>x.id!==w.id).sort(()=>Math.random()-0.5).slice(0,3);
    const wrongs=pool.map(x=>isVK?x.korean:x.vietnamese);
    const options=[...wrongs,correct].sort(()=>Math.random()-0.5);
    return {wordId:w.id,prompt,correct,options,lang,diff:w.difficulty||'easy',answered:false,userAnswer:null};
  });
}

function renderQuizQ(qd) {
  const container=document.getElementById('quiz-container');
  const q=qd.questions[qd.current];
  if (!q) { qd.completed=true; save(SK.quiz,qd); updateQuizStats(qd); renderQuiz(); return; }
  const diff=DIFFICULTIES[q.diff]||DIFFICULTIES.easy;
  const dir=q.lang==='viâ†’ko'?'ì´ ë² íŠ¸ë‚¨ì–´ì˜ ëœ»ì€?':'ì´ í•œêµ­ì–´ì˜ ë² íŠ¸ë‚¨ì–´ëŠ”?';
  container.innerHTML=`
    <div class="card quiz-question-card">
      <div class="quiz-progress">ë¬¸ì œ ${qd.current+1} / ${qd.total} <span class="diff-badge diff-${q.diff}">${diff.ko}</span></div>
      <div class="progress-bar" style="margin-bottom:16px;"><div class="progress-fill" style="width:${(qd.current/qd.total)*100}%;background:var(--secondary);"></div></div>
      <div style="font-size:12px;color:var(--text-secondary);">${q.lang==='viâ†’ko'?'ğŸ‡»ğŸ‡³ â†’ ğŸ‡°ğŸ‡·':'ğŸ‡°ğŸ‡· â†’ ğŸ‡»ğŸ‡³'}</div>
      <div class="quiz-word">${esc(q.prompt)}</div>
      <div class="quiz-prompt">${dir}</div>
      <div class="quiz-options">
        ${q.options.map((opt,i)=>`
          <button class="quiz-option ${q.answered?(opt===q.correct?'correct':(opt===q.userAnswer&&opt!==q.correct?'wrong':'')):''}${q.answered?' disabled':''}" onclick="answerQuiz(${i},'daily')">${esc(opt)}</button>
        `).join('')}
      </div>
      ${q.answered?`
        <div style="margin-top:16px;">
          <p style="font-size:15px;font-weight:700;color:${q.userAnswer===q.correct?'var(--accent)':'var(--danger)'};">${q.userAnswer===q.correct?'âœ… ì •ë‹µ!':'âŒ ì˜¤ë‹µ!'}</p>
          ${q.userAnswer!==q.correct?`<p style="font-size:13px;color:var(--text-secondary);margin-top:4px;">ì •ë‹µ: ${esc(q.correct)}</p>`:''}
          <button class="btn btn-primary" onclick="nextQuizQ('daily')" style="margin-top:12px;">${qd.current<qd.total-1?'ë‹¤ìŒ ë¬¸ì œ â†’':'ê²°ê³¼ ë³´ê¸° ğŸ†'}</button>
        </div>`:''}
    </div>`;
}

function answerQuiz(idx, mode) {
  if (mode==='daily') {
    const qd=load(SK.quiz); const q=qd.questions[qd.current];
    if(q.answered)return; q.answered=true; q.userAnswer=q.options[idx];
    if(q.userAnswer===q.correct)qd.score++;
    save(SK.quiz,qd); renderQuizQ(qd);
  } else {
    const pd=load('uridul_practice'); const q=pd.questions[pd.current];
    if(q.answered)return; q.answered=true; q.userAnswer=q.options[idx];
    if(q.userAnswer===q.correct)pd.score++;
    save('uridul_practice',pd); renderPracticeQ(pd);
  }
}
function nextQuizQ(mode) {
  if (mode==='daily') {
    const qd=load(SK.quiz); qd.current++; save(SK.quiz,qd); renderQuizQ(qd);
  } else {
    const pd=load('uridul_practice'); pd.current++; save('uridul_practice',pd); renderPracticeQ(pd);
  }
}

function updateQuizStats(qd) {
  const today=todayStr();
  quizStats.total += qd.total;
  quizStats.correct += qd.score;
  if (qd.score===qd.total) { quizStats.streak++; quizStats.best=Math.max(quizStats.best,quizStats.streak); }
  else { quizStats.streak=0; }
  const wk=getWeekKey(today); const mk=getMonthKey(today);
  if(!quizStats.weekly[wk])quizStats.weekly[wk]={c:0,t:0};
  quizStats.weekly[wk].c+=qd.score; quizStats.weekly[wk].t+=qd.total;
  if(!quizStats.monthly[mk])quizStats.monthly[mk]={c:0,t:0};
  quizStats.monthly[mk].c+=qd.score; quizStats.monthly[mk].t+=qd.total;
  save(SK.quizStats, quizStats);
}

// ==================== QUIZ (PRACTICE) ====================
function renderPractice() {
  const container=document.getElementById('practice-container');
  const pd=load('uridul_practice');
  if (words.length<4) {
    container.innerHTML=`<div class="quiz-status card"><span class="emoji">ğŸ“</span><h3>ë‹¨ì–´ê°€ ë¶€ì¡±í•´ìš”!</h3><p style="color:var(--text-secondary);margin-top:8px;">ìµœì†Œ 4ê°œ ë‹¨ì–´ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p></div>`;
    return;
  }
  if (pd&&!pd.completed) { renderPracticeQ(pd); return; }
  container.innerHTML=`
    <div class="card" style="text-align:center;padding:24px;">
      <span style="font-size:48px;display:block;margin-bottom:12px;">ğŸ“</span>
      <h3>ì¶”ê°€ ì—°ìŠµ / Luyen tap them</h3>
      <p style="color:var(--text-secondary);margin:12px 0;">ë‚œì´ë„ë¥¼ ì„ íƒí•˜ê³  ë¬´ì œí•œ ì—°ìŠµ!</p>
      <div class="radio-group" style="margin:16px 0;">
        <label class="radio-label selected" id="prac-all" onclick="selectPracDiff('all')"><input type="radio" name="prac-diff" value="all" checked>ì „ì²´</label>
        <label class="radio-label" id="prac-easy" onclick="selectPracDiff('easy')"><input type="radio" name="prac-diff" value="easy">ì‰¬ì›€</label>
        <label class="radio-label" id="prac-normal" onclick="selectPracDiff('normal')"><input type="radio" name="prac-diff" value="normal">ë³´í†µ</label>
        <label class="radio-label" id="prac-hard" onclick="selectPracDiff('hard')"><input type="radio" name="prac-diff" value="hard">ì–´ë ¤ì›€</label>
      </div>
      <button class="btn btn-primary btn-full" onclick="startPractice()">ì—°ìŠµ ì‹œì‘ ğŸš€</button>
    </div>`;
}
let pracDiff='all';
function selectPracDiff(d) {
  pracDiff=d;
  ['all','easy','normal','hard'].forEach(x=>{
    const el=document.getElementById('prac-'+x);
    if(el)el.classList.toggle('selected',x===d);
  });
}
function startPractice() {
  let pool=words;
  if(pracDiff!=='all') pool=words.filter(w=>(w.difficulty||'easy')===pracDiff);
  if(pool.length<4) { showToast('í•´ë‹¹ ë‚œì´ë„ ë‹¨ì–´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!','error'); return; }
  const selected=[...pool].sort(()=>Math.random()-0.5).slice(0,10);
  const questions=makeQuestions(selected);
  const pd={questions,current:0,score:0,total:questions.length,completed:false,diff:pracDiff};
  save('uridul_practice',pd); renderPracticeQ(pd);
}
function renderPracticeQ(pd) {
  const container=document.getElementById('practice-container');
  const q=pd.questions[pd.current];
  if(!q) {
    pd.completed=true; save('uridul_practice',pd);
    const wrongs=pd.questions.filter(q=>q.userAnswer!==q.correct);
    container.innerHTML=`
      <div class="card" style="text-align:center;padding:24px;">
        <span style="font-size:48px;display:block;margin-bottom:12px;">ğŸ†</span>
        <h3>ì—°ìŠµ ì™„ë£Œ!</h3>
        <div class="quiz-score">${pd.score} / ${pd.total}</div>
        ${wrongs.length>0?`<button class="btn btn-danger" onclick="retryWrong()" style="margin:8px 0;">í‹€ë¦° ë¬¸ì œ ë‹¤ì‹œ í’€ê¸° (${wrongs.length})</button>`:''}
        <button class="btn btn-primary btn-full" onclick="localStorage.removeItem('uridul_practice');renderPractice();" style="margin-top:8px;">ë‹¤ì‹œ ì‹œì‘</button>
      </div>`;
    return;
  }
  const diff=DIFFICULTIES[q.diff]||DIFFICULTIES.easy;
  const dir=q.lang==='viâ†’ko'?'ì´ ë² íŠ¸ë‚¨ì–´ì˜ ëœ»ì€?':'ì´ í•œêµ­ì–´ì˜ ë² íŠ¸ë‚¨ì–´ëŠ”?';
  container.innerHTML=`
    <div class="card quiz-question-card">
      <div class="quiz-progress">ë¬¸ì œ ${pd.current+1} / ${pd.total} <span class="diff-badge diff-${q.diff}">${diff.ko}</span></div>
      <div class="progress-bar" style="margin-bottom:16px;"><div class="progress-fill" style="width:${(pd.current/pd.total)*100}%;background:var(--secondary);"></div></div>
      <div style="font-size:12px;color:var(--text-secondary);">${q.lang==='viâ†’ko'?'ğŸ‡»ğŸ‡³ â†’ ğŸ‡°ğŸ‡·':'ğŸ‡°ğŸ‡· â†’ ğŸ‡»ğŸ‡³'}</div>
      <div class="quiz-word">${esc(q.prompt)}</div>
      <div class="quiz-prompt">${dir}</div>
      <div class="quiz-options">
        ${q.options.map((opt,i)=>`
          <button class="quiz-option ${q.answered?(opt===q.correct?'correct':(opt===q.userAnswer&&opt!==q.correct?'wrong':'')):''}${q.answered?' disabled':''}" onclick="answerQuiz(${i},'practice')">${esc(opt)}</button>
        `).join('')}
      </div>
      ${q.answered?`<div style="margin-top:16px;">
        <p style="font-size:15px;font-weight:700;color:${q.userAnswer===q.correct?'var(--accent)':'var(--danger)'};">${q.userAnswer===q.correct?'âœ… ì •ë‹µ!':'âŒ ì˜¤ë‹µ!'}</p>
        ${q.userAnswer!==q.correct?`<p style="font-size:13px;color:var(--text-secondary);margin-top:4px;">ì •ë‹µ: ${esc(q.correct)}</p>`:''}
        <button class="btn btn-primary" onclick="nextQuizQ('practice')" style="margin-top:12px;">${pd.current<pd.total-1?'ë‹¤ìŒ â†’':'ê²°ê³¼ ë³´ê¸° ğŸ†'}</button>
      </div>`:''}
    </div>`;
}
function retryWrong() {
  const pd=load('uridul_practice');
  if(!pd) return;
  const wrongs=pd.questions.filter(q=>q.userAnswer!==q.correct);
  const wordIds=wrongs.map(q=>q.wordId);
  const pool=words.filter(w=>wordIds.includes(w.id));
  if(pool.length<2) { showToast('ë‹¨ì–´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤','error'); return; }
  const questions=makeQuestions(pool);
  const npd={questions,current:0,score:0,total:questions.length,completed:false,diff:'retry'};
  save('uridul_practice',npd); renderPracticeQ(npd);
}

// ==================== QUIZ STATS ====================
function renderQuizStats() {
  const container=document.getElementById('quiz-stats-container');
  const s=quizStats;
  const accuracy=s.total>0?Math.round((s.correct/s.total)*100):0;
  const wk=getWeekKey(todayStr()); const mk=getMonthKey(todayStr());
  const ws=s.weekly[wk]||{c:0,t:0}; const ms=s.monthly[mk]||{c:0,t:0};
  const wAcc=ws.t>0?Math.round((ws.c/ws.t)*100):0;
  const mAcc=ms.t>0?Math.round((ms.c/ms.t)*100):0;
  container.innerHTML=`
    <div class="stat-card"><div><div class="stat-label">ğŸ”¥ ì—°ì† ì •ë‹µ</div></div><div class="stat-value" style="color:var(--danger);">${s.streak}</div></div>
    <div class="stat-card"><div><div class="stat-label">ğŸ† ìµœê³  ì—°ì†</div></div><div class="stat-value" style="color:var(--secondary);">${s.best}</div></div>
    <div class="stat-card"><div><div class="stat-label">ğŸ¯ ì „ì²´ ì •ë‹µë¥ </div></div><div class="stat-value" style="color:var(--accent);">${accuracy}%</div></div>
    <div class="stat-card"><div><div class="stat-label">ğŸ“Š ì „ì²´ ë¬¸ì œ</div></div><div class="stat-value">${s.correct}/${s.total}</div></div>
    <div class="stat-section-title">ğŸ“… ì´ë²ˆ ì£¼ / Tuan nay</div>
    <div class="stat-card"><div><div class="stat-label">ì •ë‹µë¥ </div></div><div class="stat-value">${wAcc}% (${ws.c}/${ws.t})</div></div>
    <div class="stat-section-title">ğŸ“… ì´ë²ˆ ë‹¬ / Thang nay</div>
    <div class="stat-card"><div><div class="stat-label">ì •ë‹µë¥ </div></div><div class="stat-value">${mAcc}% (${ms.c}/${ms.t})</div></div>
  `;
}

// ==================== EXPENSES ====================
function selectPayment(type) {
  selectedPayment=type;
  document.getElementById('pay-cash').classList.toggle('selected',type==='cash');
  document.getElementById('pay-card').classList.toggle('selected',type==='card');
}
function showVndPreview() {
  const v=parseInt(document.getElementById('exp-amount').value)||0;
  document.getElementById('vnd-preview').textContent=v>0?`â‰ˆ ${fmt(toVnd(v))}â‚«`:'';
}
function addExpense() {
  const amount=parseInt(document.getElementById('exp-amount').value);
  const memo=document.getElementById('exp-memo').value.trim();
  const date=document.getElementById('exp-date').value;
  if(!amount||amount<=0){showToast('ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”!','error');return;}
  if(!date){showToast('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”!','error');return;}
  expenses.unshift({id:Date.now(),amount,payment:selectedPayment,category:selectedExpCat,memo,date});
  save(SK.expenses,expenses);
  document.getElementById('exp-amount').value='';
  document.getElementById('exp-memo').value='';
  document.getElementById('vnd-preview').textContent='';
  showToast('ì €ì¥ ì™„ë£Œ!','success');
  renderCalendar(); renderStats(); renderExpenseList(); renderBudgetAlert();
}
function deleteExpense(id) {
  if(!confirm('ì´ ì§€ì¶œì„ ì‚­ì œí• ê¹Œìš”?'))return;
  expenses=expenses.filter(e=>e.id!==id); save(SK.expenses,expenses);
  renderCalendar(); renderStats(); renderExpenseList(); renderBudgetAlert();
  showToast('ì‚­ì œ ì™„ë£Œ!','success');
}
function openExpenseEditModal(id) {
  const e=expenses.find(x=>x.id===id); if(!e)return;
  document.getElementById('edit-exp-amount').value=e.amount;
  document.getElementById('edit-exp-memo').value=e.memo;
  document.getElementById('edit-exp-date').value=e.date;
  document.getElementById('edit-exp-cat').value=e.category;
  document.getElementById('edit-exp-id').value=e.id;
  selectEditPayment(e.payment);
  document.getElementById('expense-edit-modal').classList.add('show');
}
function closeExpenseEditModal(){document.getElementById('expense-edit-modal').classList.remove('show');}
function selectEditPayment(type) {
  editPayment=type;
  document.getElementById('edit-pay-cash').classList.toggle('selected',type==='cash');
  document.getElementById('edit-pay-card').classList.toggle('selected',type==='card');
}
function saveEditExpense() {
  const id=Number(document.getElementById('edit-exp-id').value);
  const idx=expenses.findIndex(e=>e.id===id); if(idx<0)return;
  expenses[idx].amount=parseInt(document.getElementById('edit-exp-amount').value)||0;
  expenses[idx].payment=editPayment;
  expenses[idx].category=document.getElementById('edit-exp-cat').value;
  expenses[idx].memo=document.getElementById('edit-exp-memo').value.trim();
  expenses[idx].date=document.getElementById('edit-exp-date').value;
  save(SK.expenses,expenses); closeExpenseEditModal();
  renderCalendar(); renderStats(); renderExpenseList(); closeDayModal();
  showToast('ìˆ˜ì • ì™„ë£Œ!','success');
}

// ==================== CALENDAR ====================
function changeMonth(d){calMonth+=d;if(calMonth<0){calMonth=11;calYear--;}if(calMonth>11){calMonth=0;calYear++;}renderCalendar();}
function renderCalendar() {
  const label=document.getElementById('cal-month-label');
  const grid=document.getElementById('calendar-grid');
  const mn=['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'];
  label.textContent=`${calYear}ë…„ ${mn[calMonth]}`;
  const dh=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  let html=dh.map(d=>`<div class="cal-header">${d}</div>`).join('');
  const fd=new Date(calYear,calMonth,1).getDay();
  const dim=new Date(calYear,calMonth+1,0).getDate();
  const pd=new Date(calYear,calMonth,0).getDate();
  const dt={};
  expenses.forEach(e=>{const[ey,em]=e.date.split('-').map(Number);if(ey===calYear&&em===calMonth+1){const d=parseInt(e.date.split('-')[2]);dt[d]=(dt[d]||0)+e.amount;}});
  const td=new Date();const itm=td.getFullYear()===calYear&&td.getMonth()===calMonth;
  for(let i=0;i<fd;i++){html+=`<div class="cal-day other-month">${pd-fd+1+i}</div>`;}
  for(let d=1;d<=dim;d++){
    const it=itm&&d===td.getDate();
    const ds=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const t=dt[d];
    html+=`<div class="cal-day ${it?'today':''}" onclick="showDayDetail('${ds}')">${d}${t?`<div class="cal-amount">${t>=1000000?(t/1000000).toFixed(1)+'M':t>=1000?Math.round(t/1000)+'K':t}</div>`:''}</div>`;
  }
  const rem=7-((fd+dim)%7);if(rem<7){for(let i=1;i<=rem;i++){html+=`<div class="cal-day other-month">${i}</div>`;}}
  grid.innerHTML=html;
}
function showDayDetail(dateStr) {
  const de=expenses.filter(e=>e.date===dateStr);
  const modal=document.getElementById('day-modal');
  const parts=dateStr.split('-');
  document.getElementById('day-modal-title').textContent=`ğŸ“… ${parts[1]}/${parts[2]} ì§€ì¶œ ìƒì„¸`;
  const content=document.getElementById('day-modal-content');
  if(de.length===0){content.innerHTML='<div class="empty-state"><span class="emoji">ğŸ’¸</span><p>ì§€ì¶œì´ ì—†ìŠµë‹ˆë‹¤.</p></div>';}
  else{
    const total=de.reduce((s,e)=>s+e.amount,0);
    content.innerHTML=`
      <div style="text-align:center;margin-bottom:12px;">
        <span style="font-size:22px;font-weight:700;color:var(--primary);">${dualCurrency(total)}</span>
      </div>
      ${de.map(e=>`
        <div class="expense-item">
          <div class="expense-item-icon">${EXP_CATS[e.category]?.icon||'ğŸ“¦'}</div>
          <div class="expense-item-info">
            <div class="expense-item-cat">${EXP_CATS[e.category]?.ko||'ê¸°íƒ€'}</div>
            <div class="expense-item-memo">${esc(e.memo)||'-'}</div>
          </div>
          <div>
            <div class="expense-item-amount">${fmt(e.amount)}â‚©</div>
            <div class="expense-item-sub">${fmt(toVnd(e.amount))}â‚« | ${e.payment==='cash'?'ğŸ’µ':'ğŸ’³'}</div>
          </div>
          <div class="expense-item-actions">
            <button class="icon-btn" onclick="openExpenseEditModal(${e.id})">âœï¸</button>
            <button class="icon-btn" onclick="deleteExpense(${e.id});closeDayModal();">ğŸ—‘ï¸</button>
          </div>
        </div>`).join('')}`;
  }
  modal.classList.add('show');
}
function closeDayModal(){document.getElementById('day-modal').classList.remove('show');}

// ==================== STATS ====================
function renderStats() {
  const container=document.getElementById('stats-container');
  const today=todayStr();
  const mk=calYear+'-'+String(calMonth+1).padStart(2,'0');
  const me=expenses.filter(e=>e.date.startsWith(mk));
  const te=expenses.filter(e=>e.date===today);
  const tt=te.reduce((s,e)=>s+e.amount,0);
  const mt=me.reduce((s,e)=>s+e.amount,0);
  const ct=me.filter(e=>e.payment==='cash').reduce((s,e)=>s+e.amount,0);
  const cdt=me.filter(e=>e.payment==='card').reduce((s,e)=>s+e.amount,0);
  const catT={};me.forEach(e=>{catT[e.category]=(catT[e.category]||0)+e.amount;});
  const maxC=Math.max(...Object.values(catT),1);
  const budget=load(SK.budget);
  const mn=['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'];
  const colors={food:'#e8836d',transport:'#42a5f5',shopping:'#ab47bc',living:'#66bb6a',cafe:'#8d6e63',health:'#26a69a',other:'#ffa726'};

  let budgetHtml='';
  if(budget&&budget.amount){
    const pct=Math.round((mt/budget.amount)*100);
    budgetHtml=`
      <div class="stat-section-title">ğŸ’° ì˜ˆì‚° / Ngan sach</div>
      <div class="stat-card"><div><div class="stat-label">ì›” ì˜ˆì‚°</div></div><div class="stat-value">${dualCurrency(budget.amount)}</div></div>
      <div style="padding:0 4px;">
        <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;">
          <span>ì‚¬ìš©: ${fmt(mt)}â‚©</span><span>${pct}%</span>
        </div>
        <div class="budget-bar"><div class="budget-fill ${pct>100?'over':''}" style="width:${Math.min(pct,100)}%"></div></div>
        <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">ë‚¨ì€ ì˜ˆì‚°: ${dualCurrency(Math.max(budget.amount-mt,0))}</div>
      </div>`;
  }

  container.innerHTML=`
    <div class="stat-card"><div><div class="stat-label">ğŸ“… ì˜¤ëŠ˜ ì§€ì¶œ</div></div><div><div class="stat-value" style="color:var(--primary);">${fmt(tt)}â‚©</div><div class="stat-sub">${fmt(toVnd(tt))}â‚«</div></div></div>
    <div class="stat-card"><div><div class="stat-label">ğŸ“Š ${mn[calMonth]} ì „ì²´</div></div><div><div class="stat-value">${fmt(mt)}â‚©</div><div class="stat-sub">${fmt(toVnd(mt))}â‚«</div></div></div>
    <div class="stat-card"><div><div class="stat-label">ğŸ’µ í˜„ê¸ˆ</div></div><div><div class="stat-value" style="color:#66bb6a;">${fmt(ct)}â‚©</div><div class="stat-sub">${fmt(toVnd(ct))}â‚«</div></div></div>
    <div class="stat-card"><div><div class="stat-label">ğŸ’³ ì¹´ë“œ</div></div><div><div class="stat-value" style="color:#42a5f5;">${fmt(cdt)}â‚©</div><div class="stat-sub">${fmt(toVnd(cdt))}â‚«</div></div></div>
    ${budgetHtml}
    <div class="stat-section-title">ğŸ“‚ ì¹´í…Œê³ ë¦¬ë³„</div>
    ${Object.entries(catT).sort((a,b)=>b[1]-a[1]).map(([cat,total])=>{
      const c=EXP_CATS[cat]||EXP_CATS.other;
      return `<div class="stat-bar-group"><div class="stat-bar-label"><span>${c.icon} ${c.ko}</span><span>${dualCurrency(total)}</span></div><div class="stat-bar"><div class="stat-bar-fill" style="width:${(total/maxC)*100}%;background:${colors[cat]||'#999'}"></div></div></div>`;
    }).join('')}
  `;
}

// ==================== EXPENSE LIST ====================
function renderExpenseList() {
  const container=document.getElementById('expense-list-container');
  if(expenses.length===0){container.innerHTML='<div class="empty-state"><span class="emoji">ğŸ’°</span><p>ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>';return;}
  const grouped={};expenses.forEach(e=>{if(!grouped[e.date])grouped[e.date]=[];grouped[e.date].push(e);});
  const sorted=Object.keys(grouped).sort((a,b)=>b.localeCompare(a));
  container.innerHTML=sorted.map(date=>{
    const dayT=grouped[date].reduce((s,e)=>s+e.amount,0);
    const p=date.split('-');
    const dn=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][new Date(date).getDay()];
    return `<div class="expense-date-group">
      <div class="expense-date-label">${p[1]}/${p[2]} (${dn}) â€” ${dualCurrency(dayT)}</div>
      ${grouped[date].map(e=>`
        <div class="expense-item">
          <div class="expense-item-icon">${EXP_CATS[e.category]?.icon||'ğŸ“¦'}</div>
          <div class="expense-item-info">
            <div class="expense-item-cat">${EXP_CATS[e.category]?.ko||'ê¸°íƒ€'}</div>
            <div class="expense-item-memo">${esc(e.memo)||'-'}</div>
          </div>
          <div>
            <div class="expense-item-amount">${fmt(e.amount)}â‚©</div>
            <div class="expense-item-sub">${fmt(toVnd(e.amount))}â‚« | ${e.payment==='cash'?'ğŸ’µ':'ğŸ’³'}</div>
          </div>
          <div class="expense-item-actions">
            <button class="icon-btn" onclick="openExpenseEditModal(${e.id})">âœï¸</button>
            <button class="icon-btn" onclick="deleteExpense(${e.id})">ğŸ—‘ï¸</button>
          </div>
        </div>`).join('')}
    </div>`;
  }).join('');
}

// ==================== SETTINGS / BACKUP ====================
function backupData() {
  const data={version:2,date:todayStr(),words,expenses,quizStats,budget:load(SK.budget),rate:load(SK.rate)};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`uridul-backup-${todayStr()}.json`;a.click();
  showToast('ë°±ì—… ì™„ë£Œ!','success');
}
function restoreData(event) {
  const file=event.target.files[0]; if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const data=JSON.parse(e.target.result);
      if(data.words)save(SK.words,data.words);
      if(data.expenses)save(SK.expenses,data.expenses);
      if(data.quizStats)save(SK.quizStats,data.quizStats);
      if(data.budget)save(SK.budget,data.budget);
      if(data.rate)save(SK.rate,data.rate);
      words=data.words||[];expenses=data.expenses||[];quizStats=data.quizStats||quizStats;
      showToast('ë³µì› ì™„ë£Œ! ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.','success');
      setTimeout(()=>location.reload(),1000);
    }catch{showToast('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.','error');}
  };
  reader.readAsText(file);
  event.target.value='';
}
function deleteAllData() {
  if(!confirm('ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?\nXoa tat ca du lieu?'))return;
  if(!confirm('ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤! ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  Object.values(SK).forEach(k=>localStorage.removeItem(k));
  localStorage.removeItem('uridul_practice');
  showToast('ì „ì²´ ì‚­ì œ ì™„ë£Œ!','success');
  setTimeout(()=>location.reload(),1000);
}

// ==================== MODALS ====================
function closeModal(id){document.getElementById(id).classList.remove('show');}
document.querySelectorAll('.modal-overlay').forEach(m=>{m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('show');});});

// ==================== SWIPE ====================
let touchSX=0;
document.addEventListener('touchstart',e=>{touchSX=e.changedTouches[0].screenX;},{passive:true});
document.addEventListener('touchend',e=>{
  const diff=touchSX-e.changedTouches[0].screenX;
  if(Math.abs(diff)<80)return;
  const tabs=['tab-dictionary','tab-quiz','tab-expenses','tab-settings'];
  const ci=tabs.findIndex(t=>document.getElementById(t).classList.contains('active'));
  if(diff>0&&ci<tabs.length-1)switchTab(document.querySelector(`[data-tab="${tabs[ci+1]}"]`));
  else if(diff<0&&ci>0)switchTab(document.querySelector(`[data-tab="${tabs[ci-1]}"]`));
},{passive:true});

// ==================== OFFLINE ====================
function updateOnlineStatus(){document.getElementById('offline-banner').classList.toggle('show',!navigator.onLine);}
window.addEventListener('online',()=>{updateOnlineStatus();showToast('ì˜¨ë¼ì¸ ë³µê·€!','success');});
window.addEventListener('offline',()=>{updateOnlineStatus();showToast('ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤','error');});

// ==================== SAMPLE DATA ====================
function initSampleData() {
  const sw=[
    {id:1,vietnamese:'Xin chao',korean:'ì•ˆë…•í•˜ì„¸ìš”',pronunciation:'ì‹  ì§œì˜¤',example:'Xin chao ban! (ì¹œêµ¬ì—ê²Œ ì¸ì‚¬)',category:'greeting',difficulty:'easy',learned:false,learnedDate:null},
    {id:2,vietnamese:'Cam on',korean:'ê°ì‚¬í•©ë‹ˆë‹¤',pronunciation:'ê¹œ ì–¸',example:'Cam on ban rat nhieu! (ì •ë§ ê°ì‚¬í•©ë‹ˆë‹¤)',category:'greeting',difficulty:'easy',learned:false,learnedDate:null},
    {id:3,vietnamese:'Tam biet',korean:'ì•ˆë…•íˆ ê°€ì„¸ìš”',pronunciation:'ë•€ ë¹„ì—£',example:'Tam biet nhe! (ì˜ ê°€ìš”!)',category:'greeting',difficulty:'easy',learned:false,learnedDate:null},
    {id:4,vietnamese:'Xin loi',korean:'ì£„ì†¡í•©ë‹ˆë‹¤',pronunciation:'ì‹  ë¡œì´',example:'Xin loi, toi khong biet. (ì£„ì†¡í•´ìš”, ëª°ë¼ìš”)',category:'greeting',difficulty:'easy',learned:false,learnedDate:null},
    {id:5,vietnamese:'Vang',korean:'ë„¤',pronunciation:'ë¹™',example:'Vang, toi hieu. (ë„¤, ì´í•´í•´ìš”)',category:'greeting',difficulty:'easy',learned:false,learnedDate:null},
    {id:6,vietnamese:'Khong',korean:'ì•„ë‹ˆìš”',pronunciation:'ì½©',example:'Khong, cam on. (ì•„ë‹ˆìš”, ê´œì°®ì•„ìš”)',category:'greeting',difficulty:'easy',learned:false,learnedDate:null},
    {id:7,vietnamese:'Toi yeu ban',korean:'ì‚¬ë‘í•´ìš”',pronunciation:'ë˜ì´ ì´ì—ìš° ë°˜',example:'Anh yeu em. (ë‹¹ì‹ ì„ ì‚¬ë‘í•´ìš”)',category:'emotion',difficulty:'easy',learned:false,learnedDate:null},
    {id:8,vietnamese:'Pho',korean:'ìŒ€êµ­ìˆ˜',pronunciation:'í¼',example:'Toi muon an pho. (ìŒ€êµ­ìˆ˜ ë¨¹ê³  ì‹¶ì–´ìš”)',category:'food',difficulty:'easy',learned:false,learnedDate:null},
    {id:9,vietnamese:'Ca phe sua da',korean:'ì—°ìœ  ì•„ì´ìŠ¤ì»¤í”¼',pronunciation:'ê¹Œ í˜ ì“°ì–´ ë‹¤',example:'Cho toi mot ly ca phe sua da.',category:'food',difficulty:'normal',learned:false,learnedDate:null},
    {id:10,vietnamese:'Bao nhieu tien?',korean:'ì–¼ë§ˆì˜ˆìš”?',pronunciation:'ë°”ì˜¤ ë‹ˆì—ìš° ë ì—”',example:'Cai nay bao nhieu tien? (ì´ê²ƒ ì–¼ë§ˆì˜ˆìš”?)',category:'daily',difficulty:'normal',learned:false,learnedDate:null}
  ];
  save(SK.words, sw);
  const now=new Date();const y=now.getFullYear(),m=now.getMonth(),d=now.getDate();
  const se=[
    {id:11,amount:8000,payment:'cash',category:'food',memo:'ìŒ€êµ­ìˆ˜ / Pho',date:toDateStr(new Date(y,m,d))},
    {id:12,amount:15000,payment:'card',category:'transport',memo:'ê·¸ë© / Grab',date:toDateStr(new Date(y,m,d-1))},
    {id:13,amount:5000,payment:'cash',category:'cafe',memo:'ì¹´í˜ / Ca phe',date:toDateStr(new Date(y,m,d-1))}
  ];
  save(SK.expenses, se);
}

// ==================== MIGRATE ====================
function migrateData() {
  words.forEach(w=>{
    if(!w.category)w.category='other';
    if(!w.difficulty)w.difficulty='easy';
  });
  save(SK.words, words);
}

// ==================== INIT ====================
function initApp() {
  initTheme();
  const ver=localStorage.getItem(SK.version);
  if(!ver) {
    if(words.length===0&&expenses.length===0) initSampleData();
    else migrateData();
    localStorage.setItem(SK.version,'2');
  }
  words=load(SK.words)||[];
  expenses=load(SK.expenses)||[];
  quizStats=load(SK.quizStats)||{total:0,correct:0,streak:0,best:0,weekly:{},monthly:{}};
  const now=new Date();calYear=now.getFullYear();calMonth=now.getMonth();
  document.getElementById('exp-date').value=toDateStr(now);
  loadRate();
  renderExpCatGrid();
  renderMyWords();
  renderQuiz();
  renderCalendar();
  renderStats();
  renderExpenseList();
  renderBudgetAlert();
  updateRateDisplay();
  loadBudget();
  updateOnlineStatus();
  if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js').catch(()=>{});}
}
initApp();
</script>
</body>
</html>
