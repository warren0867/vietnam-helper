<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>ìš°ë¦¬ë“¤ / ChÃºng ta</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#e8836d">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<style>
:root{--primary:#e8836d;--primary-light:#ffd4cc;--primary-dark:#c9624d;--secondary:#ffc857;--secondary-light:#fff3d4;--accent:#7bc67e;--accent-light:#d4f5d5;--bg:#fef9f4;--card:#ffffff;--text:#4a3728;--text-secondary:#8b7355;--border:#f0e6dc;--danger:#e85d5d;--danger-light:#fde0e0;--shadow:0 2px 12px rgba(74,55,40,0.08);--radius:14px;--nav-height:64px;--header-height:56px}
[data-theme="dark"]{--primary:#e8836d;--primary-light:#3d2822;--primary-dark:#f09d8a;--secondary:#ffc857;--secondary-light:#2d2815;--accent:#7bc67e;--accent-light:#1a2d1b;--bg:#121218;--card:#1e1e2a;--text:#e8e0d8;--text-secondary:#a09888;--border:#2e2e3e;--danger:#ef5350;--danger-light:#2d1515;--shadow:0 2px 12px rgba(0,0,0,0.3)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-tap-highlight-color:transparent;overflow-x:hidden;transition:background .3s,color .3s}
#app-header{position:fixed;top:0;left:0;right:0;height:var(--header-height);background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;z-index:100;box-shadow:0 2px 8px rgba(232,131,109,.3)}
#app-header .header-sub{font-size:11px;font-weight:400;opacity:.85;margin-top:1px}
#header-title{text-align:center}
#app-content{margin-top:var(--header-height);margin-bottom:var(--nav-height);padding:12px 16px 20px;min-height:calc(100vh - var(--header-height) - var(--nav-height))}
.tab-content{display:none;animation:fadeIn .25s ease}.tab-content.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
#bottom-nav{position:fixed;bottom:0;left:0;right:0;height:var(--nav-height);background:var(--card);display:flex;border-top:1px solid var(--border);z-index:100;padding-bottom:env(safe-area-inset-bottom,0);transition:background .3s}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;color:var(--text-secondary);cursor:pointer;transition:all .2s;border:none;background:none}
.nav-item .nav-icon{font-size:22px;margin-bottom:2px}.nav-item.active{color:var(--primary)}.nav-item.active .nav-icon{transform:scale(1.15)}.nav-item .nav-label{font-weight:600}
.card{background:var(--card);border-radius:var(--radius);padding:16px;margin-bottom:12px;box-shadow:var(--shadow);border:1px solid var(--border);transition:transform .15s,background .3s}
.card:active{transform:scale(.985)}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 20px;border-radius:10px;border:none;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s}
.btn-primary{background:var(--primary);color:#fff}.btn-primary:active{background:var(--primary-dark)}
.btn-secondary{background:var(--secondary-light);color:var(--text)}.btn-danger{background:var(--danger-light);color:var(--danger)}
.btn-accent{background:var(--accent);color:#fff}.btn-full{width:100%}.btn-sm{padding:6px 12px;font-size:12px;border-radius:8px}.btn:disabled{opacity:.5;pointer-events:none}
.btn-outline{background:transparent;border:1.5px solid var(--primary);color:var(--primary)}
.input-group{margin-bottom:14px}
.input-group label{display:block;font-size:13px;font-weight:600;margin-bottom:6px;color:var(--text-secondary)}
.input-group input,.input-group select,.input-group textarea{width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:10px;font-size:15px;background:var(--bg);color:var(--text);outline:none;transition:border-color .2s,background .3s}
.input-group input:focus,.input-group select:focus,.input-group textarea:focus{border-color:var(--primary)}
.input-group textarea{resize:vertical;min-height:50px}
.progress-bar{width:100%;height:10px;background:var(--border);border-radius:5px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),#4caf50);border-radius:5px;transition:width .5s ease}
.search-bar{display:flex;gap:8px;margin-bottom:14px}
.search-bar input{flex:1;padding:10px 14px;border:1.5px solid var(--border);border-radius:10px;font-size:15px;background:var(--card);color:var(--text);outline:none;transition:background .3s}
.search-bar input:focus{border-color:var(--primary)}
.fab{width:44px;height:44px;border-radius:12px;background:var(--primary);color:#fff;border:none;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 3px 10px rgba(232,131,109,.3)}
.word-card{position:relative}.word-card-header{display:flex;justify-content:space-between;align-items:flex-start}
.word-viet{font-size:20px;font-weight:700;color:var(--primary-dark);display:flex;align-items:center;gap:8px}
.word-korean{font-size:17px;font-weight:600;margin-top:4px}.word-pron{font-size:13px;color:var(--text-secondary);margin-top:3px}
.word-example{font-size:13px;color:var(--text-secondary);margin-top:8px;padding:8px 10px;background:var(--secondary-light);border-radius:8px;line-height:1.5}
.word-actions{display:flex;gap:6px;margin-top:10px;justify-content:flex-end}
.icon-btn{width:34px;height:34px;border-radius:8px;border:none;background:var(--bg);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .15s}
.icon-btn:active{background:var(--border)}
.speak-btn{background:none;border:none;font-size:20px;cursor:pointer}.speak-btn:active{transform:scale(1.2)}
.learn-check{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--text-secondary);cursor:pointer}
.learn-check input[type="checkbox"]{width:20px;height:20px;accent-color:var(--accent)}
.badges{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
.badge{padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600;display:flex;align-items:center;gap:4px}
.badge.earned{background:var(--secondary-light);color:#b8860b}.badge.locked{background:var(--border);color:#bbb}
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.4);z-index:200;justify-content:center;align-items:flex-end;animation:fadeIn .2s}
.modal-overlay.show{display:flex}
.modal-content{background:var(--card);border-radius:20px 20px 0 0;padding:24px 20px;width:100%;max-height:85vh;overflow-y:auto;animation:slideUp .3s ease;transition:background .3s}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}.modal-header h3{font-size:18px}
.modal-close{width:32px;height:32px;border-radius:50%;border:none;background:var(--bg);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text)}
.quiz-status{text-align:center;padding:30px 10px}
.quiz-status .emoji{font-size:60px;display:block;margin-bottom:16px}
.quiz-question-card{text-align:center;padding:20px}
.quiz-progress{font-size:13px;color:var(--text-secondary);margin-bottom:16px}
.quiz-word{font-size:28px;font-weight:700;color:var(--primary-dark);margin:20px 0}
.quiz-prompt{font-size:14px;color:var(--text-secondary);margin-bottom:20px}
.quiz-options{display:flex;flex-direction:column;gap:10px}
.quiz-option{padding:14px 16px;border-radius:12px;border:2px solid var(--border);background:var(--card);font-size:16px;cursor:pointer;text-align:left;transition:all .2s;color:var(--text)}
.quiz-option:active{transform:scale(.98)}
.quiz-option.correct{border-color:var(--accent);background:var(--accent-light)}
.quiz-option.wrong{border-color:var(--danger);background:var(--danger-light)}
.quiz-option.disabled{pointer-events:none}
.quiz-result{text-align:center;padding:20px}
.quiz-score{font-size:48px;font-weight:800;color:var(--primary);margin:10px 0}
.sub-tabs{display:flex;gap:4px;margin-bottom:16px;background:var(--border);border-radius:12px;padding:3px}
.sub-tab{flex:1;padding:8px 4px;border-radius:10px;border:none;background:none;font-size:12px;font-weight:600;color:var(--text-secondary);cursor:pointer;transition:all .2s}
.sub-tab.active{background:var(--card);color:var(--primary);box-shadow:0 1px 4px rgba(0,0,0,.08)}
.sub-content{display:none;animation:fadeIn .2s}.sub-content.active{display:block}
.radio-group{display:flex;gap:10px}
.radio-label{flex:1;padding:10px;border:2px solid var(--border);border-radius:10px;text-align:center;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s}
.radio-label.selected{border-color:var(--primary);background:var(--primary-light)}.radio-label input{display:none}
.category-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.cat-btn{padding:8px 4px;border:2px solid var(--border);border-radius:10px;background:var(--card);font-size:11px;cursor:pointer;text-align:center;transition:all .2s;color:var(--text)}
.cat-btn.selected{border-color:var(--primary);background:var(--primary-light)}
.cat-btn .cat-icon{font-size:20px;display:block;margin-bottom:1px}
.calendar-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}.calendar-nav h3{font-size:16px}
.cal-nav-btn{width:36px;height:36px;border-radius:50%;border:none;background:var(--bg);font-size:18px;cursor:pointer;color:var(--text)}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.cal-header{text-align:center;font-size:11px;font-weight:700;color:var(--text-secondary);padding:6px 0}
.cal-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:13px;border-radius:10px;cursor:pointer;transition:background .15s;padding:2px}
.cal-day:active{background:var(--primary-light)}.cal-day.today{background:var(--primary-light);font-weight:700}.cal-day.other-month{opacity:.3}
.cal-day .cal-amount{font-size:8px;color:var(--primary);font-weight:600;margin-top:1px;overflow:hidden;text-overflow:ellipsis;width:100%;text-align:center}
.stat-card{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:var(--card);border-radius:12px;margin-bottom:8px;border:1px solid var(--border);transition:background .3s}
.stat-label{font-size:13px;color:var(--text-secondary)}.stat-value{font-size:18px;font-weight:700}.stat-sub{font-size:11px;color:var(--text-secondary);margin-top:2px}
.stat-section-title{font-size:14px;font-weight:700;margin:18px 0 8px;color:var(--text-secondary)}
.stat-bar-group{margin-bottom:8px}.stat-bar-label{display:flex;justify-content:space-between;font-size:12px;margin-bottom:3px}
.stat-bar{height:8px;background:var(--border);border-radius:4px;overflow:hidden}.stat-bar-fill{height:100%;border-radius:4px;transition:width .5s ease}
.expense-date-group{margin-bottom:16px}.expense-date-label{font-size:13px;font-weight:700;color:var(--text-secondary);margin-bottom:6px;padding-left:4px}
.expense-item{display:flex;align-items:center;padding:12px 14px;background:var(--card);border-radius:12px;margin-bottom:6px;border:1px solid var(--border);transition:background .3s}
.expense-item-icon{font-size:24px;margin-right:12px}.expense-item-info{flex:1}.expense-item-cat{font-size:13px;font-weight:600}.expense-item-memo{font-size:11px;color:var(--text-secondary)}
.expense-item-amount{font-size:16px;font-weight:700;text-align:right}.expense-item-sub{font-size:10px;color:var(--text-secondary);text-align:right}
.expense-item-actions{display:flex;flex-direction:column;gap:4px;margin-left:8px}.expense-item-actions .icon-btn{width:28px;height:28px;font-size:13px}
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);padding:10px 20px;border-radius:10px;font-size:14px;z-index:300;color:#fff;white-space:nowrap;animation:toastIn .3s ease,toastOut .3s ease 1.7s forwards}
.toast-info{background:var(--text)}.toast-success{background:var(--accent)}.toast-error{background:var(--danger)}
@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(20px)}}
@keyframes toastOut{to{opacity:0;transform:translateX(-50%) translateY(-10px)}}
.empty-state{text-align:center;padding:40px 20px;color:var(--text-secondary)}.empty-state .emoji{font-size:48px;display:block;margin-bottom:12px}.empty-state p{font-size:14px;line-height:1.6}
.skeleton{background:linear-gradient(90deg,var(--border) 25%,var(--bg) 50%,var(--border) 75%);background-size:200% 100%;animation:skPulse 1.5s infinite;border-radius:8px;min-height:20px}
@keyframes skPulse{0%{background-position:200% 0}100%{background-position:-200% 0}}
.skeleton-card{padding:16px;margin-bottom:12px;border-radius:var(--radius)}.skeleton-line{height:14px;margin-bottom:10px;border-radius:4px}.skeleton-line.w60{width:60%}.skeleton-line.w80{width:80%}.skeleton-line.w40{width:40%}
.search-result-card{position:relative}
.search-result-card .add-btn{position:absolute;top:12px;right:12px;background:var(--secondary-light);border:none;width:40px;height:40px;border-radius:50%;font-size:22px;cursor:pointer;transition:transform .2s}
.search-result-card .add-btn:active{transform:scale(1.2)}.search-result-card .add-btn.added{background:var(--accent-light)}
.diff-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600}
.diff-easy{background:#d4f5d5;color:#2e7d32}.diff-normal{background:#fff3d4;color:#f57f17}.diff-hard{background:#fde0e0;color:#c62828}
[data-theme="dark"] .diff-easy{background:#1a2d1b;color:#66bb6a}[data-theme="dark"] .diff-normal{background:#2d2815;color:#ffa726}[data-theme="dark"] .diff-hard{background:#2d1515;color:#ef5350}
.word-cat-filter{display:flex;gap:6px;margin-bottom:14px;overflow-x:auto;padding-bottom:4px;-webkit-overflow-scrolling:touch}
.word-cat-filter::-webkit-scrollbar{display:none}
.filter-chip{padding:6px 12px;border-radius:20px;border:1.5px solid var(--border);background:var(--card);font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;transition:all .2s;color:var(--text)}
.filter-chip.active{border-color:var(--primary);background:var(--primary-light);color:var(--primary-dark)}
.setting-item{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid var(--border)}.setting-item:last-child{border-bottom:none}
.setting-label{font-size:14px;font-weight:600}.setting-desc{font-size:12px;color:var(--text-secondary);margin-top:2px}
.toggle-switch{width:50px;height:28px;border-radius:14px;background:var(--border);border:none;cursor:pointer;position:relative;transition:background .3s}
.toggle-switch.on{background:var(--accent)}
.toggle-switch::after{content:'';position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:50%;background:#fff;transition:transform .3s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
.toggle-switch.on::after{transform:translateX(22px)}
.budget-bar{height:12px;background:var(--border);border-radius:6px;overflow:hidden;margin:8px 0}
.budget-fill{height:100%;border-radius:6px;transition:width .5s;background:linear-gradient(90deg,var(--accent),#4caf50)}.budget-fill.over{background:linear-gradient(90deg,var(--danger),#ff7043)}
.budget-alert{background:var(--danger-light);color:var(--danger);padding:8px 12px;border-radius:8px;font-size:13px;font-weight:600;margin-bottom:12px}
.currency-display{font-size:12px;color:var(--text-secondary);margin-top:2px}
.offline-banner{position:fixed;top:var(--header-height);left:0;right:0;background:var(--danger);color:#fff;text-align:center;padding:6px;font-size:12px;font-weight:600;z-index:99;display:none}.offline-banner.show{display:block}
.recent-searches{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.recent-chip{padding:5px 10px;border-radius:16px;background:var(--secondary-light);font-size:12px;cursor:pointer;border:none;color:var(--text)}
.recent-chip:active{opacity:.7}
.quiz-mode-card{padding:20px;text-align:center;cursor:pointer;transition:transform .2s;border:2px solid var(--border)}
.quiz-mode-card:active{transform:scale(.97)}.quiz-mode-card.selected{border-color:var(--primary);background:var(--primary-light)}
.quiz-mode-icon{font-size:40px;display:block;margin-bottom:8px}
.quiz-mode-title{font-size:15px;font-weight:700;margin-bottom:4px}
.quiz-mode-desc{font-size:12px;color:var(--text-secondary)}
.wrong-word-item{display:flex;align-items:center;padding:12px;background:var(--card);border-radius:12px;margin-bottom:6px;border:1px solid var(--border)}
.wrong-word-info{flex:1}.wrong-word-count{font-size:12px;color:var(--danger);font-weight:700;margin-left:8px}
.csv-btn-group{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap}
.csv-btn{flex:1;min-width:100px;padding:10px;border-radius:10px;border:1.5px solid var(--border);background:var(--card);font-size:13px;font-weight:600;cursor:pointer;text-align:center;transition:all .2s;color:var(--text)}
.csv-btn:active{background:var(--primary-light)}
.tutorial-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:500;display:flex;align-items:center;justify-content:center;animation:fadeIn .3s}
.tutorial-card{background:var(--card);border-radius:20px;padding:30px 24px;margin:20px;max-width:360px;text-align:center}
.tutorial-card h2{font-size:22px;margin-bottom:8px}.tutorial-card p{font-size:14px;color:var(--text-secondary);line-height:1.6;margin:12px 0}
.tutorial-step{font-size:12px;color:var(--primary);margin-bottom:12px}
.wotd-card{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;border-radius:var(--radius);padding:20px;margin-bottom:14px;text-align:center;position:relative;overflow:hidden}
.wotd-card::before{content:'';position:absolute;top:-20px;right:-20px;width:80px;height:80px;border-radius:50%;background:rgba(255,255,255,.1)}
.wotd-label{font-size:12px;opacity:.8;margin-bottom:8px}.wotd-vi{font-size:24px;font-weight:700;margin-bottom:4px}.wotd-ko{font-size:18px;opacity:.9}.wotd-pron{font-size:13px;opacity:.7;margin-top:4px}
.chart-container{position:relative;width:180px;height:180px;margin:16px auto}
.chart-container canvas{width:100%!important;height:100%!important}
.chart-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.chart-center .big{font-size:28px;font-weight:800;color:var(--primary)}.chart-center .small{font-size:11px;color:var(--text-secondary)}
.quiz-source-group{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap}
.source-chip{padding:8px 14px;border-radius:10px;border:2px solid var(--border);background:var(--card);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;color:var(--text)}
.source-chip.active{border-color:var(--primary);background:var(--primary-light)}
.spinner{display:inline-block;width:20px;height:20px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.compare-box{background:var(--secondary-light);border-radius:12px;padding:14px;margin-top:12px}.compare-row{display:flex;justify-content:space-between;font-size:14px;padding:4px 0}.compare-diff{font-weight:700}
@media(min-width:480px){#app-content{max-width:480px;margin-left:auto;margin-right:auto}#bottom-nav{max-width:480px;left:50%;transform:translateX(-50%)}.modal-content{max-width:480px}}
</style>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>

<header id="app-header">
<div id="header-title">
<div>ìš°ë¦¬ë“¤ / ChÃºng ta</div>
<div class="header-sub" id="header-sub">Tá»« vá»±ng / ë‹¨ì–´ì¥</div>
</div>
</header>

<div class="offline-banner" id="offline-banner">Ngoáº¡i tuyáº¿n / ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤</div>

<div id="tutorial-overlay" class="tutorial-overlay" style="display:none">
<div class="tutorial-card">
<div id="tutorial-content"></div>
</div>
</div>

<main id="app-content">

<!-- ====== ë‹¨ì–´ì¥ TAB ====== -->
<section id="tab-dictionary" class="tab-content active">
<div id="wotd-container"></div>
<div class="sub-tabs">
<button class="sub-tab active" data-sub="dict-search" onclick="switchDictSub(this)">ğŸ” TÃ¬m kiáº¿m / ê²€ìƒ‰</button>
<button class="sub-tab" data-sub="dict-mywords" onclick="switchDictSub(this)">ğŸ“– Tá»« cá»§a tÃ´i / ë‚´ ë‹¨ì–´</button>
<button class="sub-tab" data-sub="dict-builtin" onclick="switchDictSub(this)">ğŸ“š Tá»« cÆ¡ báº£n / ê¸°ë³¸</button>
</div>

<div class="sub-content active" id="dict-search">
<div class="search-bar">
<input type="text" id="trans-search-input" placeholder="Nháº­p tiáº¿ng Viá»‡t... / ë² íŠ¸ë‚¨ì–´ ì…ë ¥..." oninput="onTransSearch(this.value)">
</div>
<div id="recent-searches"></div>
<div id="trans-loading" style="display:none">
<div class="card skeleton-card"><div class="skeleton skeleton-line w80"></div><div class="skeleton skeleton-line w60"></div><div class="skeleton skeleton-line w40"></div></div>
</div>
<div id="trans-results"></div>
<div id="trans-empty" class="empty-state">
<span class="emoji">ğŸ”</span>
<p>Nháº­p tiáº¿ng Viá»‡t Ä‘á»ƒ tÃ¬m nghÄ©a tiáº¿ng HÃ n<br>ë² íŠ¸ë‚¨ì–´ë¥¼ ì…ë ¥í•˜ë©´ í•œêµ­ì–´ ëœ»ì´ ë‚˜ì˜µë‹ˆë‹¤</p>
</div>
</div>

<div class="sub-content" id="dict-mywords">
<div class="card" id="progress-card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
<span style="font-size:14px;font-weight:700;">ğŸ“Š Tiáº¿n Ä‘á»™ / í•™ìŠµ ì§„ë„</span>
<span id="progress-text" style="font-size:13px;color:var(--accent);font-weight:700;">0%</span>
</div>
<div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
<div id="progress-detail" style="font-size:12px;color:var(--text-secondary);margin-top:6px;"></div>
<div class="badges" id="badges-container"></div>
</div>
<div class="csv-btn-group">
<button class="csv-btn" onclick="document.getElementById('csv-file').click()">ğŸ“¥ Nháº­p CSV / ê°€ì ¸ì˜¤ê¸°</button>
<button class="csv-btn" onclick="exportCSV()">ğŸ“¤ Xuáº¥t CSV / ë‚´ë³´ë‚´ê¸°</button>
<button class="csv-btn" onclick="downloadSampleCSV()">ğŸ“„ Máº«u / ìƒ˜í”Œ</button>
</div>
<input type="file" id="csv-file" accept=".csv" style="display:none" onchange="importCSV(event)">
<div class="word-cat-filter" id="word-cat-filter"></div>
<div class="search-bar">
<input type="text" id="word-search-input" placeholder="ğŸ” TÃ¬m tá»«... / ë‹¨ì–´ ê²€ìƒ‰..." oninput="renderMyWords()">
<button class="fab" onclick="openWordModal()">+</button>
</div>
<div id="word-list"></div>
</div>

<div class="sub-content" id="dict-builtin">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
<span style="font-size:14px;font-weight:700;">ğŸ“š 500 tá»« cÆ¡ báº£n TOPIK / ê¸°ë³¸ 500ë‹¨ì–´</span>
<span id="builtin-count" style="font-size:13px;color:var(--text-secondary);">500ê°œ</span>
</div>
<div class="word-cat-filter" id="builtin-cat-filter"></div>
<div class="search-bar">
<input type="text" id="builtin-search-input" placeholder="ğŸ” TÃ¬m tá»« cÆ¡ báº£n..." oninput="renderBuiltinWords()">
</div>
<div id="builtin-word-list"></div>
</div>
</section>

<!-- ====== í€´ì¦ˆ TAB ====== -->
<section id="tab-quiz" class="tab-content">
<div id="quiz-main"></div>
</section>

<!-- ====== ìƒí™œë¹„ TAB ====== -->
<section id="tab-expenses" class="tab-content">
<div class="sub-tabs">
<button class="sub-tab active" data-sub="exp-input" onclick="switchExpSub(this)">âœï¸ Nháº­p / ì…ë ¥</button>
<button class="sub-tab" data-sub="exp-calendar" onclick="switchExpSub(this)">ğŸ“… Lá»‹ch / ë‹¬ë ¥</button>
<button class="sub-tab" data-sub="exp-stats" onclick="switchExpSub(this)">ğŸ“Š Thá»‘ng kÃª / í†µê³„</button>
<button class="sub-tab" data-sub="exp-list" onclick="switchExpSub(this)">ğŸ“‹ DS / ëª©ë¡</button>
</div>
<div id="budget-alert-container"></div>
<div class="sub-content active" id="exp-input">
<div class="card">
<div class="input-group">
<label>ğŸ’° Sá»‘ tiá»n (KRW) / ê¸ˆì•¡ (ì›)</label>
<input type="number" id="exp-amount" placeholder="Nháº­p sá»‘ tiá»n..." inputmode="numeric" oninput="showVndPreview()">
<div class="currency-display" id="vnd-preview"></div>
</div>
<div class="input-group">
<label>ğŸ’³ PhÆ°Æ¡ng thá»©c / ê²°ì œ ìˆ˜ë‹¨</label>
<div class="radio-group">
<label class="radio-label selected" id="pay-cash" onclick="selectPayment('cash')"><input type="radio" name="payment" value="cash" checked>ğŸ’µ Tiá»n máº·t / í˜„ê¸ˆ</label>
<label class="radio-label" id="pay-card" onclick="selectPayment('card')"><input type="radio" name="payment" value="card">ğŸ’³ Tháº» / ì¹´ë“œ</label>
</div>
</div>
<div class="input-group">
<label>ğŸ“‚ Danh má»¥c / ì¹´í…Œê³ ë¦¬</label>
<div class="category-grid" id="exp-cat-grid"></div>
</div>
<div class="input-group">
<label>ğŸ“ Ghi chÃº / ë©”ëª¨</label>
<input type="text" id="exp-memo" placeholder="Ghi chÃº...">
</div>
<div class="input-group">
<label>ğŸ“… NgÃ y / ë‚ ì§œ</label>
<input type="date" id="exp-date">
</div>
<button class="btn btn-primary btn-full" onclick="addExpense()" style="margin-top:6px;">LÆ°u / ì €ì¥ âœ…</button>
</div>
</div>
<div class="sub-content" id="exp-calendar">
<div class="card">
<div class="calendar-nav">
<button class="cal-nav-btn" onclick="changeMonth(-1)">â—€</button>
<h3 id="cal-month-label"></h3>
<button class="cal-nav-btn" onclick="changeMonth(1)">â–¶</button>
</div>
<div class="calendar-grid" id="calendar-grid"></div>
</div>
</div>
<div class="sub-content" id="exp-stats"><div id="stats-container"></div></div>
<div class="sub-content" id="exp-list"><div id="expense-list-container"></div></div>
</section>

<!-- ====== ì„¤ì • TAB ====== -->
<section id="tab-settings" class="tab-content">
<div class="card">
<h3 style="margin-bottom:14px;">âš™ï¸ CÃ i Ä‘áº·t / ì„¤ì •</h3>
<div class="setting-item">
<div><div class="setting-label">ğŸŒ™ Cháº¿ Ä‘á»™ tá»‘i / ë‹¤í¬ëª¨ë“œ</div><div class="setting-desc">Tá»± Ä‘á»™ng / ì‹œìŠ¤í…œ ìë™ê°ì§€</div></div>
<button class="toggle-switch" id="theme-toggle" onclick="toggleTheme()"></button>
</div>
<div class="setting-item">
<div><div class="setting-label">ğŸ”Š Tá»± phÃ¡t Ã¢m / ìë™ ë°œìŒ</div><div class="setting-desc">PhÃ¡t Ã¢m tá»± Ä‘á»™ng khi tráº£ lá»i / ì •ë‹µ ì‹œ ìë™ ë°œìŒ</div></div>
<button class="toggle-switch" id="autoplay-toggle" onclick="toggleAutoplay()"></button>
</div>
<div class="setting-item">
<div><div class="setting-label">ğŸ’± Tá»· giÃ¡ / í™˜ìœ¨</div><div class="setting-desc" id="rate-info">1â‚© = --â‚«</div></div>
<button class="btn btn-sm btn-secondary" onclick="openRateModal()">Äáº·t / ì„¤ì •</button>
</div>
<div class="setting-item">
<div><div class="setting-label">ğŸ’° NgÃ¢n sÃ¡ch / ì›” ì˜ˆì‚°</div><div class="setting-desc" id="budget-info">ChÆ°a Ä‘áº·t / ì„¤ì • ì•ˆë¨</div></div>
<button class="btn btn-sm btn-secondary" onclick="openBudgetModal()">Äáº·t / ì„¤ì •</button>
</div>
</div>
<div class="card">
<h3 style="margin-bottom:14px;">ğŸ’¾ Quáº£n lÃ½ dá»¯ liá»‡u / ë°ì´í„° ê´€ë¦¬</h3>
<div class="setting-item">
<div><div class="setting-label">ğŸ“¥ Sao lÆ°u / ë°±ì—…</div><div class="setting-desc">JSON download</div></div>
<button class="btn btn-sm btn-accent" onclick="backupData()">Sao lÆ°u / ë°±ì—…</button>
</div>
<div class="setting-item">
<div><div class="setting-label">ğŸ“¥ ì—‘ì…€ë¡œ ë‹¨ì–´ ì—…ë¡œë“œ</div><div class="setting-desc">Excel/CSV (.xlsx, .xls, .csv)</div></div>
<button class="btn btn-sm btn-secondary" onclick="document.getElementById('excel-file').click()">ì—…ë¡œë“œ</button>
<input type="file" id="excel-file" accept=".xlsx,.xls,.csv" style="display:none" onchange="importExcel(event)">
</div>
<div class="setting-item">
<div><div class="setting-label">ğŸ“¤ KhÃ´i phá»¥c / ë³µì›</div><div class="setting-desc">JSON upload</div></div>
<button class="btn btn-sm btn-secondary" onclick="document.getElementById('restore-file').click()">KhÃ´i phá»¥c / ë³µì›</button>
<input type="file" id="restore-file" accept=".json" style="display:none" onchange="restoreData(event)">
</div>
<div class="setting-item">
<div><div class="setting-label">ğŸ—‘ï¸ XÃ³a táº¥t cáº£ / ì „ì²´ ì‚­ì œ</div><div class="setting-desc">XÃ³a toÃ n bá»™ dá»¯ liá»‡u</div></div>
<button class="btn btn-sm btn-danger" onclick="deleteAllData()">XÃ³a / ì‚­ì œ</button>
</div>
</div>
<div class="card">
<h3 style="margin-bottom:14px;">ğŸ”— Chia sáº» / ì‹¤ì‹œê°„ ê³µìœ </h3>
<div class="setting-item">
<div><div class="setting-label">ğŸ“¡ Chia sáº» dá»¯ liá»‡u / ë°ì´í„° ê³µìœ </div><div class="setting-desc" id="share-status">ChÆ°a káº¿t ná»‘i / ë¯¸ì—°ê²°</div></div>
<button class="toggle-switch" id="share-toggle" onclick="toggleSharing()"></button>
</div>
<div id="share-config" style="display:none;padding-top:10px;">
<div class="input-group">
<label>ğŸ”‘ MÃ£ gia Ä‘Ã¬nh / ê°€ì¡± ì½”ë“œ</label>
<input type="text" id="family-code" placeholder="ì˜ˆ: uri-dul-family">
<div style="font-size:11px;color:var(--text-secondary);margin-top:4px;">ê°™ì€ ì½”ë“œë¥¼ ì…ë ¥í•˜ë©´ ë°ì´í„°ê°€ ê³µìœ ë©ë‹ˆë‹¤</div>
</div>
<div class="input-group">
<label>ğŸŒ Firebase URL</label>
<input type="text" id="firebase-url" placeholder="https://your-project.firebaseio.com">
<div style="font-size:11px;color:var(--text-secondary);margin-top:4px;">Firebase Realtime Database URLì„ ì…ë ¥í•˜ì„¸ìš”</div>
</div>
<button class="btn btn-primary btn-full" onclick="connectSharing()" style="margin-top:8px;">ì—°ê²°í•˜ê¸° / Káº¿t ná»‘i ğŸ”—</button>
<button class="btn btn-outline btn-full" onclick="disconnectSharing()" style="margin-top:6px;">ì—°ê²° í•´ì œ / Ngáº¯t káº¿t ná»‘i</button>
</div>
</div>
<div class="card">
<h3 style="margin-bottom:14px;">â„¹ï¸ ThÃ´ng tin / ì •ë³´</h3>
<div style="font-size:13px;color:var(--text-secondary);line-height:1.8;">
<div>ğŸ“± ìš°ë¦¬ë“¤ / ChÃºng ta v3.1</div>
<div>ğŸ‡»ğŸ‡³ğŸ‡°ğŸ‡· á»¨ng dá»¥ng há»c tiáº¿ng HÃ n / í•œêµ­ì–´ í•™ìŠµ ì•±</div>
<div>ğŸ“š 500 tá»« TOPIK cÆ¡ báº£n / TOPIK ê¸°ë³¸ 500ë‹¨ì–´</div>
</div>
</div>
</section>

</main>

<nav id="bottom-nav">
<button class="nav-item active" data-tab="tab-dictionary" onclick="switchTab(this)"><span class="nav-icon">ğŸ“š</span><span class="nav-label">Tá»« vá»±ng</span></button>
<button class="nav-item" data-tab="tab-quiz" onclick="switchTab(this)"><span class="nav-icon">ğŸ¯</span><span class="nav-label">CÃ¢u Ä‘á»‘</span></button>
<button class="nav-item" data-tab="tab-expenses" onclick="switchTab(this)"><span class="nav-icon">ğŸ’°</span><span class="nav-label">Chi phÃ­</span></button>
<button class="nav-item" data-tab="tab-settings" onclick="switchTab(this)"><span class="nav-icon">âš™ï¸</span><span class="nav-label">CÃ i Ä‘áº·t</span></button>
</nav>

<!-- Word Modal -->
<div class="modal-overlay" id="word-modal">
<div class="modal-content">
<div class="modal-header">
<h3 id="word-modal-title">ğŸ“ ThÃªm tá»« / ë‹¨ì–´ ì¶”ê°€</h3>
<button class="modal-close" onclick="closeWordModal()">âœ•</button>
</div>
<div class="input-group">
<label>ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t / ë² íŠ¸ë‚¨ì–´</label>
<input type="text" id="word-viet" placeholder="VD: Xin chÃ o">
</div>
<div class="input-group">
<label>ğŸ‡°ğŸ‡· Tiáº¿ng HÃ n / í•œêµ­ì–´</label>
<input type="text" id="word-korean" placeholder="VD: ì•ˆë…•í•˜ì„¸ìš”">
</div>
<div class="input-group">
<label>ğŸ—£ï¸ PhÃ¡t Ã¢m / ë°œìŒ</label>
<input type="text" id="word-pron" placeholder="VD: ì‹  ì§œì˜¤">
</div>
<div class="input-group">
<label>ğŸ’¬ VÃ­ dá»¥ / ì˜ˆë¬¸</label>
<textarea id="word-example" placeholder="VD: Xin chÃ o báº¡n!"></textarea>
</div>
<div class="input-group">
<label>ğŸ“‚ Danh má»¥c / ì¹´í…Œê³ ë¦¬</label>
<div class="category-grid" id="word-cat-grid"></div>
</div>
<div class="input-group">
<label>ğŸ“Š Äá»™ khÃ³ / ë‚œì´ë„</label>
<div class="radio-group" id="word-diff-group">
<label class="radio-label selected" onclick="selectWordDiff('easy')"><input type="radio" name="word-diff" value="easy" checked>Dá»… / ì‰¬ì›€</label>
<label class="radio-label" onclick="selectWordDiff('normal')"><input type="radio" name="word-diff" value="normal">TB / ë³´í†µ</label>
<label class="radio-label" onclick="selectWordDiff('hard')"><input type="radio" name="word-diff" value="hard">KhÃ³ / ì–´ë ¤ì›€</label>
</div>
</div>
<div class="input-group">
<label class="learn-check"><input type="checkbox" id="word-quiz-include" checked> ÄÆ°a vÃ o cÃ¢u Ä‘á»‘ / í€´ì¦ˆ í¬í•¨</label>
</div>
<input type="hidden" id="word-edit-id">
<button class="btn btn-primary btn-full" onclick="saveWord()" style="margin-top:4px;">LÆ°u / ì €ì¥ âœ…</button>
</div>
</div>

<!-- Day Detail Modal -->
<div class="modal-overlay" id="day-modal">
<div class="modal-content">
<div class="modal-header"><h3 id="day-modal-title">ğŸ“… Chi tiáº¿t</h3><button class="modal-close" onclick="closeDayModal()">âœ•</button></div>
<div id="day-modal-content"></div>
</div>
</div>

<!-- Expense Edit Modal -->
<div class="modal-overlay" id="expense-edit-modal">
<div class="modal-content">
<div class="modal-header"><h3>âœï¸ Sá»­a chi tiÃªu / ì§€ì¶œ ìˆ˜ì •</h3><button class="modal-close" onclick="closeExpenseEditModal()">âœ•</button></div>
<div class="input-group"><label>ğŸ’° Sá»‘ tiá»n (KRW)</label><input type="number" id="edit-exp-amount" inputmode="numeric"></div>
<div class="input-group"><label>ğŸ’³ PhÆ°Æ¡ng thá»©c</label>
<div class="radio-group">
<label class="radio-label" id="edit-pay-cash" onclick="selectEditPayment('cash')"><input type="radio" name="edit-payment" value="cash">ğŸ’µ Tiá»n máº·t</label>
<label class="radio-label" id="edit-pay-card" onclick="selectEditPayment('card')"><input type="radio" name="edit-payment" value="card">ğŸ’³ Tháº»</label>
</div></div>
<div class="input-group"><label>ğŸ“‚ Danh má»¥c</label><select id="edit-exp-cat"></select></div>
<div class="input-group"><label>ğŸ“ Ghi chÃº</label><input type="text" id="edit-exp-memo"></div>
<div class="input-group"><label>ğŸ“… NgÃ y</label><input type="date" id="edit-exp-date"></div>
<input type="hidden" id="edit-exp-id">
<button class="btn btn-primary btn-full" onclick="saveEditExpense()">HoÃ n thÃ nh âœ…</button>
</div>
</div>

<!-- Rate Modal -->
<div class="modal-overlay" id="rate-modal">
<div class="modal-content">
<div class="modal-header"><h3>ğŸ’± Tá»· giÃ¡ / í™˜ìœ¨ ì„¤ì •</h3><button class="modal-close" onclick="closeModal('rate-modal')">âœ•</button></div>
<div class="input-group"><label>1 KRW (â‚©) = ? VND (â‚«)</label><input type="number" id="rate-input" step="0.01" inputmode="decimal"></div>
<div style="display:flex;gap:8px;">
<button class="btn btn-secondary btn-full" onclick="fetchExchangeRate()">ğŸ”„ Cáº­p nháº­t / ì—…ë°ì´íŠ¸</button>
<button class="btn btn-primary btn-full" onclick="saveManualRate()">LÆ°u / ì €ì¥</button>
</div>
</div>
</div>

<!-- Budget Modal -->
<div class="modal-overlay" id="budget-modal">
<div class="modal-content">
<div class="modal-header"><h3>ğŸ’° NgÃ¢n sÃ¡ch / ì›” ì˜ˆì‚°</h3><button class="modal-close" onclick="closeModal('budget-modal')">âœ•</button></div>
<div class="input-group"><label>NgÃ¢n sÃ¡ch hÃ ng thÃ¡ng (KRW)</label><input type="number" id="budget-input" inputmode="numeric" placeholder="VD: 500000"></div>
<button class="btn btn-primary btn-full" onclick="saveBudget()">LÆ°u / ì €ì¥ âœ…</button>
</div>
</div>

<script>

// Categories: 0=greeting,1=food,2=family,3=emotion,4=number,5=shopping,6=transport,7=hospital,8=school,9=work,10=hobby,11=weather,12=time,13=place,14=action,15=adjective
// Difficulty: 0=easy,1=normal,2=hard
const BUILTIN_WORDS = [
// [vietnamese, korean, pronunciation(í•œêµ­ì–´ ë°œìŒì„ ë² íŠ¸ë‚¨ì‚¬ëŒì´ ì½ê¸° ì‰½ê²Œ), category_index, difficulty_index]

// ===== CATEGORY 0: GREETING (ì¸ì‚¬/ChÃ o há»i) - 30 words =====
['Xin chÃ o','ì•ˆë…•í•˜ì„¸ìš”','an-nyeong-ha-se-yo',0,0],
['Cáº£m Æ¡n','ê°ì‚¬í•©ë‹ˆë‹¤','gam-sa-ham-ni-da',0,0],
['Xin lá»—i','ì£„ì†¡í•©ë‹ˆë‹¤','joe-song-ham-ni-da',0,0],
['Táº¡m biá»‡t','ì•ˆë…•íˆ ê°€ì„¸ìš”','an-nyeong-hi ga-se-yo',0,0],
['Ráº¥t vui Ä‘Æ°á»£c gáº·p','ë§Œë‚˜ì„œ ë°˜ê°‘ìŠµë‹ˆë‹¤','man-na-seo ban-gap-seum-ni-da',0,1],
['TÃªn tÃ´i lÃ ...','ì œ ì´ë¦„ì€...','je i-reum-eun',0,0],
['Báº¡n khá»e khÃ´ng?','ì˜ ì§€ë‚´ì„¸ìš”?','jal ji-nae-se-yo',0,0],
['ChÃ o buá»•i sÃ¡ng','ì¢‹ì€ ì•„ì¹¨','jo-eun a-chim',0,0],
['Háº¹n gáº·p láº¡i','ë˜ ë§Œë‚˜ìš”','tto man-na-yo',0,0],
['KhÃ´ng cÃ³ gÃ¬','ì²œë§Œì—ìš”','cheon-man-e-yo',0,1],
['Xin chÃ o (thÃ¢n máº­t)','ì•ˆë…•','an-nyeong',0,0],
['LÃ¢u rá»“i khÃ´ng gáº·p','ì˜¤ëœë§Œì´ì—ìš”','o-raen-man-i-e-yo',0,1],
['ChÃºc má»«ng','ì¶•í•˜í•©ë‹ˆë‹¤','chu-ka-ham-ni-da',0,1],
['Xin há»i','ì‹¤ë¡€í•©ë‹ˆë‹¤','sil-lye-ham-ni-da',0,1],
['VÃ¢ng','ë„¤','ne',0,0],
['KhÃ´ng','ì•„ë‹ˆìš”','a-ni-yo',0,0],
['Cáº£m Æ¡n (thÃ¢n máº­t)','ê³ ë§ˆì›Œìš”','go-ma-wo-yo',0,0],
['Táº¡m biá»‡t (ngÆ°á»i á»Ÿ láº¡i)','ì•ˆë…•íˆ ê³„ì„¸ìš”','an-nyeong-hi gye-se-yo',0,1],
['ChÃ o buá»•i tá»‘i','ì¢‹ì€ ì €ë…','jo-eun jeo-nyeok',0,0],
['Ngá»§ ngon','ì˜ ììš”','jal ja-yo',0,0],
['ÄÃºng rá»“i','ë§ì•„ìš”','ma-ja-yo',0,0],
['TÃ´i hiá»ƒu rá»“i','ì•Œê² ìŠµë‹ˆë‹¤','al-get-seum-ni-da',0,1],
['TÃ´i khÃ´ng hiá»ƒu','ëª¨ë¥´ê² ì–´ìš”','mo-reu-ge-sseo-yo',0,1],
['Xin chá» má»™t chÃºt','ì ê¹ë§Œìš”','jam-kkan-man-yo',0,1],
['ChÃºc má»«ng nÄƒm má»›i','ìƒˆí•´ ë³µ ë§ì´ ë°›ìœ¼ì„¸ìš”','sae-hae bok ma-ni ba-deu-se-yo',0,2],
['Xin tá»± giá»›i thiá»‡u','ìê¸°ì†Œê°œë¥¼ í•˜ê² ìŠµë‹ˆë‹¤','ja-gi-so-gae-reul ha-get-seum-ni-da',0,2],
['Má»i vÃ o','ì–´ì„œ ì˜¤ì„¸ìš”','eo-seo o-se-yo',0,0],
['TÃ´i xin phÃ©p','ë¨¼ì € ê°€ë³´ê² ìŠµë‹ˆë‹¤','meon-jeo ga-bo-get-seum-ni-da',0,2],
['Báº¡n bao nhiÃªu tuá»•i?','ëª‡ ì‚´ì´ì—ìš”?','myeot sa-ri-e-yo',0,1],
['Báº¡n lÃ  ngÆ°á»i nÆ°á»›c nÃ o?','ì–´ëŠ ë‚˜ë¼ ì‚¬ëŒì´ì—ìš”?','eo-neu na-ra sa-ram-i-e-yo',0,2],

// ===== CATEGORY 1: FOOD (ìŒì‹/Thá»©c Äƒn) - 50 words =====
['CÆ¡m','ë°¥','bap',1,0],
['Phá»Ÿ','ìŒ€êµ­ìˆ˜','ssal-guk-su',1,0],
['Thá»‹t','ê³ ê¸°','go-gi',1,0],
['CÃ¡','ìƒì„ ','saeng-seon',1,0],
['Rau','ì±„ì†Œ','chae-so',1,0],
['TrÃ¡i cÃ¢y','ê³¼ì¼','gwa-il',1,0],
['NÆ°á»›c','ë¬¼','mul',1,0],
['TrÃ ','ì°¨','cha',1,0],
['CÃ  phÃª','ì»¤í”¼','keo-pi',1,0],
['Sá»¯a','ìš°ìœ ','u-yu',1,0],
['Trá»©ng','ë‹¬ê±€','dal-gyal',1,0],
['BÃ¡nh mÃ¬','ë¹µ','ppang',1,0],
['GÃ ','ë‹­','dak',1,0],
['Heo','ë¼ì§€','dwae-ji',1,0],
['BÃ²','ì†Œ','so',1,0],
['TÃ´m','ìƒˆìš°','sae-u',1,0],
['MÃ¬','êµ­ìˆ˜','guk-su',1,0],
['ÄÆ°á»ng','ì„¤íƒ•','seol-tang',1,0],
['Muá»‘i','ì†Œê¸ˆ','so-geum',1,0],
['á»št','ê³ ì¶”','go-chu',1,0],
['Tá»i','ë§ˆëŠ˜','ma-neul',1,0],
['HÃ nh','ì–‘íŒŒ','yang-pa',1,0],
['Khoai tÃ¢y','ê°ì','gam-ja',1,0],
['CÃ  chua','í† ë§ˆí† ','to-ma-to',1,0],
['DÆ°a chuá»™t','ì˜¤ì´','o-i',1,0],
['TÃ¡o','ì‚¬ê³¼','sa-gwa',1,0],
['Chuá»‘i','ë°”ë‚˜ë‚˜','ba-na-na',1,0],
['Cam','ì˜¤ë Œì§€','o-ren-ji',1,1],
['DÃ¢u tÃ¢y','ë”¸ê¸°','ttal-gi',1,0],
['DÆ°a háº¥u','ìˆ˜ë°•','su-bak',1,0],
['Nho','í¬ë„','po-do',1,0],
['ÄÃ o','ë³µìˆ­ì•„','bok-sung-a',1,1],
['Kim chi','ê¹€ì¹˜','gim-chi',1,0],
['Canh','êµ­','guk',1,0],
['ChÃ¡o','ì£½','juk',1,0],
['Äáº­u phá»¥','ë‘ë¶€','du-bu',1,1],
['Rong biá»ƒn','ê¹€','gim',1,1],
['TÆ°Æ¡ng á»›t','ê³ ì¶”ì¥','go-chu-jang',1,1],
['TÆ°Æ¡ng Ä‘áº­u','ëœì¥','doen-jang',1,2],
['XÃ¬ dáº§u','ê°„ì¥','gan-jang',1,1],
['Dáº§u mÃ¨','ì°¸ê¸°ë¦„','cham-gi-reum',1,2],
['Má»±c','ì˜¤ì§•ì–´','o-jing-eo',1,1],
['Cua','ê²Œ','ge',1,0],
['Bá»¯a sÃ¡ng','ì•„ì¹¨ ì‹ì‚¬','a-chim sik-sa',1,1],
['Bá»¯a trÆ°a','ì ì‹¬ ì‹ì‚¬','jeom-sim sik-sa',1,1],
['Bá»¯a tá»‘i','ì €ë… ì‹ì‚¬','jeo-nyeok sik-sa',1,1],
['Äá»“ Äƒn váº·t','ê°„ì‹','gan-sik',1,1],
['Bia','ë§¥ì£¼','maek-ju',1,0],
['RÆ°á»£u','ìˆ ','sul',1,0],
['NÆ°á»›c Ã©p','ì£¼ìŠ¤','ju-seu',1,0],

// ===== CATEGORY 2: FAMILY (ê°€ì¡±/Gia Ä‘Ã¬nh) - 25 words =====
['Bá»‘','ì•„ë²„ì§€','a-beo-ji',2,0],
['Máº¹','ì–´ë¨¸ë‹ˆ','eo-meo-ni',2,0],
['Anh trai','í˜•','hyeong',2,0],
['Chá»‹ gÃ¡i','ì–¸ë‹ˆ','eon-ni',2,0],
['Em trai','ë‚¨ë™ìƒ','nam-dong-saeng',2,0],
['Em gÃ¡i','ì—¬ë™ìƒ','yeo-dong-saeng',2,0],
['Ã”ng','í• ì•„ë²„ì§€','ha-ra-beo-ji',2,0],
['BÃ ','í• ë¨¸ë‹ˆ','hal-meo-ni',2,0],
['Chá»“ng','ë‚¨í¸','nam-pyeon',2,0],
['Vá»£','ì•„ë‚´','a-nae',2,0],
['Con trai','ì•„ë“¤','a-deul',2,0],
['Con gÃ¡i','ë”¸','ttal',2,0],
['Gia Ä‘Ã¬nh','ê°€ì¡±','ga-jok',2,0],
['Bá»‘ máº¹','ë¶€ëª¨ë‹˜','bu-mo-nim',2,0],
['Con cÃ¡i','ìë…€','ja-nyeo',2,1],
['ChÃ¡u trai (Ã´ng bÃ )','ì†ì','son-ja',2,1],
['ChÃ¡u gÃ¡i (Ã´ng bÃ )','ì†ë…€','son-nyeo',2,1],
['ChÃº','ì‚¼ì´Œ','sam-chon',2,1],
['CÃ´','ê³ ëª¨','go-mo',2,1],
['Cáº­u','ì™¸ì‚¼ì´Œ','oe-sam-chon',2,2],
['DÃ¬','ì´ëª¨','i-mo',2,1],
['Anh rá»ƒ','ë§¤í˜•','mae-hyeong',2,2],
['Chá»‹ dÃ¢u','í˜•ìˆ˜','hyeong-su',2,2],
['Em bÃ©','ì•„ê¸°','a-gi',2,0],
['Há» hÃ ng','ì¹œì²™','chin-cheok',2,2],

// ===== CATEGORY 3: EMOTION (ê°ì •/Cáº£m xÃºc) - 30 words =====
['Vui','ê¸°ì˜ë‹¤','gi-ppeu-da',3,0],
['Buá»“n','ìŠ¬í”„ë‹¤','seul-peu-da',3,0],
['Giáº­n','í™”ë‚˜ë‹¤','hwa-na-da',3,0],
['Sá»£','ë¬´ì„­ë‹¤','mu-seop-da',3,0],
['YÃªu','ì‚¬ë‘í•˜ë‹¤','sa-rang-ha-da',3,0],
['GhÃ©t','ì‹«ì–´í•˜ë‹¤','si-reo-ha-da',3,1],
['Nhá»›','ê·¸ë¦¬ì›Œí•˜ë‹¤','geu-ri-wo-ha-da',3,1],
['Lo láº¯ng','ê±±ì •í•˜ë‹¤','geok-jeong-ha-da',3,1],
['Háº¡nh phÃºc','í–‰ë³µí•˜ë‹¤','haeng-bok-ha-da',3,0],
['CÃ´ Ä‘Æ¡n','ì™¸ë¡­ë‹¤','oe-rop-da',3,1],
['Má»‡t má»i','í”¼ê³¤í•˜ë‹¤','pi-gon-ha-da',3,0],
['Bá»±c mÃ¬nh','ì§œì¦ë‚˜ë‹¤','jja-jeung-na-da',3,1],
['Xáº¥u há»•','ë¶€ë„ëŸ½ë‹¤','bu-kkeu-reop-da',3,2],
['Tháº¥t vá»ng','ì‹¤ë§í•˜ë‹¤','sil-mang-ha-da',3,2],
['Thoáº£i mÃ¡i','í¸í•˜ë‹¤','pyeon-ha-da',3,1],
['Há»“i há»™p','ë–¨ë¦¬ë‹¤','tteol-li-da',3,1],
['Tá»± tin','ìì‹ ê°ì´ ìˆë‹¤','ja-sin-ga-mi it-da',3,2],
['Ghen tá»‹','ì§ˆíˆ¬í•˜ë‹¤','jil-tu-ha-da',3,2],
['Ngáº¡c nhiÃªn','ë†€ë¼ë‹¤','nol-la-da',3,0],
['Buá»“n chÃ¡n','ì§€ë£¨í•˜ë‹¤','ji-ru-ha-da',3,1],
['ThÃ­ch','ì¢‹ì•„í•˜ë‹¤','jo-a-ha-da',3,0],
['KhÃ´ng thÃ­ch','ì‹«ë‹¤','sil-da',3,0],
['Cáº£m Ä‘á»™ng','ê°ë™í•˜ë‹¤','gam-dong-ha-da',3,2],
['HÃ i lÃ²ng','ë§Œì¡±í•˜ë‹¤','man-jok-ha-da',3,2],
['Tá»©c giáº­n','ë¶„ë…¸í•˜ë‹¤','bun-no-ha-da',3,2],
['BÃ¬nh tÄ©nh','ì°¨ë¶„í•˜ë‹¤','cha-bun-ha-da',3,2],
['Pháº¥n khÃ­ch','ì‹ ë‚˜ë‹¤','sin-na-da',3,1],
['Lo sá»£','ë‘ë µë‹¤','du-ryeop-da',3,1],
['Buá»“n ngá»§','ì¡¸ë¦¬ë‹¤','jol-li-da',3,0],
['ÄÃ³i','ë°°ê³ í”„ë‹¤','bae-go-peu-da',3,0],

// ===== CATEGORY 4: NUMBER (ìˆ«ì/Sá»‘) - 20 words =====
['Má»™t','ì¼','il',4,0],
['Hai','ì´','i',4,0],
['Ba','ì‚¼','sam',4,0],
['Bá»‘n','ì‚¬','sa',4,0],
['NÄƒm','ì˜¤','o',4,0],
['SÃ¡u','ìœ¡','yuk',4,0],
['Báº£y','ì¹ ','chil',4,0],
['TÃ¡m','íŒ”','pal',4,0],
['ChÃ­n','êµ¬','gu',4,0],
['MÆ°á»i','ì‹­','sip',4,0],
['Má»™t trÄƒm','ë°±','baek',4,0],
['Má»™t nghÃ¬n','ì²œ','cheon',4,0],
['Má»™t váº¡n','ë§Œ','man',4,0],
['Sá»‘ khÃ´ng','ì˜','yeong',4,0],
['Thá»© nháº¥t','ì²« ë²ˆì§¸','cheot beon-jjae',4,1],
['Thá»© hai','ë‘ ë²ˆì§¸','du beon-jjae',4,1],
['Thá»© ba','ì„¸ ë²ˆì§¸','se beon-jjae',4,1],
['Máº¥y','ëª‡','myeot',4,0],
['Má»™t ná»­a','ë°˜','ban',4,0],
['MÆ°á»i váº¡n','ì‹­ë§Œ','sim-man',4,1],

// ===== CATEGORY 5: SHOPPING (ì‡¼í•‘/Mua sáº¯m) - 40 words =====
['Bao nhiÃªu tiá»n?','ì–¼ë§ˆì˜ˆìš”?','eol-ma-ye-yo',5,0],
['Äáº¯t','ë¹„ì‹¸ë‹¤','bi-ssa-da',5,0],
['Ráº»','ì‹¸ë‹¤','ssa-da',5,0],
['Mua','ì‚¬ë‹¤','sa-da',5,0],
['BÃ¡n','íŒ”ë‹¤','pal-da',5,0],
['Tiá»n','ëˆ','don',5,0],
['GiÃ¡','ê°€ê²©','ga-gyeok',5,0],
['Cá»­a hÃ ng','ê°€ê²Œ','ga-ge',5,0],
['SiÃªu thá»‹','ìŠˆí¼ë§ˆì¼“','syu-peo-ma-ket',5,1],
['Tháº» tÃ­n dá»¥ng','ì‹ ìš©ì¹´ë“œ','si-nyong-ka-deu',5,2],
['Tiá»n máº·t','í˜„ê¸ˆ','hyeon-geum',5,1],
['HÃ³a Ä‘Æ¡n','ì˜ìˆ˜ì¦','yeong-su-jeung',5,2],
['Giáº£m giÃ¡','í• ì¸','ha-rin',5,1],
['Äá»•i','êµí™˜','gyo-hwan',5,1],
['HoÃ n tiá»n','í™˜ë¶ˆ','hwan-bul',5,2],
['Quáº§n Ã¡o','ì˜·','ot',5,0],
['GiÃ y','ì‹ ë°œ','sin-bal',5,0],
['TÃºi','ê°€ë°©','ga-bang',5,0],
['Äá»“ng há»“','ì‹œê³„','si-gye',5,0],
['MÅ©','ëª¨ì','mo-ja',5,0],
['Quáº§n','ë°”ì§€','ba-ji',5,0],
['Ão','ìƒì˜','sang-ui',5,0],
['VÃ¡y','ì¹˜ë§ˆ','chi-ma',5,0],
['Ão khoÃ¡c','ì™¸íˆ¬','oe-tu',5,1],
['KÃ­nh','ì•ˆê²½','an-gyeong',5,0],
['Nháº«n','ë°˜ì§€','ban-ji',5,0],
['VÃ­','ì§€ê°‘','ji-gap',5,0],
['Cá»¡','ì‚¬ì´ì¦ˆ','sa-i-jeu',5,0],
['Cá»¡ lá»›n','í° ì‚¬ì´ì¦ˆ','keun sa-i-jeu',5,1],
['Cá»¡ nhá»','ì‘ì€ ì‚¬ì´ì¦ˆ','ja-geun sa-i-jeu',5,1],
['Thá»­ Ä‘á»“','ì…ì–´ ë³´ë‹¤','i-beo bo-da',5,1],
['Tráº£ tiá»n','ê³„ì‚°í•˜ë‹¤','gye-san-ha-da',5,2],
['KhÃ¡ch hÃ ng','ì†ë‹˜','son-nim',5,0],
['HÃ ng hÃ³a','ìƒí’ˆ','sang-pum',5,2],
['QuÃ  táº·ng','ì„ ë¬¼','seon-mul',5,0],
['Bao bÃ¬','í¬ì¥','po-jang',5,2],
['Chá»£','ì‹œì¥','si-jang',5,0],
['Trung tÃ¢m mua sáº¯m','ë°±í™”ì ','bae-kwa-jeom',5,2],
['Cá»­a hÃ ng tiá»‡n lá»£i','í¸ì˜ì ','pyeo-nui-jeom',5,2],
['Táº¥t','ì–‘ë§','yang-mal',5,0],

// ===== CATEGORY 6: TRANSPORT (êµí†µ/Giao thÃ´ng) - 35 words =====
['Xe buÃ½t','ë²„ìŠ¤','beo-seu',6,0],
['TÃ u Ä‘iá»‡n ngáº§m','ì§€í•˜ì² ','ji-ha-cheol',6,0],
['Taxi','íƒì‹œ','taek-si',6,0],
['Xe Ä‘áº¡p','ìì „ê±°','ja-jeon-geo',6,0],
['MÃ¡y bay','ë¹„í–‰ê¸°','bi-haeng-gi',6,0],
['TÃ u há»a','ê¸°ì°¨','gi-cha',6,0],
['Ã” tÃ´','ìë™ì°¨','ja-dong-cha',6,0],
['Xe mÃ¡y','ì˜¤í† ë°”ì´','o-to-ba-i',6,0],
['TÃ u thá»§y','ë°°','bae',6,0],
['Báº¿n xe buÃ½t','ë²„ìŠ¤ ì •ë¥˜ì¥','beo-seu jeong-nyu-jang',6,1],
['Ga tÃ u','ì—­','yeok',6,0],
['SÃ¢n bay','ê³µí•­','gong-hang',6,0],
['Báº¿n cáº£ng','í•­êµ¬','hang-gu',6,1],
['VÃ©','í‘œ','pyo',6,0],
['ÄÆ°á»ng','ê¸¸','gil',6,0],
['NgÃ£ tÆ°','êµì°¨ë¡œ','gyo-cha-ro',6,2],
['ÄÃ¨n giao thÃ´ng','ì‹ í˜¸ë“±','sin-ho-deung',6,2],
['Cáº§u','ë‹¤ë¦¬','da-ri',6,0],
['ÄÆ°á»ng cao tá»‘c','ê³ ì†ë„ë¡œ','go-sok-do-ro',6,2],
['BÃ£i Ä‘á»— xe','ì£¼ì°¨ì¥','ju-cha-jang',6,1],
['Báº±ng lÃ¡i xe','ìš´ì „ë©´í—ˆì¦','un-jeon-myeon-heo-jeung',6,2],
['LÃ¡i xe','ìš´ì „í•˜ë‹¤','un-jeon-ha-da',6,1],
['Äi bá»™','ê±·ë‹¤','geot-da',6,0],
['Cháº¡y','ë‹¬ë¦¬ë‹¤','dal-li-da',6,0],
['LÃªn xe','íƒ€ë‹¤','ta-da',6,0],
['Xuá»‘ng xe','ë‚´ë¦¬ë‹¤','nae-ri-da',6,0],
['LÃªn (phÆ°Æ¡ng tiá»‡n)','ì˜¬ë¼íƒ€ë‹¤','ol-la-ta-da',6,1],
['Ráº½ pháº£i','ì˜¤ë¥¸ìª½ìœ¼ë¡œ ê°€ë‹¤','o-reun-jjo-geu-ro ga-da',6,2],
['Ráº½ trÃ¡i','ì™¼ìª½ìœ¼ë¡œ ê°€ë‹¤','oen-jjo-geu-ro ga-da',6,2],
['Äi tháº³ng','ì§ì§„í•˜ë‹¤','jik-jin-ha-da',6,1],
['Káº¹t xe','êµí†µ ì²´ì¦','gyo-tong che-jeung',6,2],
['Tai náº¡n giao thÃ´ng','êµí†µì‚¬ê³ ','gyo-tong-sa-go',6,2],
['XÄƒng','ê¸°ë¦„','gi-reum',6,1],
['Tráº¡m xÄƒng','ì£¼ìœ ì†Œ','ju-yu-so',6,1],
['Vá»‰a hÃ¨','ì¸ë„','in-do',6,1],

// ===== CATEGORY 7: HOSPITAL (ë³‘ì›/Bá»‡nh viá»‡n) - 30 words =====
['Bá»‡nh viá»‡n','ë³‘ì›','byeong-won',7,0],
['BÃ¡c sÄ©','ì˜ì‚¬','ui-sa',7,0],
['Thuá»‘c','ì•½','yak',7,0],
['Äau','ì•„í”„ë‹¤','a-peu-da',7,0],
['Sá»‘t','ì—´','yeol',7,0],
['Y tÃ¡','ê°„í˜¸ì‚¬','gan-ho-sa',7,0],
['Bá»‡nh nhÃ¢n','í™˜ì','hwan-ja',7,1],
['NhÃ  thuá»‘c','ì•½êµ­','yak-guk',7,0],
['Äau Ä‘áº§u','ë‘í†µ','du-tong',7,0],
['Äau bá»¥ng','ë³µí†µ','bok-tong',7,0],
['Cáº£m cÃºm','ê°ê¸°','gam-gi',7,0],
['Ho','ê¸°ì¹¨','gi-chim',7,0],
['Sá»• mÅ©i','ì½§ë¬¼','kon-mul',7,1],
['TiÃªm','ì£¼ì‚¬','ju-sa',7,1],
['Pháº«u thuáº­t','ìˆ˜ìˆ ','su-sul',7,2],
['KhÃ¡m bá»‡nh','ì§„ì°°','jin-chal',7,1],
['ÄÆ¡n thuá»‘c','ì²˜ë°©ì „','cheo-bang-jeon',7,2],
['Dá»‹ á»©ng','ì•Œë ˆë¥´ê¸°','al-le-reu-gi',7,2],
['Bá»‹ thÆ°Æ¡ng','ë‹¤ì¹˜ë‹¤','da-chi-da',7,1],
['GÃ£y xÆ°Æ¡ng','ê³¨ì ˆ','gol-jeol',7,2],
['RÄƒng','ì´','i',7,0],
['Nha sÄ©','ì¹˜ê³¼ì˜ì‚¬','chi-gwa-ui-sa',7,2],
['Máº¯t','ëˆˆ','nun',7,0],
['Tai','ê·€','gwi',7,0],
['Äau lÆ°ng','í—ˆë¦¬ê°€ ì•„í”„ë‹¤','heo-ri-ga a-peu-da',7,1],
['ChÃ³ng máº·t','ì–´ì§€ëŸ½ë‹¤','eo-ji-reop-da',7,2],
['Buá»“n nÃ´n','ë©”ìŠ¤ê»ë‹¤','me-seu-kkeop-da',7,2],
['Huyáº¿t Ã¡p','í˜ˆì••','hyeo-rap',7,2],
['Khá»e máº¡nh','ê±´ê°•í•˜ë‹¤','geon-gang-ha-da',7,1],
['Xe cáº¥p cá»©u','êµ¬ê¸‰ì°¨','gu-geup-cha',7,2],

// ===== CATEGORY 8: SCHOOL (í•™êµ/TrÆ°á»ng há»c) - 35 words =====
['TrÆ°á»ng há»c','í•™êµ','hak-gyo',8,0],
['GiÃ¡o viÃªn','ì„ ìƒë‹˜','seon-saeng-nim',8,0],
['Há»c sinh','í•™ìƒ','hak-saeng',8,0],
['SÃ¡ch','ì±…','chaek',8,0],
['BÃºt','íœ','pen',8,0],
['Lá»›p há»c','êµì‹¤','gyo-sil',8,0],
['BÃ i táº­p','ìˆ™ì œ','suk-je',8,0],
['Thi','ì‹œí—˜','si-heom',8,1],
['Äiá»ƒm','ì ìˆ˜','jeom-su',8,1],
['Äáº¡i há»c','ëŒ€í•™êµ','dae-hak-gyo',8,0],
['ThÆ° viá»‡n','ë„ì„œê´€','do-seo-gwan',8,0],
['BÃºt chÃ¬','ì—°í•„','yeon-pil',8,0],
['Táº©y','ì§€ìš°ê°œ','ji-u-gae',8,0],
['Vá»Ÿ','ê³µì±…','gong-chaek',8,0],
['BÃ n','ì±…ìƒ','chaek-sang',8,0],
['Gháº¿','ì˜ì','ui-ja',8,0],
['Báº£ng','ì¹ íŒ','chil-pan',8,0],
['ToÃ¡n','ìˆ˜í•™','su-hak',8,1],
['Tiáº¿ng HÃ n','í•œêµ­ì–´','han-gu-geo',8,0],
['Lá»‹ch sá»­','ì—­ì‚¬','yeok-sa',8,1],
['Khoa há»c','ê³¼í•™','gwa-hak',8,1],
['Nghá»‡ thuáº­t','ë¯¸ìˆ ','mi-sul',8,1],
['Thá»ƒ dá»¥c','ì²´ìœ¡','che-yuk',8,1],
['Tá»‘t nghiá»‡p','ì¡¸ì—…','jo-reop',8,2],
['Nháº­p há»c','ì…í•™','i-pak',8,2],
['Há»c ká»³','í•™ê¸°','hak-gi',8,1],
['Nghá»‰ hÃ¨','ë°©í•™','bang-hak',8,0],
['Báº¡n cÃ¹ng lá»›p','ë°˜ ì¹œêµ¬','ban chin-gu',8,0],
['Tá»« Ä‘iá»ƒn','ì‚¬ì „','sa-jeon',8,1],
['MÃ¡y tÃ­nh','ì»´í“¨í„°','keom-pyu-teo',8,0],
['Há»c','ê³µë¶€í•˜ë‹¤','gong-bu-ha-da',8,0],
['Dáº¡y','ê°€ë¥´ì¹˜ë‹¤','ga-reu-chi-da',8,1],
['CÃ¢u há»i','ì§ˆë¬¸','jil-mun',8,1],
['Tráº£ lá»i','ëŒ€ë‹µ','dae-dap',8,0],
['Hiá»ƒu','ì´í•´í•˜ë‹¤','i-hae-ha-da',8,1],

// ===== CATEGORY 9: WORK (ì§ì¥/CÃ´ng viá»‡c) - 30 words =====
['CÃ´ng ty','íšŒì‚¬','hoe-sa',9,0],
['LÆ°Æ¡ng','ì›”ê¸‰','wol-geup',9,0],
['Há»p','íšŒì˜','hoe-ui',9,0],
['Äá»“ng nghiá»‡p','ë™ë£Œ','dong-nyo',9,1],
['Sáº¿p','ìƒì‚¬','sang-sa',9,0],
['NhÃ¢n viÃªn','ì§ì›','ji-gwon',9,0],
['VÄƒn phÃ²ng','ì‚¬ë¬´ì‹¤','sa-mu-sil',9,0],
['LÃ m viá»‡c','ì¼í•˜ë‹¤','il-ha-da',9,0],
['Nghá»‰ phÃ©p','íœ´ê°€','hyu-ga',9,1],
['LÆ°Æ¡ng thÆ°á»Ÿng','ë³´ë„ˆìŠ¤','bo-neo-seu',9,1],
['Xin viá»‡c','ì·¨ì§í•˜ë‹¤','chwi-jik-ha-da',9,2],
['Nghá»‰ viá»‡c','í‡´ì§í•˜ë‹¤','toe-jik-ha-da',9,2],
['Há»£p Ä‘á»“ng','ê³„ì•½','gye-yak',9,2],
['Phá»ng váº¥n','ë©´ì ‘','myeon-jeop',9,2],
['GiÃ¡m Ä‘á»‘c','ì‚¬ì¥','sa-jang',9,1],
['Nghá» nghiá»‡p','ì§ì—…','ji-geop',9,0],
['Kinh doanh','ì‚¬ì—…','sa-eop',9,1],
['Dá»± Ã¡n','í”„ë¡œì íŠ¸','peu-ro-jek-teu',9,2],
['BÃ¡o cÃ¡o','ë³´ê³ ì„œ','bo-go-seo',9,2],
['PhÃ²ng há»p','íšŒì˜ì‹¤','hoe-ui-sil',9,1],
['ThÆ° kÃ½','ë¹„ì„œ','bi-seo',9,1],
['Giá» lÃ m viá»‡c','ê·¼ë¬´ ì‹œê°„','geun-mu si-gan',9,1],
['LÃ m thÃªm giá»','ì•¼ê·¼','ya-geun',9,2],
['Nghá»‰ ngÆ¡i','ì‰¬ë‹¤','swi-da',9,0],
['CÃ´ng viá»‡c','ì¼','il',9,0],
['Kinh nghiá»‡m','ê²½í—˜','gyeong-heom',9,2],
['ThÄƒng chá»©c','ìŠ¹ì§„','seung-jin',9,2],
['Email','ì´ë©”ì¼','i-me-il',9,0],
['Äiá»‡n thoáº¡i','ì „í™”','jeon-hwa',9,0],
['Há»p máº·t','ëª¨ì„','mo-im',9,1],

// ===== CATEGORY 10: HOBBY (ì·¨ë¯¸/Sá»Ÿ thÃ­ch) - 25 words =====
['Ã‚m nháº¡c','ìŒì•…','eu-mak',10,0],
['Phim','ì˜í™”','yeong-hwa',10,0],
['Äá»c sÃ¡ch','ë…ì„œ','dok-seo',10,0],
['Thá»ƒ thao','ìš´ë™','un-dong',10,0],
['Du lá»‹ch','ì—¬í–‰','yeo-haeng',10,0],
['Náº¥u Äƒn','ìš”ë¦¬','yo-ri',10,0],
['Chá»¥p áº£nh','ì‚¬ì§„','sa-jin',10,0],
['HÃ¡t','ë…¸ë˜','no-rae',10,0],
['Nháº£y','ì¶¤','chum',10,0],
['Váº½','ê·¸ë¦¼','geu-rim',10,0],
['BÆ¡i','ìˆ˜ì˜','su-yeong',10,0],
['CÃ¢u cÃ¡','ë‚šì‹œ','nak-si',10,1],
['Leo nÃºi','ë“±ì‚°','deung-san',10,1],
['BÃ³ng Ä‘Ã¡','ì¶•êµ¬','chuk-gu',10,0],
['BÃ³ng rá»•','ë†êµ¬','nong-gu',10,0],
['BÃ³ng chÃ y','ì•¼êµ¬','ya-gu',10,1],
['Game','ê²Œì„','ge-im',10,0],
['Mua sáº¯m','ì‡¼í•‘','syo-ping',10,0],
['Nghe nháº¡c','ìŒì•…ì„ ë“£ë‹¤','eu-ma-geul deut-da',10,1],
['Xem phim','ì˜í™”ë¥¼ ë³´ë‹¤','yeong-hwa-reul bo-da',10,1],
['ChÆ¡i piano','í”¼ì•„ë…¸ë¥¼ ì¹˜ë‹¤','pi-a-no-reul chi-da',10,2],
['ChÆ¡i guitar','ê¸°íƒ€ë¥¼ ì¹˜ë‹¤','gi-ta-reul chi-da',10,2],
['Tennis','í…Œë‹ˆìŠ¤','te-ni-seu',10,0],
['Yoga','ìš”ê°€','yo-ga',10,0],
['Viáº¿t nháº­t kÃ½','ì¼ê¸°ë¥¼ ì“°ë‹¤','il-gi-reul sseu-da',10,1],

// ===== CATEGORY 11: WEATHER (ë‚ ì”¨/Thá»i tiáº¿t) - 20 words =====
['NÃ³ng','ë¥ë‹¤','deop-da',11,0],
['Láº¡nh','ì¶¥ë‹¤','chup-da',11,0],
['MÆ°a','ë¹„','bi',11,0],
['Tuyáº¿t','ëˆˆ','nun',11,0],
['GiÃ³','ë°”ëŒ','ba-ram',11,0],
['MÃ¢y','êµ¬ë¦„','gu-reum',11,0],
['Náº¯ng','í–‡ë¹›','haet-bit',11,0],
['Trá»i quang Ä‘Ã£ng','ë§‘ë‹¤','mak-da',11,0],
['Trá»i Ã¢m u','íë¦¬ë‹¤','heu-ri-da',11,1],
['Sáº¥m sÃ©t','ë²ˆê°œ','beon-gae',11,1],
['SÆ°Æ¡ng mÃ¹','ì•ˆê°œ','an-gae',11,1],
['áº¨m','ìŠµí•˜ë‹¤','seu-pa-da',11,1],
['KhÃ´','ê±´ì¡°í•˜ë‹¤','geon-jo-ha-da',11,2],
['MÃ¹a xuÃ¢n','ë´„','bom',11,0],
['MÃ¹a hÃ¨','ì—¬ë¦„','yeo-reum',11,0],
['MÃ¹a thu','ê°€ì„','ga-eul',11,0],
['MÃ¹a Ä‘Ã´ng','ê²¨ìš¸','gyeo-ul',11,0],
['Nhiá»‡t Ä‘á»™','ì˜¨ë„','on-do',11,1],
['BÃ£o','íƒœí’','tae-pung',11,2],
['Cáº§u vá»“ng','ë¬´ì§€ê°œ','mu-ji-gae',11,1],

// ===== CATEGORY 12: TIME (ì‹œê°„/Thá»i gian) - 25 words =====
['HÃ´m nay','ì˜¤ëŠ˜','o-neul',12,0],
['NgÃ y mai','ë‚´ì¼','nae-il',12,0],
['HÃ´m qua','ì–´ì œ','eo-je',12,0],
['SÃ¡ng','ì•„ì¹¨','a-chim',12,0],
['Tá»‘i','ì €ë…','jeo-nyeok',12,0],
['TrÆ°a','ë‚®','nat',12,0],
['ÄÃªm','ë°¤','bam',12,0],
['BÃ¢y giá»','ì§€ê¸ˆ','ji-geum',12,0],
['LÃºc nÃ o?','ì–¸ì œ','eon-je',12,0],
['Giá»','ì‹œ','si',12,0],
['PhÃºt','ë¶„','bun',12,0],
['GiÃ¢y','ì´ˆ','cho',12,1],
['Tuáº§n','ì£¼','ju',12,0],
['ThÃ¡ng','ì›”','wol',12,0],
['NÄƒm','ë…„','nyeon',12,0],
['Thá»© Hai','ì›”ìš”ì¼','wo-ryo-il',12,0],
['Thá»© Ba','í™”ìš”ì¼','hwa-yo-il',12,0],
['Thá»© TÆ°','ìˆ˜ìš”ì¼','su-yo-il',12,0],
['Thá»© NÄƒm','ëª©ìš”ì¼','mo-gyo-il',12,0],
['Thá»© SÃ¡u','ê¸ˆìš”ì¼','geu-myo-il',12,0],
['Thá»© Báº£y','í† ìš”ì¼','to-yo-il',12,0],
['Chá»§ Nháº­t','ì¼ìš”ì¼','i-ryo-il',12,0],
['Tuáº§n trÆ°á»›c','ì§€ë‚œì£¼','ji-nan-ju',12,1],
['Tuáº§n sau','ë‹¤ìŒ ì£¼','da-eum ju',12,1],
['Cuá»‘i tuáº§n','ì£¼ë§','ju-mal',12,0],

// ===== CATEGORY 13: PLACE (ì¥ì†Œ/Äá»‹a Ä‘iá»ƒm) - 30 words =====
['NhÃ ','ì§‘','jip',13,0],
['TrÆ°á»ng','í•™êµ','hak-gyo',13,0],
['Bá»‡nh viá»‡n','ë³‘ì›','byeong-won',13,0],
['NgÃ¢n hÃ ng','ì€í–‰','eun-haeng',13,0],
['SiÃªu thá»‹','ìŠˆí¼','syu-peo',13,0],
['NhÃ  hÃ ng','ì‹ë‹¹','sik-dang',13,0],
['QuÃ¡n cÃ  phÃª','ì¹´í˜','ka-pe',13,0],
['KhÃ¡ch sáº¡n','í˜¸í…”','ho-tel',13,0],
['CÃ´ng viÃªn','ê³µì›','gong-won',13,0],
['Ráº¡p chiáº¿u phim','ì˜í™”ê´€','yeong-hwa-gwan',13,1],
['BÆ°u Ä‘iá»‡n','ìš°ì²´êµ­','u-che-guk',13,1],
['Äá»“n cáº£nh sÃ¡t','ê²½ì°°ì„œ','gyeong-chal-seo',13,2],
['NhÃ  thá»','êµíšŒ','gyo-hoe',13,0],
['ChÃ¹a','ì ˆ','jeol',13,0],
['Báº£o tÃ ng','ë°•ë¬¼ê´€','bang-mul-gwan',13,1],
['PhÃ²ng gym','í—¬ìŠ¤ì¥','hel-seu-jang',13,1],
['Bá»ƒ bÆ¡i','ìˆ˜ì˜ì¥','su-yeong-jang',13,1],
['Cá»­a hÃ ng sÃ¡ch','ì„œì ','seo-jeom',13,1],
['Tiá»‡m giáº·t','ì„¸íƒì†Œ','se-tak-so',13,2],
['PhÃ²ng trá»','í•˜ìˆ™ì§‘','ha-suk-jip',13,2],
['KÃ½ tÃºc xÃ¡','ê¸°ìˆ™ì‚¬','gi-suk-sa',13,2],
['CÄƒn há»™','ì•„íŒŒíŠ¸','a-pa-teu',13,0],
['NÆ°á»›c HÃ n Quá»‘c','í•œêµ­','han-guk',13,0],
['NÆ°á»›c Viá»‡t Nam','ë² íŠ¸ë‚¨','be-teu-nam',13,0],
['QuÃª hÆ°Æ¡ng','ê³ í–¥','go-hyang',13,1],
['BÃ£i biá»ƒn','í•´ë³€','hae-byeon',13,0],
['NÃºi','ì‚°','san',13,0],
['SÃ´ng','ê°•','gang',13,0],
['Biá»ƒn','ë°”ë‹¤','ba-da',13,0],
['Äáº£o','ì„¬','seom',13,0],

// ===== CATEGORY 14: ACTION (ë™ì‘/HÃ nh Ä‘á»™ng) - 45 words =====
['Äi','ê°€ë‹¤','ga-da',14,0],
['Äáº¿n','ì˜¤ë‹¤','o-da',14,0],
['Ä‚n','ë¨¹ë‹¤','meok-da',14,0],
['Uá»‘ng','ë§ˆì‹œë‹¤','ma-si-da',14,0],
['Ngá»§','ìë‹¤','ja-da',14,0],
['NÃ³i','ë§í•˜ë‹¤','mal-ha-da',14,0],
['Nghe','ë“£ë‹¤','deut-da',14,0],
['Xem','ë³´ë‹¤','bo-da',14,0],
['Äá»c','ì½ë‹¤','ik-da',14,0],
['Viáº¿t','ì“°ë‹¤','sseu-da',14,0],
['Há»i','ë¬»ë‹¤','mut-da',14,0],
['Tráº£ lá»i','ëŒ€ë‹µí•˜ë‹¤','dae-da-pa-da',14,1],
['LÃ m','í•˜ë‹¤','ha-da',14,0],
['Cho','ì£¼ë‹¤','ju-da',14,0],
['Nháº­n','ë°›ë‹¤','bat-da',14,0],
['Gáº·p','ë§Œë‚˜ë‹¤','man-na-da',14,0],
['Chá»','ê¸°ë‹¤ë¦¬ë‹¤','gi-da-ri-da',14,0],
['TÃ¬m','ì°¾ë‹¤','chat-da',14,0],
['Biáº¿t','ì•Œë‹¤','al-da',14,0],
['KhÃ´ng biáº¿t','ëª¨ë¥´ë‹¤','mo-reu-da',14,0],
['NghÄ©','ìƒê°í•˜ë‹¤','saeng-ga-ka-da',14,1],
['Nhá»›','ê¸°ì–µí•˜ë‹¤','gi-eok-ha-da',14,1],
['QuÃªn','ìŠë‹¤','it-da',14,1],
['Báº¯t Ä‘áº§u','ì‹œì‘í•˜ë‹¤','si-ja-ka-da',14,1],
['Káº¿t thÃºc','ëë‚˜ë‹¤','kkeun-na-da',14,1],
['Má»Ÿ','ì—´ë‹¤','yeol-da',14,0],
['ÄÃ³ng','ë‹«ë‹¤','dat-da',14,0],
['Ngá»“i','ì•‰ë‹¤','an-da',14,0],
['Äá»©ng','ì„œë‹¤','seo-da',14,0],
['CÆ°á»i','ì›ƒë‹¤','ut-da',14,0],
['KhÃ³c','ìš¸ë‹¤','ul-da',14,0],
['HÃ¡t','ë…¸ë˜í•˜ë‹¤','no-rae-ha-da',14,1],
['ChÆ¡i','ë†€ë‹¤','nol-da',14,0],
['GiÃºp','ë•ë‹¤','dop-da',14,0],
['Sá»‘ng','ì‚´ë‹¤','sal-da',14,0],
['Cháº¿t','ì£½ë‹¤','juk-da',14,1],
['YÃªu thÆ°Æ¡ng','ì‚¬ë‘í•˜ë‹¤','sa-rang-ha-da',14,0],
['Gá»i Ä‘iá»‡n','ì „í™”í•˜ë‹¤','jeon-hwa-ha-da',14,1],
['Gá»­i','ë³´ë‚´ë‹¤','bo-nae-da',14,0],
['Äáº·t','ë†“ë‹¤','no-ta',14,1],
['Mang Ä‘áº¿n','ê°€ì ¸ì˜¤ë‹¤','ga-jyeo-o-da',14,1],
['Cáº§m','ë“¤ë‹¤','deul-da',14,0],
['Rá»­a','ì”»ë‹¤','ssit-da',14,0],
['Máº·c','ì…ë‹¤','ip-da',14,0],
['Cá»Ÿi','ë²—ë‹¤','beot-da',14,1],

// ===== CATEGORY 15: ADJECTIVE (í˜•ìš©ì‚¬/TÃ­nh tá»«) - 30 words =====
['To','í¬ë‹¤','keu-da',15,0],
['Nhá»','ì‘ë‹¤','jak-da',15,0],
['NÃ³ng (nhiá»‡t)','ëœ¨ê²ë‹¤','tteu-geop-da',15,0],
['Láº¡nh (nhiá»‡t)','ì°¨ê°‘ë‹¤','cha-gap-da',15,0],
['Äáº¹p','ì˜ˆì˜ë‹¤','ye-ppeu-da',15,0],
['Xáº¥u','ëª»ìƒê¸°ë‹¤','mot-saeng-gi-da',15,1],
['Nhanh','ë¹ ë¥´ë‹¤','ppa-reu-da',15,0],
['Cháº­m','ëŠë¦¬ë‹¤','neu-ri-da',15,0],
['Má»›i','ìƒˆë¡­ë‹¤','sae-rop-da',15,1],
['CÅ©','ì˜¤ë˜ë˜ë‹¤','o-rae-doe-da',15,1],
['DÃ i','ê¸¸ë‹¤','gil-da',15,0],
['Ngáº¯n','ì§§ë‹¤','jjal-da',15,0],
['Cao','ë†’ë‹¤','nop-da',15,0],
['Tháº¥p','ë‚®ë‹¤','nat-da',15,0],
['Náº·ng','ë¬´ê²ë‹¤','mu-geop-da',15,1],
['Nháº¹','ê°€ë³ë‹¤','ga-byeop-da',15,1],
['Dá»…','ì‰½ë‹¤','swip-da',15,0],
['KhÃ³','ì–´ë µë‹¤','eo-ryeop-da',15,0],
['Rá»™ng','ë„“ë‹¤','neol-da',15,1],
['Háº¹p','ì¢ë‹¤','jop-da',15,1],
['SÃ¡ng','ë°ë‹¤','bak-da',15,0],
['Tá»‘i','ì–´ë‘¡ë‹¤','eo-dup-da',15,1],
['Nhiá»u','ë§ë‹¤','man-ta',15,0],
['Ãt','ì ë‹¤','jeok-da',15,0],
['Tá»‘t','ì¢‹ë‹¤','jo-ta',15,0],
['Xáº¥u (cháº¥t lÆ°á»£ng)','ë‚˜ì˜ë‹¤','na-ppeu-da',15,0],
['Ngon','ë§›ìˆë‹¤','ma-sit-da',15,0],
['Dá»Ÿ','ë§›ì—†ë‹¤','ma-deop-da',15,1],
['Xa','ë©€ë‹¤','meol-da',15,0],
['Gáº§n','ê°€ê¹ë‹¤','ga-kkap-da',15,0]
];

// ==================== CONSTANTS ====================
const SK={words:'uridul_words',expenses:'uridul_expenses',quiz:'uridul_quiz',quizStats:'uridul_quiz_stats',theme:'uridul_theme',rate:'uridul_rate',budget:'uridul_budget',version:'uridul_version',wrongWords:'uridul_wrong',recentSearch:'uridul_recent_search',settings:'uridul_settings',tutorial:'uridul_tutorial',learned:'uridul_learned'};
const DEFAULT_RATE=19.5;
const CAT_KEYS=['greeting','food','family','emotion','number','shopping','transport','hospital','school','work','hobby','weather','time','place','action','adjective'];
const WORD_CATS={
greeting:{icon:'ğŸ‘‹',ko:'ì¸ì‚¬',vi:'ChÃ o há»i'},food:{icon:'ğŸœ',ko:'ìŒì‹',vi:'Thá»©c Äƒn'},family:{icon:'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§',ko:'ê°€ì¡±',vi:'Gia Ä‘Ã¬nh'},
emotion:{icon:'ğŸ˜Š',ko:'ê°ì •',vi:'Cáº£m xÃºc'},number:{icon:'ğŸ”¢',ko:'ìˆ«ì',vi:'Sá»‘'},shopping:{icon:'ğŸ›ï¸',ko:'ì‡¼í•‘',vi:'Mua sáº¯m'},
transport:{icon:'ğŸš•',ko:'êµí†µ',vi:'Giao thÃ´ng'},hospital:{icon:'ğŸ¥',ko:'ë³‘ì›',vi:'Bá»‡nh viá»‡n'},school:{icon:'ğŸ«',ko:'í•™êµ',vi:'TrÆ°á»ng há»c'},
work:{icon:'ğŸ’¼',ko:'ì§ì¥',vi:'CÃ´ng viá»‡c'},hobby:{icon:'ğŸ¨',ko:'ì·¨ë¯¸',vi:'Sá»Ÿ thÃ­ch'},weather:{icon:'ğŸŒ¤ï¸',ko:'ë‚ ì”¨',vi:'Thá»i tiáº¿t'},
time:{icon:'â°',ko:'ì‹œê°„',vi:'Thá»i gian'},place:{icon:'ğŸ“',ko:'ì¥ì†Œ',vi:'Äá»‹a Ä‘iá»ƒm'},action:{icon:'ğŸƒ',ko:'ë™ì‘',vi:'HÃ nh Ä‘á»™ng'},
adjective:{icon:'ğŸ’«',ko:'í˜•ìš©ì‚¬',vi:'TÃ­nh tá»«'}
};
const EXP_CATS={food:{icon:'ğŸœ',ko:'ì‹ë¹„',vi:'Ä‚n uá»‘ng'},transport:{icon:'ğŸš•',ko:'êµí†µë¹„',vi:'Äi láº¡i'},shopping:{icon:'ğŸ›ï¸',ko:'ì‡¼í•‘',vi:'Mua sáº¯m'},living:{icon:'ğŸ ',ko:'ìƒí™œìš©í’ˆ',vi:'Äá»“ gia dá»¥ng'},cafe:{icon:'â˜•',ko:'ì¹´í˜',vi:'CÃ  phÃª'},health:{icon:'ğŸ’Š',ko:'ì˜ë£Œ',vi:'Y táº¿'},other:{icon:'ğŸ“¦',ko:'ê¸°íƒ€',vi:'KhÃ¡c'}};
const DIFF_KEYS=['easy','normal','hard'];
const DIFFICULTIES={easy:{ko:'ì‰¬ì›€',vi:'Dá»…',color:'#66bb6a'},normal:{ko:'ë³´í†µ',vi:'TB',color:'#ffa726'},hard:{ko:'ì–´ë ¤ì›€',vi:'KhÃ³',color:'#e85d5d'}};
const BADGES=[{count:10,icon:'ğŸŒ±',ko:'ì²« ê±¸ìŒ',vi:'BÆ°á»›c Ä‘áº§u'},{count:50,icon:'ğŸŒ¿',ko:'ì„±ì¥ ì¤‘',vi:'Äang lá»›n'},{count:100,icon:'ğŸŒ³',ko:'ë§ˆìŠ¤í„°',vi:'Báº­c tháº§y'},{count:200,icon:'ğŸ†',ko:'ë‹¬ì¸',vi:'ChuyÃªn gia'},{count:500,icon:'ğŸ‘‘',ko:'ì™•',vi:'Vua'}];

// ==================== DATA ====================
// ==================== SHARED STORAGE ====================
window.storage={
  _fb:null,_familyCode:null,_listeners:{},
  set:function(key,data,options){
    options=options||{};
    localStorage.setItem(key,JSON.stringify(data));
    if(options.shared&&this._fb&&this._familyCode){
      this._fb.ref(this._familyCode+'/'+key).set(data).catch(function(){});
    }
  },
  get:function(key,options){
    options=options||{};
    try{return JSON.parse(localStorage.getItem(key));}catch{return null;}
  }
};
function load(key){return window.storage.get(key,{shared:true});}
function save(key,data){window.storage.set(key,data,{shared:true});}

let words=load(SK.words)||[];
let expenses=load(SK.expenses)||[];
let quizStats=load(SK.quizStats)||{total:0,correct:0,streak:0,best:0,daily:{},weekly:{},monthly:{}};
let wrongWords=load(SK.wrongWords)||{};
let learnedWords=load(SK.learned)||{};
let appSettings=load(SK.settings)||{autoplay:false,defaultQuizMode:'daily',quizSource:'all'};
let exchangeRate=DEFAULT_RATE;
let calYear,calMonth;
let selectedPayment='cash',selectedExpCat='food',selectedWordCat='greeting',selectedWordDiff='easy';
let editPayment='cash';
let currentWordCatFilter='all',builtinCatFilter='all';
let searchTimer=null;
let recentQuizIds=[];

// ==================== BUILTIN WORDS HELPER ====================
function getBuiltinObj(bw){return{id:'b_'+BUILTIN_WORDS.indexOf(bw),vietnamese:bw[0],korean:bw[1],pronunciation:bw[2],category:CAT_KEYS[bw[3]],difficulty:DIFF_KEYS[bw[4]],isBuiltin:true};}
function getAllBuiltinObjs(){return BUILTIN_WORDS.map(bw=>getBuiltinObj(bw));}
function getAllQuizWords(){
  const s=appSettings.quizSource||'all';
  let pool=[];
  if(s==='builtin'||s==='all') pool.push(...getAllBuiltinObjs());
  if(s==='mywords'||s==='all') pool.push(...words.filter(w=>w.quizInclude!==false));
  return pool;
}

// ==================== UTILS ====================
function toDateStr(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}
function todayStr(){return toDateStr(new Date());}
function fmt(n){return Number(n).toLocaleString('ko-KR');}
function toVnd(krw){return Math.round(krw*exchangeRate);}
function dualCurrency(krw){return `${fmt(krw)}â‚© (${fmt(toVnd(krw))}â‚«)`;}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/'/g,'&#39;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function getWeekKey(d){const dt=new Date(d);const jan1=new Date(dt.getFullYear(),0,1);const wk=Math.ceil(((dt-jan1)/86400000+jan1.getDay()+1)/7);return dt.getFullYear()+'-W'+String(wk).padStart(2,'0');}
function getMonthKey(d){const dt=new Date(d);return dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0');}
function showToast(msg,type='info'){const t=document.createElement('div');t.className='toast toast-'+type;t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),2200);}

// ==================== THEME ====================
function initTheme(){
  const saved=localStorage.getItem(SK.theme);
  if(saved)document.documentElement.setAttribute('data-theme',saved);
  else if(window.matchMedia('(prefers-color-scheme:dark)').matches)document.documentElement.setAttribute('data-theme','dark');
  updateThemeToggle();
}
function toggleTheme(){
  const nxt=document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark';
  document.documentElement.setAttribute('data-theme',nxt);localStorage.setItem(SK.theme,nxt);updateThemeToggle();
}
function updateThemeToggle(){const b=document.getElementById('theme-toggle');if(b)b.classList.toggle('on',document.documentElement.getAttribute('data-theme')==='dark');}
function toggleAutoplay(){appSettings.autoplay=!appSettings.autoplay;save(SK.settings,appSettings);document.getElementById('autoplay-toggle').classList.toggle('on',appSettings.autoplay);}

// ==================== EXCHANGE RATE ====================
function loadRate(){const saved=load(SK.rate);if(saved&&saved.rate){exchangeRate=saved.rate;if(saved.lastFetch&&Date.now()-saved.lastFetch<86400000)return;}fetchExchangeRate();}
async function fetchExchangeRate(){try{const res=await fetch('https://api.exchangerate-api.com/v4/latest/KRW');const data=await res.json();if(data.rates&&data.rates.VND){exchangeRate=data.rates.VND;save(SK.rate,{rate:exchangeRate,lastFetch:Date.now()});showToast('Cáº­p nháº­t tá»· giÃ¡ thÃ nh cÃ´ng!','success');updateRateDisplay();}}catch{showToast('KhÃ´ng thá»ƒ cáº­p nháº­t tá»· giÃ¡','error');}}
function saveManualRate(){const v=parseFloat(document.getElementById('rate-input').value);if(!v||v<=0){showToast('Nháº­p tá»· giÃ¡ há»£p lá»‡','error');return;}exchangeRate=v;save(SK.rate,{rate:v,lastFetch:Date.now(),manual:true});showToast('ÄÃ£ lÆ°u tá»· giÃ¡!','success');updateRateDisplay();closeModal('rate-modal');}
function updateRateDisplay(){const el=document.getElementById('rate-info');if(el)el.textContent=`1â‚© = ${exchangeRate.toFixed(2)}â‚«`;}
function openRateModal(){document.getElementById('rate-input').value=exchangeRate;document.getElementById('rate-modal').classList.add('show');}

// ==================== BUDGET ====================
function loadBudget(){const b=load(SK.budget);const el=document.getElementById('budget-info');if(b&&b.amount)el.textContent=`${fmt(b.amount)}â‚© / thÃ¡ng`;else el.textContent='ChÆ°a Ä‘áº·t / ì„¤ì • ì•ˆë¨';}
function openBudgetModal(){const b=load(SK.budget);document.getElementById('budget-input').value=b?b.amount:'';document.getElementById('budget-modal').classList.add('show');}
function saveBudget(){const v=parseInt(document.getElementById('budget-input').value);if(!v||v<=0){showToast('Nháº­p sá»‘ tiá»n há»£p lá»‡','error');return;}save(SK.budget,{amount:v});showToast('ÄÃ£ lÆ°u ngÃ¢n sÃ¡ch!','success');loadBudget();closeModal('budget-modal');renderBudgetAlert();renderStats();}
function renderBudgetAlert(){const c=document.getElementById('budget-alert-container');const b=load(SK.budget);if(!b||!b.amount){c.innerHTML='';return;}const now=new Date();const mk=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0');const mt=expenses.filter(e=>e.date.startsWith(mk)).reduce((s,e)=>s+e.amount,0);const pct=Math.round((mt/b.amount)*100);if(pct>=90)c.innerHTML=`<div class="budget-alert">âš ï¸ ÄÃ£ dÃ¹ng ${pct}% ngÃ¢n sÃ¡ch! (${fmt(mt)}â‚© / ${fmt(b.amount)}â‚©)</div>`;else c.innerHTML='';}

// ==================== TAB NAVIGATION ====================
const headerSubs={'tab-dictionary':'Tá»« vá»±ng / ë‹¨ì–´ì¥','tab-quiz':'CÃ¢u Ä‘á»‘ / í€´ì¦ˆ','tab-expenses':'Chi phÃ­ / ìƒí™œë¹„','tab-settings':'CÃ i Ä‘áº·t / ì„¤ì •'};
function switchTab(el){
  const id=el.dataset.tab;
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('header-sub').textContent=headerSubs[id];
  if(id==='tab-dictionary')renderWOTD();
  if(id==='tab-quiz')renderQuizMain();
  if(id==='tab-expenses'){renderCalendar();renderStats();renderExpenseList();renderBudgetAlert();}
  if(id==='tab-settings'){updateRateDisplay();loadBudget();}
}
function switchDictSub(el){
  document.querySelectorAll('#tab-dictionary .sub-tab').forEach(s=>s.classList.remove('active'));el.classList.add('active');
  document.querySelectorAll('#tab-dictionary .sub-content').forEach(s=>s.classList.remove('active'));document.getElementById(el.dataset.sub).classList.add('active');
  if(el.dataset.sub==='dict-mywords')renderMyWords();
  if(el.dataset.sub==='dict-builtin')renderBuiltinWords();
}
function switchExpSub(el){
  document.querySelectorAll('#tab-expenses .sub-tab').forEach(s=>s.classList.remove('active'));el.classList.add('active');
  document.querySelectorAll('#tab-expenses .sub-content').forEach(s=>s.classList.remove('active'));document.getElementById(el.dataset.sub).classList.add('active');
  if(el.dataset.sub==='exp-calendar')renderCalendar();if(el.dataset.sub==='exp-stats')renderStats();if(el.dataset.sub==='exp-list')renderExpenseList();
}

// ==================== SPEECH ====================
function speak(text,lang){if(!('speechSynthesis' in window)){showToast('KhÃ´ng há»— trá»£ giá»ng nÃ³i','error');return;}window.speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(text);u.lang=lang;u.rate=0.85;window.speechSynthesis.speak(u);}

// ==================== WORD OF THE DAY ====================
function renderWOTD(){
  const c=document.getElementById('wotd-container');if(!c)return;
  const today=todayStr();const seed=today.split('-').reduce((a,b)=>a+parseInt(b),0);
  const idx=seed%BUILTIN_WORDS.length;const w=BUILTIN_WORDS[idx];
  c.innerHTML=`<div class="wotd-card" onclick="speak('${esc(w[1])}','ko-KR')">
    <div class="wotd-label">ğŸ“– Tá»« hÃ´m nay / ì˜¤ëŠ˜ì˜ ë‹¨ì–´</div>
    <div class="wotd-vi">${esc(w[0])}</div>
    <div class="wotd-ko">${esc(w[1])}</div>
    <div class="wotd-pron">ğŸ—£ï¸ ${esc(w[2])}</div>
    <div style="margin-top:8px;font-size:12px;opacity:.7;">Nháº¥n Ä‘á»ƒ nghe phÃ¡t Ã¢m / í„°ì¹˜í•˜ë©´ ë°œìŒ ì¬ìƒ ğŸ”Š</div>
  </div>`;
}

// ==================== RECENT SEARCHES ====================
function getRecentSearches(){return load(SK.recentSearch)||[];}
function addRecentSearch(q){let rs=getRecentSearches();rs=rs.filter(x=>x!==q);rs.unshift(q);if(rs.length>5)rs=rs.slice(0,5);save(SK.recentSearch,rs);}
function renderRecentSearches(){
  const rs=getRecentSearches();const c=document.getElementById('recent-searches');
  if(rs.length===0){c.innerHTML='';return;}
  c.innerHTML='<div class="recent-searches">'+rs.map(s=>`<button class="recent-chip" onclick="document.getElementById('trans-search-input').value='${esc(s)}';onTransSearch('${esc(s)}')">${esc(s)}</button>`).join('')+'</div>';
}

// ==================== TRANSLATION SEARCH ====================
function detectLang(text){return /[ê°€-í£]/.test(text)?'ko':'vi';}
function onTransSearch(val){
  clearTimeout(searchTimer);const q=val.trim();
  if(q.length<1){document.getElementById('trans-results').innerHTML='';document.getElementById('trans-loading').style.display='none';document.getElementById('trans-empty').style.display='block';return;}
  document.getElementById('trans-empty').style.display='none';document.getElementById('trans-loading').style.display='block';
  // First search builtin words
  const builtinResults=searchBuiltinWords(q);
  if(builtinResults.length>0){document.getElementById('trans-loading').style.display='none';renderSearchResults(builtinResults,true);return;}
  searchTimer=setTimeout(()=>searchTranslation(q),600);
}
function searchBuiltinWords(q){
  const ql=q.toLowerCase();
  return BUILTIN_WORDS.filter(bw=>bw[0].toLowerCase().includes(ql)||bw[1].includes(q)).slice(0,10).map(bw=>({
    source:bw[0],translated:bw[1],pronunciation:bw[2],quality:1,sourceLang:'vi',isBuiltin:true,category:CAT_KEYS[bw[3]],difficulty:DIFF_KEYS[bw[4]]
  }));
}
async function searchTranslation(query){
  const lang=detectLang(query);const pair=lang==='ko'?'ko|vi':'vi|ko';
  try{
    const res=await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(query)}&langpair=${pair}`);
    const data=await res.json();
    document.getElementById('trans-loading').style.display='none';
    const results=[];
    if(data.responseData&&data.responseData.translatedText){
      results.push({source:query,translated:data.responseData.translatedText,quality:data.responseData.match||0,sourceLang:lang});
    }
    if(data.matches){data.matches.slice(0,5).forEach(m=>{if(m.translation&&m.translation!==results[0]?.translated)results.push({source:m.segment,translated:m.translation,quality:parseFloat(m.quality)||0,sourceLang:lang});});}
    if(results.length>0)addRecentSearch(query);
    renderSearchResults(results,false);
    if(results.length===0)suggestSimilar(query);
  }catch{
    document.getElementById('trans-loading').style.display='none';
    document.getElementById('trans-results').innerHTML='<div class="empty-state"><span class="emoji">âŒ</span><p>KhÃ´ng thá»ƒ dá»‹ch. Kiá»ƒm tra káº¿t ná»‘i.<br>ë²ˆì—­ ì‹¤íŒ¨. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.</p></div>';
  }
}
function suggestSimilar(q){
  const ql=q.toLowerCase();
  const similar=BUILTIN_WORDS.filter(bw=>{
    const v=bw[0].toLowerCase();
    return v.startsWith(ql.substring(0,2))||levenshtein(v,ql)<4;
  }).slice(0,5);
  if(similar.length>0){
    const c=document.getElementById('trans-results');
    c.innerHTML+=`<div class="card"><div style="font-size:13px;color:var(--text-secondary);margin-bottom:8px;">ğŸ’¡ CÃ³ thá»ƒ báº¡n tÃ¬m / ì´ëŸ° ë‹¨ì–´ë¥¼ ì°¾ìœ¼ì…¨ë‚˜ìš”?</div>${similar.map(bw=>`<div style="padding:6px 0;cursor:pointer;border-bottom:1px solid var(--border)" onclick="document.getElementById('trans-search-input').value='${esc(bw[0])}';onTransSearch('${esc(bw[0])}')"><strong>${esc(bw[0])}</strong> â€” ${esc(bw[1])}</div>`).join('')}</div>`;
  }
}
function levenshtein(a,b){const m=[];for(let i=0;i<=b.length;i++){m[i]=[i];for(let j=1;j<=a.length;j++){m[i][j]=i===0?j:Math.min(m[i-1][j-1]+(a[j-1]===b[i-1]?0:1),m[i][j-1]+1,m[i-1][j]+1);}}return m[b.length][a.length];}

function renderSearchResults(results,isBuiltin){
  const c=document.getElementById('trans-results');
  if(results.length===0){c.innerHTML='<div class="empty-state"><span class="emoji">ğŸ¤·</span><p>KhÃ´ng cÃ³ káº¿t quáº£ / ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';return;}
  c.innerHTML=results.map((r,i)=>{
    const viet=r.sourceLang==='ko'?r.translated:r.source;
    const kor=r.sourceLang==='ko'?r.source:r.translated;
    const exists=words.some(w=>w.vietnamese.toLowerCase()===viet.toLowerCase()&&w.korean===kor);
    const pron=r.pronunciation||'';
    const catInfo=r.category?WORD_CATS[r.category]:null;
    const diffInfo=r.difficulty?DIFFICULTIES[r.difficulty]:null;
    return `<div class="card search-result-card">
      <button class="add-btn ${exists?'added':''}" onclick="addFromSearch(${i})" title="${exists?'ÄÃ£ thÃªm':'ThÃªm vÃ o tá»« vá»±ng'}">${exists?'âœ…':'â­'}</button>
      <div class="word-viet"><button class="speak-btn" onclick="event.stopPropagation();speak('${esc(viet)}','vi-VN')">ğŸ”Š</button> ${esc(viet)}</div>
      <div class="word-korean" style="margin-top:6px;"><button class="speak-btn" onclick="event.stopPropagation();speak('${esc(kor)}','ko-KR')" style="font-size:16px;">ğŸ”ˆ</button> ${esc(kor)}</div>
      ${pron?`<div class="word-pron">ğŸ—£ï¸ ${esc(pron)}</div>`:''}
      ${catInfo?`<div style="margin-top:6px;"><span style="font-size:12px;">${catInfo.icon} ${catInfo.vi}</span>${diffInfo?` <span class="diff-badge diff-${r.difficulty}">${diffInfo.vi}</span>`:''}</div>`:''}
    </div>`;
  }).join('');
  window._searchResults=results;
  renderRecentSearches();
}
function addFromSearch(idx){
  const r=window._searchResults[idx];if(!r)return;
  const viet=r.sourceLang==='ko'?r.translated:r.source;
  const kor=r.sourceLang==='ko'?r.source:r.translated;
  if(words.some(w=>w.vietnamese.toLowerCase()===viet.toLowerCase()&&w.korean===kor)){showToast('ÄÃ£ cÃ³ trong tá»« vá»±ng!','info');return;}
  openWordModal(null,viet,kor,r.pronunciation||'',r.category||'greeting',r.difficulty||'easy');
}

// ==================== WORD CATEGORY GRID ====================
function renderWordCatGrid(containerId,selected){
  const el=document.getElementById(containerId);
  el.innerHTML=Object.entries(WORD_CATS).map(([k,v])=>
    `<button class="cat-btn ${k===selected?'selected':''}" data-cat="${k}" onclick="selectWordCatBtn(this,'${containerId}')"><span class="cat-icon">${v.icon}</span>${v.vi}</button>`
  ).join('');
}
function selectWordCatBtn(btn,containerId){
  document.querySelectorAll('#'+containerId+' .cat-btn').forEach(b=>b.classList.remove('selected'));btn.classList.add('selected');selectedWordCat=btn.dataset.cat;
}
function selectWordDiff(d){
  selectedWordDiff=d;
  document.querySelectorAll('#word-diff-group .radio-label').forEach(l=>l.classList.remove('selected'));
  document.querySelectorAll('#word-diff-group .radio-label').forEach(l=>{if(l.querySelector('input').value===d)l.classList.add('selected');});
}

// ==================== EXPENSE CAT GRID ====================
function renderExpCatGrid(){
  document.getElementById('exp-cat-grid').innerHTML=Object.entries(EXP_CATS).map(([k,v])=>
    `<button class="cat-btn ${k===selectedExpCat?'selected':''}" data-cat="${k}" onclick="selectExpCatBtn(this)"><span class="cat-icon">${v.icon}</span>${v.vi}</button>`
  ).join('');
  document.getElementById('edit-exp-cat').innerHTML=Object.entries(EXP_CATS).map(([k,v])=>`<option value="${k}">${v.icon} ${v.vi}</option>`).join('');
}
function selectExpCatBtn(btn){document.querySelectorAll('#exp-cat-grid .cat-btn').forEach(b=>b.classList.remove('selected'));btn.classList.add('selected');selectedExpCat=btn.dataset.cat;}

// ==================== WORD CATEGORY FILTER ====================
function renderWordCatFilter(){
  const el=document.getElementById('word-cat-filter');
  let html=`<button class="filter-chip ${currentWordCatFilter==='all'?'active':''}" onclick="filterWordCat('all')">Táº¥t cáº£</button>`;
  Object.entries(WORD_CATS).forEach(([k,v])=>{const count=words.filter(w=>(w.category||'greeting')===k).length;if(count>0)html+=`<button class="filter-chip ${currentWordCatFilter===k?'active':''}" onclick="filterWordCat('${k}')">${v.icon} ${v.vi} (${count})</button>`;});
  el.innerHTML=html;
}
function filterWordCat(cat){currentWordCatFilter=cat;renderWordCatFilter();renderMyWords();}

function renderBuiltinCatFilter(){
  const el=document.getElementById('builtin-cat-filter');if(!el)return;
  let html=`<button class="filter-chip ${builtinCatFilter==='all'?'active':''}" onclick="filterBuiltinCat('all')">Táº¥t cáº£</button>`;
  CAT_KEYS.forEach(k=>{const v=WORD_CATS[k];const count=BUILTIN_WORDS.filter(bw=>CAT_KEYS[bw[3]]===k).length;html+=`<button class="filter-chip ${builtinCatFilter===k?'active':''}" onclick="filterBuiltinCat('${k}')">${v.icon} ${v.vi} (${count})</button>`;});
  el.innerHTML=html;
}
function filterBuiltinCat(cat){builtinCatFilter=cat;renderBuiltinCatFilter();renderBuiltinWords();}

// ==================== MY WORDS ====================
function renderMyWords(){
  const list=document.getElementById('word-list');
  const query=(document.getElementById('word-search-input')?.value||'').trim().toLowerCase();
  let filtered=words;
  if(currentWordCatFilter!=='all')filtered=filtered.filter(w=>(w.category||'greeting')===currentWordCatFilter);
  if(query)filtered=filtered.filter(w=>w.vietnamese.toLowerCase().includes(query)||w.korean.includes(query)||(w.pronunciation||'').includes(query));
  if(filtered.length===0){
    list.innerHTML=`<div class="empty-state"><span class="emoji">ğŸ“–</span><p>${query||currentWordCatFilter!=='all'?'KhÃ´ng cÃ³ káº¿t quáº£ / ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ':'ThÃªm tá»« má»›i! / ë‹¨ì–´ë¥¼ ì¶”ê°€í•˜ì„¸ìš”!'}</p></div>`;
  }else{
    list.innerHTML=filtered.map(w=>{
      const cat=WORD_CATS[w.category||'greeting']||WORD_CATS.greeting;
      const diff=DIFFICULTIES[w.difficulty||'easy']||DIFFICULTIES.easy;
      return `<div class="card word-card">
        <div class="word-card-header"><div>
          <div class="word-viet"><button class="speak-btn" onclick="speak('${esc(w.korean)}','ko-KR')">ğŸ”Š</button> ${esc(w.vietnamese)}</div>
          <div class="word-korean">${esc(w.korean)}</div>
          ${w.pronunciation?`<div class="word-pron">ğŸ—£ï¸ ${esc(w.pronunciation)}</div>`:''}
        </div>
        <label class="learn-check"><input type="checkbox" ${w.quizInclude!==false?'checked':''} onchange="toggleQuizInclude(${w.id})"><span>ğŸ“</span></label>
        </div>
        ${w.example?`<div class="word-example">ğŸ’¬ ${esc(w.example)}</div>`:''}
        <div style="display:flex;gap:6px;align-items:center;margin-top:8px;flex-wrap:wrap;">
          <span style="font-size:12px;">${cat.icon} ${cat.vi}</span>
          <span class="diff-badge diff-${w.difficulty||'easy'}">${diff.vi}</span>
        </div>
        <div class="word-actions">
          <button class="icon-btn" onclick="editWord(${w.id})">âœï¸</button>
          <button class="icon-btn" onclick="deleteWord(${w.id})">ğŸ—‘ï¸</button>
        </div>
      </div>`;
    }).join('');
  }
  updateProgress();renderWordCatFilter();
}

function renderBuiltinWords(){
  const list=document.getElementById('builtin-word-list');if(!list)return;
  const query=(document.getElementById('builtin-search-input')?.value||'').trim().toLowerCase();
  let filtered=BUILTIN_WORDS;
  if(builtinCatFilter!=='all')filtered=filtered.filter(bw=>CAT_KEYS[bw[3]]===builtinCatFilter);
  if(query)filtered=filtered.filter(bw=>bw[0].toLowerCase().includes(query)||bw[1].includes(query));
  const page=filtered.slice(0,50);
  const total=filtered.length;
  document.getElementById('builtin-count').textContent=`${total}ê°œ`;
  list.innerHTML=page.map(bw=>{
    const cat=WORD_CATS[CAT_KEYS[bw[3]]];const diff=DIFFICULTIES[DIFF_KEYS[bw[4]]];
    const exists=words.some(w=>w.vietnamese.toLowerCase()===bw[0].toLowerCase()&&w.korean===bw[1]);
    return `<div class="card word-card" style="padding:12px 14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div style="flex:1;">
          <div style="font-size:16px;font-weight:700;color:var(--primary-dark);">${esc(bw[0])}</div>
          <div style="font-size:15px;font-weight:600;margin-top:2px;">${esc(bw[1])}</div>
          <div style="font-size:12px;color:var(--text-secondary);margin-top:2px;">ğŸ—£ï¸ ${esc(bw[2])}</div>
        </div>
        <div style="display:flex;gap:6px;align-items:center;">
          <button class="speak-btn" onclick="speak('${esc(bw[1])}','ko-KR')">ğŸ”Š</button>
          <button class="icon-btn" onclick="addBuiltinToMyWords(${BUILTIN_WORDS.indexOf(bw)})" style="background:${exists?'var(--accent-light)':'var(--secondary-light)'};font-size:18px;">${exists?'âœ…':'â­'}</button>
        </div>
      </div>
      <div style="display:flex;gap:6px;margin-top:6px;"><span style="font-size:11px;">${cat.icon} ${cat.vi}</span><span class="diff-badge diff-${DIFF_KEYS[bw[4]]}" style="font-size:10px;">${diff.vi}</span></div>
    </div>`;
  }).join('');
  if(total>50)list.innerHTML+=`<div style="text-align:center;padding:12px;color:var(--text-secondary);font-size:13px;">Hiá»ƒn thá»‹ 50/${total} tá»«. Sá»­ dá»¥ng bá»™ lá»c hoáº·c tÃ¬m kiáº¿m.</div>`;
  renderBuiltinCatFilter();
}
function addBuiltinToMyWords(idx){
  const bw=BUILTIN_WORDS[idx];if(!bw)return;
  if(words.some(w=>w.vietnamese.toLowerCase()===bw[0].toLowerCase()&&w.korean===bw[1])){showToast('ÄÃ£ cÃ³ trong tá»« vá»±ng!','info');return;}
  words.unshift({id:Date.now(),vietnamese:bw[0],korean:bw[1],pronunciation:bw[2],example:'',category:CAT_KEYS[bw[3]],difficulty:DIFF_KEYS[bw[4]],learned:false,learnedDate:null,addedDate:todayStr(),quizInclude:true});
  save(SK.words,words);showToast('ÄÃ£ thÃªm vÃ o tá»« vá»±ng!','success');renderBuiltinWords();
}

function openWordModal(editId,preViet,preKor,prePron,preCat,preDiff){
  const modal=document.getElementById('word-modal');modal.classList.add('show');
  if(editId){
    const w=words.find(x=>x.id===editId);if(!w)return;
    document.getElementById('word-modal-title').textContent='âœï¸ Sá»­a tá»« / ë‹¨ì–´ ìˆ˜ì •';
    document.getElementById('word-viet').value=w.vietnamese;document.getElementById('word-korean').value=w.korean;
    document.getElementById('word-pron').value=w.pronunciation||'';document.getElementById('word-example').value=w.example||'';
    document.getElementById('word-edit-id').value=w.id;document.getElementById('word-quiz-include').checked=w.quizInclude!==false;
    selectedWordCat=w.category||'greeting';selectedWordDiff=w.difficulty||'easy';
  }else{
    document.getElementById('word-modal-title').textContent='ğŸ“ ThÃªm tá»« / ë‹¨ì–´ ì¶”ê°€';
    document.getElementById('word-viet').value=preViet||'';document.getElementById('word-korean').value=preKor||'';
    document.getElementById('word-pron').value=prePron||'';document.getElementById('word-example').value='';
    document.getElementById('word-edit-id').value='';document.getElementById('word-quiz-include').checked=true;
    selectedWordCat=preCat||'greeting';selectedWordDiff=preDiff||'easy';
  }
  renderWordCatGrid('word-cat-grid',selectedWordCat);selectWordDiff(selectedWordDiff);
}
function closeWordModal(){document.getElementById('word-modal').classList.remove('show');}
function saveWord(){
  const v=document.getElementById('word-viet').value.trim(),k=document.getElementById('word-korean').value.trim();
  const p=document.getElementById('word-pron').value.trim(),e=document.getElementById('word-example').value.trim();
  const editId=document.getElementById('word-edit-id').value,qi=document.getElementById('word-quiz-include').checked;
  if(!v||!k){showToast('Nháº­p tiáº¿ng Viá»‡t vÃ  tiáº¿ng HÃ n!','error');return;}
  if(editId){const idx=words.findIndex(x=>x.id===Number(editId));if(idx>-1)Object.assign(words[idx],{vietnamese:v,korean:k,pronunciation:p,example:e,category:selectedWordCat,difficulty:selectedWordDiff,quizInclude:qi});showToast('ÄÃ£ sá»­a!','success');}
  else{words.unshift({id:Date.now(),vietnamese:v,korean:k,pronunciation:p,example:e,category:selectedWordCat,difficulty:selectedWordDiff,learned:false,learnedDate:null,addedDate:todayStr(),quizInclude:qi});showToast('ÄÃ£ thÃªm!','success');}
  save(SK.words,words);closeWordModal();renderMyWords();
  const q=document.getElementById('trans-search-input')?.value;if(q)onTransSearch(q);
}
function editWord(id){openWordModal(id);}
function deleteWord(id){if(!confirm('XÃ³a tá»« nÃ y?\nì´ ë‹¨ì–´ë¥¼ ì‚­ì œí• ê¹Œìš”?'))return;words=words.filter(w=>w.id!==id);save(SK.words,words);renderMyWords();showToast('ÄÃ£ xÃ³a!','success');}
function toggleQuizInclude(id){const w=words.find(x=>x.id===id);if(w){w.quizInclude=!w.quizInclude;save(SK.words,words);renderMyWords();}}
function updateProgress(){
  const total=words.length,learned=Object.keys(learnedWords).length;
  const pct=total>0?Math.round((Math.min(learned,total)/total)*100):0;
  document.getElementById('progress-fill').style.width=pct+'%';document.getElementById('progress-text').textContent=pct+'%';
  document.getElementById('progress-detail').textContent=`${total} tá»« / ${learned} Ä‘Ã£ há»c | ${total}ê°œ ì¤‘ ${learned}ê°œ í•™ìŠµ`;
  document.getElementById('badges-container').innerHTML=BADGES.map(b=>{const e=learned>=b.count;return `<span class="badge ${e?'earned':'locked'}">${b.icon} ${b.vi} (${b.count})${e?' âœ…':''}</span>`;}).join('');
}

// ==================== CSV IMPORT/EXPORT ====================
function exportCSV(){
  if(words.length===0){showToast('KhÃ´ng cÃ³ tá»« Ä‘á»ƒ xuáº¥t','error');return;}
  let csv='Tiáº¿ng Viá»‡t,Tiáº¿ng HÃ n,PhÃ¡t Ã¢m,Danh má»¥c,Äá»™ khÃ³\n';
  words.forEach(w=>{csv+=`"${w.vietnamese}","${w.korean}","${w.pronunciation||''}","${w.category||'greeting'}","${w.difficulty||'easy'}"\n`;});
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`uridul-words-${todayStr()}.csv`;a.click();
  showToast('ÄÃ£ xuáº¥t CSV!','success');
}
function downloadSampleCSV(){
  const csv='Tiáº¿ng Viá»‡t,Tiáº¿ng HÃ n,PhÃ¡t Ã¢m,Danh má»¥c,Äá»™ khÃ³\n"Xin chÃ o","ì•ˆë…•í•˜ì„¸ìš”","an-nyeong-ha-se-yo","greeting","easy"\n"Cáº£m Æ¡n","ê°ì‚¬í•©ë‹ˆë‹¤","gam-sa-ham-ni-da","greeting","easy"\n"Táº¡m biá»‡t","ì•ˆë…•íˆ ê°€ì„¸ìš”","an-nyeong-hi ga-se-yo","greeting","easy"\n';
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='uridul-sample.csv';a.click();
  showToast('ÄÃ£ táº£i máº«u CSV!','success');
}
function importCSV(event){
  const file=event.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    const lines=e.target.result.split('\n').filter(l=>l.trim());
    let success=0,dup=0,fail=0;
    for(let i=1;i<lines.length;i++){
      try{
        const parts=lines[i].match(/(".*?"|[^,]+)/g);if(!parts||parts.length<2)throw 0;
        const clean=s=>(s||'').replace(/^"|"$/g,'').trim();
        const vi=clean(parts[0]),ko=clean(parts[1]),pr=clean(parts[2]),cat=clean(parts[3])||'greeting',diff=clean(parts[4])||'easy';
        if(!vi||!ko){fail++;continue;}
        if(words.some(w=>w.vietnamese.toLowerCase()===vi.toLowerCase()&&w.korean===ko)){dup++;continue;}
        words.unshift({id:Date.now()+i,vietnamese:vi,korean:ko,pronunciation:pr,example:'',category:cat,difficulty:diff,learned:false,learnedDate:null,addedDate:todayStr(),quizInclude:true});
        success++;
      }catch{fail++;}
    }
    save(SK.words,words);renderMyWords();
    showToast(`ThÃ nh cÃ´ng ${success}, trÃ¹ng ${dup}, lá»—i ${fail} / ì„±ê³µ ${success}ê°œ, ì¤‘ë³µ ${dup}ê°œ, ì‹¤íŒ¨ ${fail}ê°œ`,'success');
  };
  reader.readAsText(file);event.target.value='';
}

// ==================== QUIZ SYSTEM ====================
let quizState=null;
function renderQuizMain(){
  const c=document.getElementById('quiz-main');
  const pool=getAllQuizWords();
  if(pool.length<4){c.innerHTML=`<div class="quiz-status card"><span class="emoji">ğŸ“</span><h3>Cáº§n Ã­t nháº¥t 4 tá»«!</h3><p style="color:var(--text-secondary);margin-top:8px;">ìµœì†Œ 4ê°œ ë‹¨ì–´ê°€ í•„ìš”í•©ë‹ˆë‹¤</p></div>`;return;}
  if(quizState&&!quizState.completed){renderQuizQuestion();return;}
  // Mode selection
  const wrongCount=Object.keys(wrongWords).length;
  const todayQuiz=load(SK.quiz);
  const todayDone=todayQuiz&&todayQuiz.date===todayStr()&&todayQuiz.completed;
  c.innerHTML=`
    <div style="text-align:center;margin-bottom:16px;"><span style="font-size:36px;">ğŸ¯</span><h3 style="margin-top:8px;">Chá»n cháº¿ Ä‘á»™ / ëª¨ë“œ ì„ íƒ</h3></div>
    <div class="card quiz-mode-card" onclick="startQuizMode('daily')" ${todayDone?'style="opacity:.6"':''}>
      <span class="quiz-mode-icon">ğŸ“…</span>
      <div class="quiz-mode-title">CÃ¢u Ä‘á»‘ hÃ ng ngÃ y / ì¼ì¼ í€´ì¦ˆ</div>
      <div class="quiz-mode-desc">${todayDone?'ÄÃ£ hoÃ n thÃ nh hÃ´m nay! âœ… / ì˜¤ëŠ˜ ì™„ë£Œ!':'10 cÃ¢u má»—i ngÃ y / ë§¤ì¼ 10ë¬¸ì œ'}</div>
    </div>
    <div class="card quiz-mode-card" onclick="startQuizMode('practice')">
      <span class="quiz-mode-icon">ğŸ“</span>
      <div class="quiz-mode-title">Luyá»‡n táº­p / ì—°ìŠµ ëª¨ë“œ</div>
      <div class="quiz-mode-desc">KhÃ´ng giá»›i háº¡n / ë¬´ì œí•œ ì—°ìŠµ</div>
    </div>
    <div class="card quiz-mode-card" onclick="${wrongCount>0?'startQuizMode(\'wrong\')':''}" style="${wrongCount===0?'opacity:.5':''}" >
      <span class="quiz-mode-icon">ğŸ”„</span>
      <div class="quiz-mode-title">Ã”n tá»« sai / í‹€ë¦° ë‹¨ì–´ ë³µìŠµ</div>
      <div class="quiz-mode-desc">${wrongCount>0?`${wrongCount} tá»« cáº§n Ã´n / ${wrongCount}ê°œ ë³µìŠµ í•„ìš”`:'ChÆ°a cÃ³ tá»« sai / í‹€ë¦° ë‹¨ì–´ ì—†ìŒ'}</div>
    </div>
    <div class="card" style="margin-top:8px;">
      <div style="font-size:13px;font-weight:700;margin-bottom:8px;">ğŸ“š Pháº¡m vi / ì¶œì œ ë²”ìœ„</div>
      <div class="quiz-source-group">
        <button class="source-chip ${appSettings.quizSource==='all'?'active':''}" onclick="setQuizSource('all')">Táº¥t cáº£ / ëª¨ë‘</button>
        <button class="source-chip ${appSettings.quizSource==='builtin'?'active':''}" onclick="setQuizSource('builtin')">Tá»« cÆ¡ báº£n / ê¸°ë³¸</button>
        <button class="source-chip ${appSettings.quizSource==='mywords'?'active':''}" onclick="setQuizSource('mywords')">Tá»« cá»§a tÃ´i / ë‚´ ë‹¨ì–´</button>
      </div>
    </div>
    ${renderQuizStatsSection()}`;
}
function setQuizSource(s){appSettings.quizSource=s;save(SK.settings,appSettings);renderQuizMain();}

function startQuizMode(mode){
  const pool=getAllQuizWords();
  if(mode==='daily'){
    const todayQuiz=load(SK.quiz);
    if(todayQuiz&&todayQuiz.date===todayStr()&&todayQuiz.completed){showToast('ÄÃ£ hoÃ n thÃ nh hÃ´m nay!','info');return;}
  }
  if(mode==='wrong'){
    const wids=Object.keys(wrongWords);
    if(wids.length===0){showToast('KhÃ´ng cÃ³ tá»« sai!','info');return;}
    const wpool=[];
    wids.forEach(wid=>{
      const bIdx=BUILTIN_WORDS.findIndex(bw=>'b_'+BUILTIN_WORDS.indexOf(bw)===wid);
      if(bIdx>-1)wpool.push(getBuiltinObj(BUILTIN_WORDS[bIdx]));
      const uw=words.find(w=>String(w.id)===wid);if(uw)wpool.push(uw);
    });
    if(wpool.length<4){
      // Pad with random words
      const needed=4-wpool.length;
      const extra=pool.filter(p=>!wpool.find(w=>(w.id||w.vietnamese)===p.id)).sort(()=>Math.random()-.5).slice(0,needed);
      wpool.push(...extra);
    }
    const selected=wpool.sort(()=>Math.random()-.5).slice(0,Math.min(10,wpool.length));
    quizState=makeQuizState(selected,mode);renderQuizQuestion();return;
  }
  let selected=[];
  const easyW=pool.filter(w=>(w.difficulty||'easy')==='easy');
  const normW=pool.filter(w=>(w.difficulty||'easy')==='normal');
  const hardW=pool.filter(w=>(w.difficulty||'easy')==='hard');
  const totalQ=mode==='daily'?10:Math.min(10,pool.length);
  // Pick with difficulty ratio
  const eN=Math.round(totalQ*0.5),nN=Math.round(totalQ*0.3),hN=totalQ-eN-nN;
  function pick(arr,n){return[...arr].filter(w=>!recentQuizIds.includes(w.id||w.vietnamese)).sort(()=>Math.random()-.5).slice(0,n);}
  selected.push(...pick(easyW,Math.min(eN,easyW.length)));
  selected.push(...pick(normW,Math.min(nN,normW.length)));
  selected.push(...pick(hardW,Math.min(hN,hardW.length)));
  while(selected.length<totalQ){const rem=pool.filter(w=>!selected.find(s=>(s.id||s.vietnamese)===(w.id||w.vietnamese)));if(!rem.length)break;selected.push(rem[Math.floor(Math.random()*rem.length)]);}
  selected=selected.slice(0,totalQ).sort(()=>Math.random()-.5);
  // Update recent IDs
  recentQuizIds.push(...selected.map(w=>w.id||w.vietnamese));if(recentQuizIds.length>20)recentQuizIds=recentQuizIds.slice(-20);
  quizState=makeQuizState(selected,mode);renderQuizQuestion();
}

function makeQuizState(selected,mode){
  const pool=getAllQuizWords();
  const questions=selected.map(w=>{
    // Vietnamese shown â†’ answer in Korean (primary direction for Vietnamese users)
    const correct=w.korean;const prompt=w.vietnamese;
    const others=pool.filter(x=>(x.id||x.vietnamese)!==(w.id||w.vietnamese)&&x.korean!==w.korean).sort(()=>Math.random()-.5).slice(0,3);
    const wrongs=others.map(x=>x.korean);
    const options=[...wrongs,correct].sort(()=>Math.random()-.5);
    return{wordId:w.id||w.vietnamese,prompt,correct,options,pronunciation:w.pronunciation||'',diff:w.difficulty||'easy',answered:false,userAnswer:null,vietnamese:w.vietnamese,korean:w.korean};
  });
  return{questions,current:0,score:0,total:questions.length,completed:false,mode,date:todayStr()};
}

function renderQuizQuestion(){
  const c=document.getElementById('quiz-main');if(!quizState)return;
  const q=quizState.questions[quizState.current];
  if(!q){
    quizState.completed=true;
    if(quizState.mode==='daily'){save(SK.quiz,{date:todayStr(),score:quizState.score,total:quizState.total,completed:true});}
    updateQuizStats(quizState);
    renderQuizResult();return;
  }
  const diff=DIFFICULTIES[q.diff]||DIFFICULTIES.easy;
  c.innerHTML=`<div class="card quiz-question-card">
    <div class="quiz-progress">CÃ¢u ${quizState.current+1} / ${quizState.total} <span class="diff-badge diff-${q.diff}">${diff.vi}</span></div>
    <div class="progress-bar" style="margin-bottom:16px;"><div class="progress-fill" style="width:${(quizState.current/quizState.total)*100}%;background:var(--secondary);"></div></div>
    <div style="font-size:12px;color:var(--text-secondary);">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t â†’ ğŸ‡°ğŸ‡· Tiáº¿ng HÃ n</div>
    <div class="quiz-word">${esc(q.prompt)}</div>
    <div class="quiz-prompt">NghÄ©a tiáº¿ng HÃ n lÃ  gÃ¬? / í•œêµ­ì–´ ëœ»ì€?</div>
    <div class="quiz-options">
      ${q.options.map((opt,i)=>`<button class="quiz-option ${q.answered?(opt===q.correct?'correct':(opt===q.userAnswer&&opt!==q.correct?'wrong':'')):''}${q.answered?' disabled':''}" onclick="answerQuiz(${i})">${esc(opt)}</button>`).join('')}
    </div>
    ${q.answered?`<div style="margin-top:16px;">
      <p style="font-size:15px;font-weight:700;color:${q.userAnswer===q.correct?'var(--accent)':'var(--danger)'};">${q.userAnswer===q.correct?'âœ… ÄÃºng rá»“i! / ì •ë‹µ!':'âŒ Sai rá»“i! / ì˜¤ë‹µ!'}</p>
      ${q.userAnswer!==q.correct?`<p style="font-size:13px;color:var(--text-secondary);margin-top:4px;">ÄÃ¡p Ã¡n: ${esc(q.correct)}</p>`:''}
      ${q.pronunciation?`<p style="font-size:12px;color:var(--text-secondary);margin-top:4px;">ğŸ—£ï¸ ${esc(q.pronunciation)}</p>`:''}
      <button class="btn btn-primary" onclick="nextQuizQuestion()" style="margin-top:12px;">${quizState.current<quizState.total-1?'Tiáº¿p theo â†’ / ë‹¤ìŒ â†’':'Káº¿t quáº£ ğŸ† / ê²°ê³¼'}</button>
    </div>`:''}
  </div>`;
}

function answerQuiz(idx){
  if(!quizState)return;const q=quizState.questions[quizState.current];
  if(q.answered)return;q.answered=true;q.userAnswer=q.options[idx];
  if(q.userAnswer===q.correct){
    quizState.score++;
    learnedWords[q.wordId]=true;save(SK.learned,learnedWords);
    // Remove from wrong words if present
    if(wrongWords[q.wordId]){delete wrongWords[q.wordId];save(SK.wrongWords,wrongWords);}
  }else{
    // Add to wrong words
    wrongWords[q.wordId]=(wrongWords[q.wordId]||0)+1;save(SK.wrongWords,wrongWords);
  }
  if(appSettings.autoplay&&q.userAnswer===q.correct)speak(q.correct,'ko-KR');
  renderQuizQuestion();
}
function nextQuizQuestion(){if(!quizState)return;quizState.current++;renderQuizQuestion();}

function renderQuizResult(){
  const c=document.getElementById('quiz-main');if(!quizState)return;
  const wrongs=quizState.questions.filter(q=>q.userAnswer!==q.correct);
  c.innerHTML=`<div class="card" style="text-align:center;padding:24px;">
    <span style="font-size:48px;display:block;margin-bottom:12px;">${quizState.score===quizState.total?'ğŸ‰':'ğŸ†'}</span>
    <h3>${quizState.mode==='daily'?'CÃ¢u Ä‘á»‘ hÃ´m nay / ì˜¤ëŠ˜ í€´ì¦ˆ':'Káº¿t quáº£ / ê²°ê³¼'}</h3>
    <div class="quiz-score">${quizState.score} / ${quizState.total}</div>
    <p style="color:var(--text-secondary);font-size:14px;">${Math.round((quizState.score/quizState.total)*100)}% chÃ­nh xÃ¡c / ì •ë‹µë¥ </p>
    ${wrongs.length>0?`
      <div style="text-align:left;margin-top:16px;">
        <div style="font-size:14px;font-weight:700;margin-bottom:8px;">âŒ Tá»« sai / í‹€ë¦° ë‹¨ì–´ (${wrongs.length})</div>
        ${wrongs.map(q=>`<div class="wrong-word-item"><div class="wrong-word-info"><div style="font-weight:600;">${esc(q.prompt)}</div><div style="font-size:13px;color:var(--text-secondary);">â†’ ${esc(q.correct)}</div></div><span class="wrong-word-count">Ã—${wrongWords[q.wordId]||1}</span></div>`).join('')}
        <button class="btn btn-full btn-outline" onclick="addWrongsToMyWords()" style="margin-top:8px;">â­ ThÃªm tá»« sai vÃ o tá»« vá»±ng / í‹€ë¦° ë‹¨ì–´ ì¶”ê°€</button>
      </div>`:''}
    <button class="btn btn-primary btn-full" onclick="quizState=null;renderQuizMain();" style="margin-top:16px;">Quay láº¡i / ëŒì•„ê°€ê¸°</button>
  </div>`;
}

function addWrongsToMyWords(){
  if(!quizState)return;
  const wrongs=quizState.questions.filter(q=>q.userAnswer!==q.correct);
  let added=0;
  wrongs.forEach(q=>{
    if(words.some(w=>w.vietnamese.toLowerCase()===q.vietnamese.toLowerCase()&&w.korean===q.korean))return;
    words.unshift({id:Date.now()+added,vietnamese:q.vietnamese,korean:q.korean,pronunciation:q.pronunciation||'',example:'',category:'greeting',difficulty:q.diff||'easy',learned:false,learnedDate:null,addedDate:todayStr(),quizInclude:true});
    added++;
  });
  if(added>0){save(SK.words,words);showToast(`ÄÃ£ thÃªm ${added} tá»«! / ${added}ê°œ ì¶”ê°€!`,'success');}
  else showToast('Táº¥t cáº£ Ä‘Ã£ cÃ³ trong tá»« vá»±ng!','info');
}

function updateQuizStats(qs){
  const today=todayStr();
  quizStats.total+=qs.total;quizStats.correct+=qs.score;
  if(qs.score===qs.total){quizStats.streak++;quizStats.best=Math.max(quizStats.best,quizStats.streak);}else quizStats.streak=0;
  if(!quizStats.daily)quizStats.daily={};if(!quizStats.daily[today])quizStats.daily[today]={c:0,t:0};
  quizStats.daily[today].c+=qs.score;quizStats.daily[today].t+=qs.total;
  const wk=getWeekKey(today);if(!quizStats.weekly)quizStats.weekly={};if(!quizStats.weekly[wk])quizStats.weekly[wk]={c:0,t:0};
  quizStats.weekly[wk].c+=qs.score;quizStats.weekly[wk].t+=qs.total;
  const mk=getMonthKey(today);if(!quizStats.monthly)quizStats.monthly={};if(!quizStats.monthly[mk])quizStats.monthly[mk]={c:0,t:0};
  quizStats.monthly[mk].c+=qs.score;quizStats.monthly[mk].t+=qs.total;
  save(SK.quizStats,quizStats);
}

function renderQuizStatsSection(){
  const s=quizStats;const accuracy=s.total>0?Math.round((s.correct/s.total)*100):0;
  const today=todayStr();const wk=getWeekKey(today);const mk=getMonthKey(today);
  const ds=s.daily?.[today]||{c:0,t:0};const ws=s.weekly?.[wk]||{c:0,t:0};const ms=s.monthly?.[mk]||{c:0,t:0};
  const dAcc=ds.t>0?Math.round((ds.c/ds.t)*100):0;
  const wAcc=ws.t>0?Math.round((ws.c/ws.t)*100):0;
  const mAcc=ms.t>0?Math.round((ms.c/ms.t)*100):0;
  const wrongCount=Object.keys(wrongWords).length;
  const learnedCount=Object.keys(learnedWords).length;
  const totalWords=BUILTIN_WORDS.length+words.length;

  // Category progress
  let catProgress='';
  CAT_KEYS.forEach(k=>{
    const v=WORD_CATS[k];
    const catWords=BUILTIN_WORDS.filter(bw=>CAT_KEYS[bw[3]]===k).length+words.filter(w=>(w.category||'greeting')===k).length;
    const catLearned=BUILTIN_WORDS.filter(bw=>CAT_KEYS[bw[3]]===k&&learnedWords['b_'+BUILTIN_WORDS.indexOf(bw)]).length;
    const pct=catWords>0?Math.round((catLearned/catWords)*100):0;
    catProgress+=`<div class="stat-bar-group"><div class="stat-bar-label"><span>${v.icon} ${v.vi}</span><span>${pct}% (${catLearned}/${catWords})</span></div><div class="stat-bar"><div class="stat-bar-fill" style="width:${pct}%;background:${DIFFICULTIES.easy.color}"></div></div></div>`;
  });

  // Difficulty accuracy
  let diffStats='';
  DIFF_KEYS.forEach(d=>{
    const di=DIFFICULTIES[d];
    diffStats+=`<div class="stat-bar-group"><div class="stat-bar-label"><span class="diff-badge diff-${d}">${di.vi}</span><span>-</span></div></div>`;
  });

  // Wrong words list
  let wrongList='';
  if(wrongCount>0){
    const wrongEntries=Object.entries(wrongWords).slice(0,20);
    wrongList=`<div class="stat-section-title">âŒ Tá»« sai / í‹€ë¦° ë‹¨ì–´ (${wrongCount})</div>`;
    wrongEntries.forEach(([wid,count])=>{
      let vi='',ko='';
      const bw=BUILTIN_WORDS.find(b=>'b_'+BUILTIN_WORDS.indexOf(b)===wid);
      if(bw){vi=bw[0];ko=bw[1];}
      const uw=words.find(w=>String(w.id)===wid);
      if(uw){vi=uw.vietnamese;ko=uw.korean;}
      if(vi)wrongList+=`<div class="wrong-word-item"><div class="wrong-word-info"><div style="font-weight:600;">${esc(vi)}</div><div style="font-size:13px;color:var(--text-secondary);">${esc(ko)}</div></div><span class="wrong-word-count">Ã—${count}</span></div>`;
    });
  }

  return `
    <div class="card" style="margin-top:12px;">
      <h3 style="margin-bottom:12px;">ğŸ“Š Thá»‘ng kÃª / í†µê³„</h3>
      <div class="stat-card"><div><div class="stat-label">ğŸ“š Tá»•ng tá»« / ì „ì²´ ë‹¨ì–´</div></div><div class="stat-value">${totalWords}</div></div>
      <div class="stat-card"><div><div class="stat-label">âœ… ÄÃ£ há»c / í•™ìŠµ ì™„ë£Œ</div></div><div class="stat-value" style="color:var(--accent);">${learnedCount}</div></div>
      <div class="stat-card"><div><div class="stat-label">ğŸ”¥ LiÃªn tiáº¿p / ì—°ì† ì •ë‹µ</div></div><div class="stat-value" style="color:var(--danger);">${s.streak}</div></div>
      <div class="stat-card"><div><div class="stat-label">ğŸ† Ká»· lá»¥c / ìµœê³  ê¸°ë¡</div></div><div class="stat-value" style="color:var(--secondary);">${s.best}</div></div>
      <div class="stat-section-title">ğŸ“Š Tá»· lá»‡ Ä‘Ãºng / ì •ë‹µë¥ </div>
      <div class="stat-card"><div><div class="stat-label">HÃ´m nay / ì˜¤ëŠ˜</div></div><div class="stat-value">${dAcc}%</div></div>
      <div class="stat-card"><div><div class="stat-label">Tuáº§n nÃ y / ì´ë²ˆ ì£¼</div></div><div class="stat-value">${wAcc}%</div></div>
      <div class="stat-card"><div><div class="stat-label">ThÃ¡ng nÃ y / ì´ë²ˆ ë‹¬</div></div><div class="stat-value">${mAcc}%</div></div>
      <div class="stat-card"><div><div class="stat-label">Tá»•ng / ì „ì²´</div></div><div class="stat-value">${accuracy}% (${s.correct}/${s.total})</div></div>
      <div class="stat-section-title">ğŸ“‚ Tiáº¿n Ä‘á»™ theo danh má»¥c / ì¹´í…Œê³ ë¦¬ë³„</div>
      ${catProgress}
      ${wrongList}
    </div>`;
}

// ==================== EXPENSES ====================
function selectPayment(type){selectedPayment=type;document.getElementById('pay-cash').classList.toggle('selected',type==='cash');document.getElementById('pay-card').classList.toggle('selected',type==='card');}
function showVndPreview(){const v=parseInt(document.getElementById('exp-amount').value)||0;document.getElementById('vnd-preview').textContent=v>0?`â‰ˆ ${fmt(toVnd(v))}â‚«`:'';}
function addExpense(){
  const amount=parseInt(document.getElementById('exp-amount').value),memo=document.getElementById('exp-memo').value.trim(),date=document.getElementById('exp-date').value;
  if(!amount||amount<=0){showToast('Nháº­p sá»‘ tiá»n!','error');return;}if(!date){showToast('Chá»n ngÃ y!','error');return;}
  expenses.unshift({id:Date.now(),amount,payment:selectedPayment,category:selectedExpCat,memo,date});
  save(SK.expenses,expenses);document.getElementById('exp-amount').value='';document.getElementById('exp-memo').value='';document.getElementById('vnd-preview').textContent='';
  showToast('ÄÃ£ lÆ°u!','success');renderCalendar();renderStats();renderExpenseList();renderBudgetAlert();
}
function deleteExpense(id){if(!confirm('XÃ³a chi tiÃªu nÃ y?'))return;expenses=expenses.filter(e=>e.id!==id);save(SK.expenses,expenses);renderCalendar();renderStats();renderExpenseList();renderBudgetAlert();showToast('ÄÃ£ xÃ³a!','success');}
function openExpenseEditModal(id){const e=expenses.find(x=>x.id===id);if(!e)return;document.getElementById('edit-exp-amount').value=e.amount;document.getElementById('edit-exp-memo').value=e.memo;document.getElementById('edit-exp-date').value=e.date;document.getElementById('edit-exp-cat').value=e.category;document.getElementById('edit-exp-id').value=e.id;selectEditPayment(e.payment);document.getElementById('expense-edit-modal').classList.add('show');}
function closeExpenseEditModal(){document.getElementById('expense-edit-modal').classList.remove('show');}
function selectEditPayment(type){editPayment=type;document.getElementById('edit-pay-cash').classList.toggle('selected',type==='cash');document.getElementById('edit-pay-card').classList.toggle('selected',type==='card');}
function saveEditExpense(){const id=Number(document.getElementById('edit-exp-id').value);const idx=expenses.findIndex(e=>e.id===id);if(idx<0)return;expenses[idx].amount=parseInt(document.getElementById('edit-exp-amount').value)||0;expenses[idx].payment=editPayment;expenses[idx].category=document.getElementById('edit-exp-cat').value;expenses[idx].memo=document.getElementById('edit-exp-memo').value.trim();expenses[idx].date=document.getElementById('edit-exp-date').value;save(SK.expenses,expenses);closeExpenseEditModal();renderCalendar();renderStats();renderExpenseList();closeDayModal();showToast('ÄÃ£ sá»­a!','success');}

// ==================== CALENDAR ====================
function changeMonth(d){calMonth+=d;if(calMonth<0){calMonth=11;calYear--;}if(calMonth>11){calMonth=0;calYear++;}renderCalendar();}
function renderCalendar(){
  const label=document.getElementById('cal-month-label'),grid=document.getElementById('calendar-grid');
  const mn=['ThÃ¡ng 1','ThÃ¡ng 2','ThÃ¡ng 3','ThÃ¡ng 4','ThÃ¡ng 5','ThÃ¡ng 6','ThÃ¡ng 7','ThÃ¡ng 8','ThÃ¡ng 9','ThÃ¡ng 10','ThÃ¡ng 11','ThÃ¡ng 12'];
  label.textContent=`${calYear} ${mn[calMonth]}`;
  const dh=['CN','T2','T3','T4','T5','T6','T7'];
  let html=dh.map(d=>`<div class="cal-header">${d}</div>`).join('');
  const fd=new Date(calYear,calMonth,1).getDay(),dim=new Date(calYear,calMonth+1,0).getDate(),pd=new Date(calYear,calMonth,0).getDate();
  const dt={};expenses.forEach(e=>{const[ey,em]=e.date.split('-').map(Number);if(ey===calYear&&em===calMonth+1){const d=parseInt(e.date.split('-')[2]);dt[d]=(dt[d]||0)+e.amount;}});
  const td=new Date(),itm=td.getFullYear()===calYear&&td.getMonth()===calMonth;
  for(let i=0;i<fd;i++)html+=`<div class="cal-day other-month">${pd-fd+1+i}</div>`;
  for(let d=1;d<=dim;d++){const it=itm&&d===td.getDate();const ds=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;const t=dt[d];html+=`<div class="cal-day ${it?'today':''}" onclick="showDayDetail('${ds}')">${d}${t?`<div class="cal-amount">${t>=1e6?(t/1e6).toFixed(1)+'M':t>=1e3?Math.round(t/1e3)+'K':t}</div>`:''}</div>`;}
  const rem=7-((fd+dim)%7);if(rem<7)for(let i=1;i<=rem;i++)html+=`<div class="cal-day other-month">${i}</div>`;
  grid.innerHTML=html;
}
function showDayDetail(dateStr){
  const de=expenses.filter(e=>e.date===dateStr);const modal=document.getElementById('day-modal');
  const parts=dateStr.split('-');document.getElementById('day-modal-title').textContent=`ğŸ“… ${parts[1]}/${parts[2]}`;
  const content=document.getElementById('day-modal-content');
  if(de.length===0)content.innerHTML='<div class="empty-state"><span class="emoji">ğŸ’¸</span><p>KhÃ´ng cÃ³ chi tiÃªu</p></div>';
  else{const total=de.reduce((s,e)=>s+e.amount,0);content.innerHTML=`<div style="text-align:center;margin-bottom:12px;"><span style="font-size:22px;font-weight:700;color:var(--primary);">${dualCurrency(total)}</span></div>${de.map(e=>`<div class="expense-item"><div class="expense-item-icon">${EXP_CATS[e.category]?.icon||'ğŸ“¦'}</div><div class="expense-item-info"><div class="expense-item-cat">${EXP_CATS[e.category]?.vi||'KhÃ¡c'}</div><div class="expense-item-memo">${esc(e.memo)||'-'}</div></div><div><div class="expense-item-amount">${fmt(e.amount)}â‚©</div><div class="expense-item-sub">${fmt(toVnd(e.amount))}â‚« | ${e.payment==='cash'?'ğŸ’µ':'ğŸ’³'}</div></div><div class="expense-item-actions"><button class="icon-btn" onclick="openExpenseEditModal(${e.id})">âœï¸</button><button class="icon-btn" onclick="deleteExpense(${e.id});closeDayModal();">ğŸ—‘ï¸</button></div></div>`).join('')}`;}
  modal.classList.add('show');
}
function closeDayModal(){document.getElementById('day-modal').classList.remove('show');}

// ==================== STATS ====================
function renderStats(){
  const c=document.getElementById('stats-container');const today=todayStr();
  const mk=calYear+'-'+String(calMonth+1).padStart(2,'0');
  const me=expenses.filter(e=>e.date.startsWith(mk));const te=expenses.filter(e=>e.date===today);
  const tt=te.reduce((s,e)=>s+e.amount,0),mt=me.reduce((s,e)=>s+e.amount,0);
  const ct=me.filter(e=>e.payment==='cash').reduce((s,e)=>s+e.amount,0);
  const cdt=me.filter(e=>e.payment==='card').reduce((s,e)=>s+e.amount,0);
  const catT={};me.forEach(e=>{catT[e.category]=(catT[e.category]||0)+e.amount;});const maxC=Math.max(...Object.values(catT),1);
  const budget=load(SK.budget);const colors={food:'#e8836d',transport:'#42a5f5',shopping:'#ab47bc',living:'#66bb6a',cafe:'#8d6e63',health:'#26a69a',other:'#ffa726'};
  const mn=['ThÃ¡ng 1','ThÃ¡ng 2','ThÃ¡ng 3','ThÃ¡ng 4','ThÃ¡ng 5','ThÃ¡ng 6','ThÃ¡ng 7','ThÃ¡ng 8','ThÃ¡ng 9','ThÃ¡ng 10','ThÃ¡ng 11','ThÃ¡ng 12'];
  let budgetHtml='';
  if(budget&&budget.amount){const pct=Math.round((mt/budget.amount)*100);budgetHtml=`<div class="stat-section-title">ğŸ’° NgÃ¢n sÃ¡ch</div><div class="stat-card"><div><div class="stat-label">NgÃ¢n sÃ¡ch thÃ¡ng</div></div><div class="stat-value">${dualCurrency(budget.amount)}</div></div><div style="padding:0 4px;"><div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;"><span>ÄÃ£ dÃ¹ng: ${fmt(mt)}â‚©</span><span>${pct}%</span></div><div class="budget-bar"><div class="budget-fill ${pct>100?'over':''}" style="width:${Math.min(pct,100)}%"></div></div><div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">CÃ²n láº¡i: ${dualCurrency(Math.max(budget.amount-mt,0))}</div></div>`;}
  c.innerHTML=`
    <div class="stat-card"><div><div class="stat-label">ğŸ“… HÃ´m nay / ì˜¤ëŠ˜</div></div><div><div class="stat-value" style="color:var(--primary);">${fmt(tt)}â‚©</div><div class="stat-sub">${fmt(toVnd(tt))}â‚«</div></div></div>
    <div class="stat-card"><div><div class="stat-label">ğŸ“Š ${mn[calMonth]}</div></div><div><div class="stat-value">${fmt(mt)}â‚©</div><div class="stat-sub">${fmt(toVnd(mt))}â‚«</div></div></div>
    <div class="stat-card"><div><div class="stat-label">ğŸ’µ Tiá»n máº·t / í˜„ê¸ˆ</div></div><div><div class="stat-value" style="color:#66bb6a;">${fmt(ct)}â‚©</div></div></div>
    <div class="stat-card"><div><div class="stat-label">ğŸ’³ Tháº» / ì¹´ë“œ</div></div><div><div class="stat-value" style="color:#42a5f5;">${fmt(cdt)}â‚©</div></div></div>
    ${budgetHtml}
    <div class="stat-section-title">ğŸ“‚ Theo danh má»¥c / ì¹´í…Œê³ ë¦¬ë³„</div>
    ${Object.entries(catT).sort((a,b)=>b[1]-a[1]).map(([cat,total])=>{const cc=EXP_CATS[cat]||EXP_CATS.other;return `<div class="stat-bar-group"><div class="stat-bar-label"><span>${cc.icon} ${cc.vi}</span><span>${dualCurrency(total)}</span></div><div class="stat-bar"><div class="stat-bar-fill" style="width:${(total/maxC)*100}%;background:${colors[cat]||'#999'}"></div></div></div>`;}).join('')}`;
}

// ==================== EXPENSE LIST ====================
function renderExpenseList(){
  const c=document.getElementById('expense-list-container');
  if(expenses.length===0){c.innerHTML='<div class="empty-state"><span class="emoji">ğŸ’°</span><p>ChÆ°a cÃ³ chi tiÃªu</p></div>';return;}
  const grouped={};expenses.forEach(e=>{if(!grouped[e.date])grouped[e.date]=[];grouped[e.date].push(e);});
  const sorted=Object.keys(grouped).sort((a,b)=>b.localeCompare(a));
  const dn=['CN','T2','T3','T4','T5','T6','T7'];
  c.innerHTML=sorted.map(date=>{const dayT=grouped[date].reduce((s,e)=>s+e.amount,0);const p=date.split('-');const d=dn[new Date(date).getDay()];return `<div class="expense-date-group"><div class="expense-date-label">${p[1]}/${p[2]} (${d}) â€” ${dualCurrency(dayT)}</div>${grouped[date].map(e=>`<div class="expense-item"><div class="expense-item-icon">${EXP_CATS[e.category]?.icon||'ğŸ“¦'}</div><div class="expense-item-info"><div class="expense-item-cat">${EXP_CATS[e.category]?.vi||'KhÃ¡c'}</div><div class="expense-item-memo">${esc(e.memo)||'-'}</div></div><div><div class="expense-item-amount">${fmt(e.amount)}â‚©</div><div class="expense-item-sub">${fmt(toVnd(e.amount))}â‚« | ${e.payment==='cash'?'ğŸ’µ':'ğŸ’³'}</div></div><div class="expense-item-actions"><button class="icon-btn" onclick="openExpenseEditModal(${e.id})">âœï¸</button><button class="icon-btn" onclick="deleteExpense(${e.id})">ğŸ—‘ï¸</button></div></div>`).join('')}</div>`;}).join('');
}

// ==================== SETTINGS / BACKUP ====================
function backupData(){
  const data={version:3,date:todayStr(),words,expenses,quizStats,wrongWords,learnedWords,budget:load(SK.budget),rate:load(SK.rate),settings:appSettings};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`uridul-backup-${todayStr()}.json`;a.click();showToast('ÄÃ£ sao lÆ°u!','success');
}
function restoreData(event){
  const file=event.target.files[0];if(!file)return;
  if(!confirm('KhÃ´i phá»¥c sáº½ ghi Ä‘Ã¨ dá»¯ liá»‡u hiá»‡n táº¡i. Tiáº¿p tá»¥c?\në³µì›í•˜ë©´ í˜„ì¬ ë°ì´í„°ê°€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤. ê³„ì†?'))return;
  const reader=new FileReader();
  reader.onload=function(e){
    try{const data=JSON.parse(e.target.result);
      if(data.words)save(SK.words,data.words);if(data.expenses)save(SK.expenses,data.expenses);
      if(data.quizStats)save(SK.quizStats,data.quizStats);if(data.wrongWords)save(SK.wrongWords,data.wrongWords);
      if(data.learnedWords)save(SK.learned,data.learnedWords);if(data.budget)save(SK.budget,data.budget);
      if(data.rate)save(SK.rate,data.rate);if(data.settings)save(SK.settings,data.settings);
      showToast('ÄÃ£ khÃ´i phá»¥c! Äang táº£i láº¡i...','success');setTimeout(()=>location.reload(),1000);
    }catch{showToast('KhÃ´ng thá»ƒ Ä‘á»c file','error');}
  };reader.readAsText(file);event.target.value='';
}
function deleteAllData(){
  if(!confirm('XÃ³a táº¥t cáº£ dá»¯ liá»‡u?\nì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?'))return;
  if(!confirm('KhÃ´ng thá»ƒ hoÃ n tÃ¡c!\në˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!'))return;
  Object.values(SK).forEach(k=>localStorage.removeItem(k));localStorage.removeItem('uridul_practice');
  showToast('ÄÃ£ xÃ³a táº¥t cáº£!','success');setTimeout(()=>location.reload(),1000);
}

// ==================== MODALS ====================
function closeModal(id){document.getElementById(id).classList.remove('show');}
document.querySelectorAll('.modal-overlay').forEach(m=>{m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('show');});});

// ==================== SWIPE ====================
let touchSX=0;
document.addEventListener('touchstart',e=>{touchSX=e.changedTouches[0].screenX;},{passive:true});
document.addEventListener('touchend',e=>{
  const diff=touchSX-e.changedTouches[0].screenX;if(Math.abs(diff)<80)return;
  const tabs=['tab-dictionary','tab-quiz','tab-expenses','tab-settings'];
  const ci=tabs.findIndex(t=>document.getElementById(t).classList.contains('active'));
  if(diff>0&&ci<tabs.length-1)switchTab(document.querySelector(`[data-tab="${tabs[ci+1]}"]`));
  else if(diff<0&&ci>0)switchTab(document.querySelector(`[data-tab="${tabs[ci-1]}"]`));
},{passive:true});

// ==================== OFFLINE ====================
function updateOnlineStatus(){document.getElementById('offline-banner').classList.toggle('show',!navigator.onLine);}
window.addEventListener('online',()=>{updateOnlineStatus();showToast('ÄÃ£ káº¿t ná»‘i láº¡i!','success');});
window.addEventListener('offline',()=>{updateOnlineStatus();showToast('Máº¥t káº¿t ná»‘i máº¡ng','error');});

// ==================== TUTORIAL ====================
function showTutorial(){
  const steps=[
    {emoji:'ğŸ‡»ğŸ‡³ğŸ‡°ğŸ‡·',title:'ChÃ o má»«ng! / í™˜ì˜í•©ë‹ˆë‹¤!',desc:'á»¨ng dá»¥ng há»c tiáº¿ng HÃ n cho ngÆ°á»i Viá»‡t<br>ë² íŠ¸ë‚¨ì¸ì„ ìœ„í•œ í•œêµ­ì–´ í•™ìŠµ ì•±'},
    {emoji:'ğŸ“š',title:'500 tá»« cÆ¡ báº£n / ê¸°ë³¸ 500ë‹¨ì–´',desc:'TOPIK cáº¥p 1-2 tá»« vá»±ng cÃ³ sáºµn<br>TOPIK ì´ˆê¸‰ ì–´íœ˜ ë‚´ì¥'},
    {emoji:'ğŸ¯',title:'CÃ¢u Ä‘á»‘ / í€´ì¦ˆ',desc:'Luyá»‡n táº­p má»—i ngÃ y vá»›i 3 cháº¿ Ä‘á»™<br>3ê°€ì§€ ëª¨ë“œë¡œ ë§¤ì¼ ì—°ìŠµ'},
    {emoji:'ğŸ’°',title:'Quáº£n lÃ½ chi phÃ­ / ìƒí™œë¹„ ê´€ë¦¬',desc:'Theo dÃµi chi tiÃªu KRW â†” VND<br>ì›í™” â†” ë™ í™˜ì‚° ì§€ì¶œ ê´€ë¦¬'},
  ];
  let current=0;
  const overlay=document.getElementById('tutorial-overlay');
  overlay.style.display='flex';
  function renderStep(){
    const s=steps[current];
    document.getElementById('tutorial-content').innerHTML=`
      <div class="tutorial-step">${current+1} / ${steps.length}</div>
      <div style="font-size:48px;margin-bottom:12px;">${s.emoji}</div>
      <h2>${s.title}</h2>
      <p>${s.desc}</p>
      <div style="display:flex;gap:8px;margin-top:20px;justify-content:center;">
        ${current>0?`<button class="btn btn-secondary" onclick="tutorialPrev()">â† TrÆ°á»›c</button>`:''}
        ${current<steps.length-1?`<button class="btn btn-primary" onclick="tutorialNext()">Tiáº¿p â†’</button>`:`<button class="btn btn-primary" onclick="closeTutorial()">Báº¯t Ä‘áº§u! ğŸš€</button>`}
      </div>
      <button style="background:none;border:none;color:var(--text-secondary);margin-top:12px;font-size:12px;cursor:pointer;" onclick="closeTutorial()">Bá» qua / ê±´ë„ˆë›°ê¸°</button>`;
  }
  window.tutorialNext=()=>{current++;renderStep();};
  window.tutorialPrev=()=>{current--;renderStep();};
  window.closeTutorial=()=>{overlay.style.display='none';save(SK.tutorial,{seen:true});};
  renderStep();
}

// ==================== EXCEL IMPORT ====================
function importExcel(event){
  const file=event.target.files[0];if(!file)return;
  if(typeof XLSX==='undefined'){showToast('Excel ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤','error');return;}
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const data=new Uint8Array(e.target.result);
      const workbook=XLSX.read(data,{type:'array'});
      const sheet=workbook.Sheets[workbook.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(sheet,{header:1});
      let success=0,dup=0,fail=0;
      for(let i=0;i<rows.length;i++){
        const row=rows[i];
        if(!row||row.length<2)continue;
        const vi=String(row[0]||'').trim();
        const ko=String(row[1]||'').trim();
        if(!vi||!ko){fail++;continue;}
        if(i===0&&(vi.toLowerCase().includes('vietnam')||vi.includes('ë² íŠ¸ë‚¨')||vi.toLowerCase().includes('tiáº¿ng')||vi.toLowerCase().includes('viet')))continue;
        if(words.some(w=>w.vietnamese.toLowerCase()===vi.toLowerCase()&&w.korean===ko)){dup++;continue;}
        words.unshift({id:Date.now()+i,vietnamese:vi,korean:ko,pronunciation:'',example:'',category:'greeting',difficulty:'easy',learned:false,learnedDate:null,addedDate:todayStr(),quizInclude:true});
        success++;
      }
      save(SK.words,words);renderMyWords();
      showToast(`ì„±ê³µ ${success}ê°œ, ì¤‘ë³µ ${dup}ê°œ, ì‹¤íŒ¨ ${fail}ê°œ`,'success');
    }catch(err){showToast('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤','error');}
  };
  reader.readAsArrayBuffer(file);event.target.value='';
}

// ==================== SHARING / FIREBASE ====================
function getShareConfig(){try{return JSON.parse(localStorage.getItem('uridul_share_config'))||{enabled:false,familyCode:'',firebaseUrl:''};}catch{return{enabled:false,familyCode:'',firebaseUrl:''};}}
function saveShareConfig(cfg){localStorage.setItem('uridul_share_config',JSON.stringify(cfg));}

function toggleSharing(){
  const cfg=getShareConfig();
  if(!cfg.enabled){
    document.getElementById('share-config').style.display='block';
    document.getElementById('family-code').value=cfg.familyCode||'';
    document.getElementById('firebase-url').value=cfg.firebaseUrl||'';
  }else{disconnectSharing();}
}

function connectSharing(){
  const code=document.getElementById('family-code').value.trim();
  const url=document.getElementById('firebase-url').value.trim();
  if(!code){showToast('ê°€ì¡± ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”!','error');return;}
  if(!url){showToast('Firebase URLì„ ì…ë ¥í•˜ì„¸ìš”!','error');return;}
  try{
    if(!firebase.apps.length)firebase.initializeApp({databaseURL:url});
    window.storage._fb=firebase.database();
    window.storage._familyCode=code;
    const cfg={enabled:true,familyCode:code,firebaseUrl:url};
    saveShareConfig(cfg);
    setupFirebaseListeners(code);
    uploadAllData(code);
    document.getElementById('share-toggle').classList.add('on');
    document.getElementById('share-status').textContent='ÄÃ£ káº¿t ná»‘i / ì—°ê²°ë¨ âœ…';
    document.getElementById('share-config').style.display='none';
    showToast('ê³µìœ  ì—°ê²° ì™„ë£Œ!','success');
  }catch(err){showToast('ì—°ê²° ì‹¤íŒ¨: '+err.message,'error');}
}

function disconnectSharing(){
  if(window.storage._fb&&window.storage._familyCode){
    Object.values(window.storage._listeners).forEach(function(unsub){if(typeof unsub==='function')unsub();});
    window.storage._listeners={};
  }
  window.storage._fb=null;window.storage._familyCode=null;
  saveShareConfig({enabled:false,familyCode:'',firebaseUrl:''});
  document.getElementById('share-toggle').classList.remove('on');
  document.getElementById('share-status').textContent='ChÆ°a káº¿t ná»‘i / ë¯¸ì—°ê²°';
  document.getElementById('share-config').style.display='none';
  showToast('ê³µìœ  í•´ì œë¨','info');
}

function uploadAllData(code){
  if(!window.storage._fb)return;
  const db=window.storage._fb;
  const sharedKeys=[SK.words,SK.expenses,SK.quizStats,SK.wrongWords,SK.learned,SK.budget,SK.rate,SK.settings];
  db.ref(code).once('value').then(function(snapshot){
    const remoteData=snapshot.val();
    if(remoteData&&Object.keys(remoteData).length>0){
      sharedKeys.forEach(function(key){
        if(remoteData[key]!==undefined){
          localStorage.setItem(key,JSON.stringify(remoteData[key]));
          refreshFromStorage(key);
        }
      });
      showToast('ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ!','success');
    }else{
      sharedKeys.forEach(function(key){
        var d=JSON.parse(localStorage.getItem(key)||'null');
        if(d!==null)db.ref(code+'/'+key).set(d).catch(function(){});
      });
    }
  }).catch(function(){});
}

var _syncPaused=false;
function setupFirebaseListeners(code){
  if(!window.storage._fb)return;
  var db=window.storage._fb;
  var sharedKeys=[SK.words,SK.expenses,SK.quizStats,SK.wrongWords,SK.learned,SK.budget,SK.rate,SK.settings];
  sharedKeys.forEach(function(key){
    var ref=db.ref(code+'/'+key);
    var listener=ref.on('value',function(snapshot){
      if(_syncPaused)return;
      var data=snapshot.val();
      if(data!==null){
        var current=localStorage.getItem(key);
        var newData=JSON.stringify(data);
        if(current!==newData){
          localStorage.setItem(key,newData);
          refreshFromStorage(key);
        }
      }
    });
    window.storage._listeners[key]=function(){ref.off('value',listener);};
  });
}

function refreshFromStorage(key){
  _syncPaused=true;
  if(key===SK.words){words=load(SK.words)||[];renderMyWords();}
  if(key===SK.expenses){expenses=load(SK.expenses)||[];renderCalendar();renderStats();renderExpenseList();renderBudgetAlert();}
  if(key===SK.quizStats){quizStats=load(SK.quizStats)||{total:0,correct:0,streak:0,best:0,daily:{},weekly:{},monthly:{}};}
  if(key===SK.wrongWords){wrongWords=load(SK.wrongWords)||{};}
  if(key===SK.learned){learnedWords=load(SK.learned)||{};}
  if(key===SK.budget){loadBudget();}
  if(key===SK.settings){appSettings=load(SK.settings)||{autoplay:false,quizSource:'all'};}
  _syncPaused=false;
}

function initSharing(){
  var cfg=getShareConfig();
  if(cfg.enabled&&cfg.firebaseUrl&&cfg.familyCode){
    try{
      if(!firebase.apps.length)firebase.initializeApp({databaseURL:cfg.firebaseUrl});
      window.storage._fb=firebase.database();
      window.storage._familyCode=cfg.familyCode;
      setupFirebaseListeners(cfg.familyCode);
      document.getElementById('share-toggle').classList.add('on');
      document.getElementById('share-status').textContent='ÄÃ£ káº¿t ná»‘i / ì—°ê²°ë¨ âœ…';
    }catch(err){
      document.getElementById('share-status').textContent='Lá»—i káº¿t ná»‘i / ì—°ê²° ì˜¤ë¥˜';
    }
  }
}

// ==================== MIGRATE ====================
function migrateData(){words.forEach(w=>{if(!w.category)w.category='greeting';if(!w.difficulty)w.difficulty='easy';if(w.quizInclude===undefined)w.quizInclude=true;});save(SK.words,words);}

// ==================== INIT ====================
function initApp(){
  initTheme();
  const ver=localStorage.getItem(SK.version);
  if(ver&&parseInt(ver)<3)migrateData();
  localStorage.setItem(SK.version,'3');
  words=load(SK.words)||[];expenses=load(SK.expenses)||[];
  quizStats=load(SK.quizStats)||{total:0,correct:0,streak:0,best:0,daily:{},weekly:{},monthly:{}};
  wrongWords=load(SK.wrongWords)||{};learnedWords=load(SK.learned)||{};
  appSettings=load(SK.settings)||{autoplay:false,quizSource:'all'};
  const now=new Date();calYear=now.getFullYear();calMonth=now.getMonth();
  document.getElementById('exp-date').value=toDateStr(now);
  document.getElementById('autoplay-toggle')?.classList.toggle('on',appSettings.autoplay);
  loadRate();renderExpCatGrid();renderMyWords();renderWOTD();renderQuizMain();
  renderCalendar();renderStats();renderExpenseList();renderBudgetAlert();
  updateRateDisplay();loadBudget();updateOnlineStatus();renderRecentSearches();
  if(!load(SK.tutorial))setTimeout(showTutorial,500);
  if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js').catch(()=>{});
  initSharing();
}
initApp();

</script>
</body>
</html>
